define.Class("wixapps.apps.blog.ArchiveLogic",function(a){var b=a;b.inherits("wixapps.core.logics.GroupByAndCountLogic"),b.utilize(["wixapps.apps.blog.ArchivePresenter"]),b.binds(["_processResult"]),b.statics({_presenter:null}),b.methods({initialize:function(a){this.parent(a),this._presenter=new this.imports.ArchivePresenter(a.getAppInstance())},_processResult:function(){var a=this._resultsToPairs();this._presenter.updateModel(a),this._callBacks.showView(this._presenter.getModel(),this._viewName,this._presenter.getEventHandlers())},getPresenter:function(){return this._presenter},dispose:function(){this.parent(),this._presenter.dispose()}})}),define.Class("wixapps.apps.blog.ArchivePresenter",function(a){var b=a;b.binds(["_onComboBoxSelectionChanged","_scrollTop","_handleHashExtraDataChanged"]),b.utilize(["wixapps.apps.blog.BlogQueryPageLinkResolver"]),b.resources(["W.Utils","W.Viewer"]);var c={"01":"January","02":"February","03":"March","04":"April","05":"May","06":"June","07":"July","08":"August","09":"September",10:"October",11:"November",12:"December"};b.fields({_appInstance:null,_dataItemFactory:null,_model:null,_stubEntry:{_type:"Option",text:"Select Month",value:null,count:-1,selected:!1}}),b.methods({initialize:function(a){this._appInstance=a,this._dataItemFactory=a.getDataItemFactory(),this.createModel(),this.resources.W.Viewer.addEvent("hashExtraDataChanged",this._handleHashExtraDataChanged)},createModel:function(){this._model=this._dataItemFactory.createDataItem({_type:"ComboOptionsList",title:"",items:[],selectedValue:this._stubEntry})},updateModel:function(a){var b=this,c=_.map(a,function(a){return{_type:"Option",text:b._itemToText(a),value:a.key,count:a.count,selected:!1}});c.unshift(this._stubEntry),this._model.setValue({_type:"ComboOptionsList",title:"",items:c,selectedValue:c[0].value})},getModel:function(){return this._model},getEventHandlers:function(){var a=this;return{comboBoxSelectionChanged:function(b){a._onComboBoxSelectionChanged(b)},listOptionClicked:function(b){a._onListOptionClicked(b)}}},_itemToText:function(a){var b=a.key.split("-");return c[b[1]]+" "+b[0]+" ("+a.count+")"},_scrollTop:function(a){a.isForSureAfterChange&&($(document.body).scrollTo(0,0),this.resources.W.Utils.hash.removeEvent(Constants.DataItemEvents.CHANGE,this._scrollTop))},_onComboBoxSelectionChanged:function(a){var b=a.data.getChildValue("selectedValue");if(b){var c="date",d="79f391eb-7dfc-4adf-be6e-64434c4838d9",e=a.data.getChildByRef("items").getChildren(),f=_.find(e,function(a){return a.getChildValue("value")===b}),g=this;this._appInstance.getPageLinkResolverPromise(d).then(function(a){a.resolveLinkUrl(d,f,g._logicParams,c,function(a){var b=g.resources.W.Utils.hash.getHashParts(a);g.resources.W.Utils.hash.addEvent(Constants.DataItemEvents.CHANGE,g._scrollTop),g.resources.W.Utils.hash.setHash(b.id,b.title,b.extData,!1)})})}},_handleHashExtraDataChanged:function(a){var b=this._appInstance.getParentAppPage();if(b&&b.getDataItem()){var c=b.getDataItem().get("id");a.pageId===c&&a.extData&&a.extData.contains("Date")||this._clearSelected()}},_clearSelected:function(){var a=this._model.getChildByRef("items");_.forEach(a.getChildren(),function(a){a.getChildValue("selected")&&a.getChildByRef("selected").setValue(!1)})},_onListOptionClicked:function(a){this._clearSelected();var b=a.data.getValue();b.selected=!0,a.data.setValue(b)},dispose:function(){this.resources.W.Viewer.removeEvent("hashExtraDataChanged",this._handleHashExtraDataChanged)}})}),define.Class("wixapps.apps.blog.BlogMediaPostQueryTrait",function(a){var b=a;b.utilize(["wixapps.integration.utils.MediaTextDataUtils"]),b.fields({_mediaTextUtils:null}),b.methods({initialize:function(){this._mediaTextUtils=new this.imports.MediaTextDataUtils},_transformMediaItemsToBasePostTypes:function(a){return _.map(a,function(a){return this._mediaTextUtils.convertMediaPostForView(a,this._dataItemFactory)},this)},_parseResult:function(a,b,c){var d=this._transformMediaItemsToBasePostTypes(a);this._virtualArray=this._virtualArray||this._dataItemFactory.createVirtualArray(),this._virtualArray.setChildren(d),this._setTotalResultCount(c),this._onFetchDataSuccess(this._virtualArray)}})}),define.Class("wixapps.apps.blog.BlogPageConfiguration",function(a){var b=a;b.resources(["W.Editor","W.EditorDialogs","W.Resources","W.Preview","W.AppsEditor"]),b.inherits("wysiwyg.editor.utils.PageConfiguration"),b.methods({getBundledPages:function(){return this._config.bundledPages},handleDeletePage:function(a,b){var c=[a],d=this.getBundledPages();if(d){var e=this.resources.W.Preview.getPreviewManagers().Viewer.getPagesData();_.forEach(e,function(a){var b=a.get("appPageId");b&&_.contains(d,b)&&c.push(a)})}var f=W.Editor.getSiteStructure().get("pages");if(f.length===c.length)return this.resources.W.EditorDialogs.openPromptDialog(this.resources.W.Resources.get("EDITOR_LANGUAGE","DELETE_PAGE_LASTPAGE_DIALOG_TITLE"),this.resources.W.Resources.get("EDITOR_LANGUAGE","DELETE_PAGE_LASTPAGE_DIALOG_TEXT"),void 0,this.resources.W.EditorDialogs.DialogButtonSet.OK,function(){}),void 0;for(var g=[],h=null,i=0;i<c.length;i++)h=this.resources.W.Preview.getCompByID(c[i].get("id")),g.concat(_.filter(h.getLogic().getPageComponents(),function(a){return a.isTpa&&a.isPremiumApp()}));var j=this.resources.W.Resources.get("EDITOR_LANGUAGE","DELETE_PAGE_DIALOG_TITLE"),k=this.resources.W.Resources.get("EDITOR_LANGUAGE","DELETE_BLOG_PAGE_DIALOG_TEXT");g.length>0&&(k+=this.resources.W.Resources.get("EDITOR_LANGUAGE","DELETE_BLOG_PAGE_CONTAINING_TPA_COMPONENTS_TEXT"));var l=this,m=0,n=c.length;this.resources.W.EditorDialogs.openPromptDialog(j,k,void 0,this.resources.W.EditorDialogs.DialogButtonSet.DELETE_CANCEL,function(a){"DELETE"==a.result&&_.forEach(c,function(a){b(a,function(a){if(m++,n===m){var b=a.get("appInnerID");l._setApplicationActiveState(b,!1)}})})})},_setApplicationActiveState:function(a,b){var c=this.resources.W.Preview.getPreviewManagers().Apps.getApp(a);if(c.setApplicationActiveState(b),!b){var d=this.resources.W.AppsEditor.getLogger();d.reportEvent(d.Events.BLOG_REMOVED,{})}},handlePastePage:function(){this.resources.W.EditorDialogs.openPromptDialog(this.resources.W.Resources.get("EDITOR_LANGUAGE","NEW_BLOG_PAGE_ADDED_TITLE"),this.resources.W.Resources.get("EDITOR_LANGUAGE","NEW_BLOG_PAGE_ADDED_TEXT"),"",this.resources.W.EditorDialogs.DialogButtonSet.OK,function(){})}})}),define.Class("wixapps.apps.blog.BlogQueryPageLinkResolver",function(a){var b=a;b.inherits("wixapps.core.logics.page.QueryPageLinkResolver"),b.methods({uriFromParams:function(a){var b="";if(a.filter){var c=JSON.parse(a.filter);c.featured&&(b+="Featured/"),c._type&&(b+="Type/"+c._type+"/"),c.tags&&(b+="Tag/"+c.tags+"/"),c.date&&(b+="Date/"+c.date+"/")}return a.sort&&(b+="Sort/"+a.sort+"/"),a.page&&(b+="Page/"+a.page+"/"),b},_wasPageDateQueried:function(a){return a.getLogicParams().filter.contains("date.iso")},_useAlreadyExistingPageParams:function(a,b){if(this.parent(a,b),this._wasPageDateQueried(a)){var c=/"\$regex":"\^(.*)"}/,d=a.getLogicParams().filter.match(c)[1];this._addParamToFilter(b,"date",d)}},_getExtraDataParams:function(a,b,c){var d=this.parent(a,b,c);if("date"===c){var e=a.getChildValue("value");null!==e&&this._addParamToFilter(d,"date",e)}return d}})}),define.Class("wixapps.apps.blog.BlogQueryPageLogic",function(a){var b=a;b.inherits("wixapps.core.logics.page.QueryPageLogic"),b.traits(["wixapps.apps.blog.BlogMediaPostQueryTrait"]),b.methods({uriFromParams:function(a){var b="";if(a.filter){var c=JSON.parse(a.filter);c.featured&&(b+="Featured/"),c._type&&(b+="Type/"+c._type+"/"),c.tags&&(b+="Tag/"+c.tags+"/")}return a.sort&&(b+="Sort/"+a.sort+"/"),a.page&&(b+="Page/"+a.page+"/"),b},paramsFromUri:function(a){var b=a.split("/"),c={};c.filter={},"Featured"===b[0]&&(c.filter.featured=!0,b.shift());for(var d=0;d<b.length;d+=2)switch(b[d]){case"Type":c.filter._type=b[d+1];break;case"Tag":c.filter.tags=b[d+1];break;case"Page":c.page=b[d+1];break;case"Sort":c.sort=b[d+1];break;case"Date":var e=b[d+1];c.filter["date.iso"]={$regex:"^"+e}}return c.filter=JSON.stringify(c.filter),c},_addAppSpecificParams:function(a){var b;b=a.filter?JSON.parse(a.filter):{},b.draft=!1,a.filter=JSON.stringify(b)}})}),define.Class("wixapps.apps.blog.PostListLogic",function(a){var b=a;b.inherits("wixapps.core.logics.EditableQueryLogic"),b.utilize(["wixapps.integration.managers.WixAppsLocalizer"]),b.traits(["wixapps.apps.blog.BlogMediaPostQueryTrait"]),b.binds(["_updateQuery","_sortChanged","_typeFilterChanged"]),b.fields({_localizer:null}),b.methods({initialize:function(a){this.parent(a),this._localizer=new this.imports.WixAppsLocalizer},run:function(a,b,c){b=b||{};var d={};b.filter&&(d=JSON.parse(b.filter)),d.draft=!1,b.filter=JSON.encode(d),this.parent(a,b,c)},getDataSelectorDef:function(a,b,c){this._partData=a;var d=b.filterView,e=b.filterType;return this._panelModel=this._createEmptyData(e),this._updatePanelModel(b),this._panelModel.addEvent(Constants.DataItemEvents.CHANGE,this._updateQuery),c.addEvent("sort-changed",this._sortChanged),c.addEvent("tag-changed",this._updateQuery),c.addEvent("type-changed",this._typeFilterChanged),{viewName:d,forType:e,dataItem:this._panelModel}},_updateQuery:function(){if(!this._ignoreUpdate){var a=this._panelModel.getValue(),b={};a.featured&&(b.featured=!0);var c=a.tag.selectedValue;c>0&&(b.tags=a.tag.items[c].text),a.type&&"ALL"!=a.type&&(b._type=a.type),this._setPartDataParam("filter",JSON.stringify(b)),this._setPartDataParam("sort",a.sort),this._setPartDataParam("limit",String(a.limit)),this._partData.fireDataChangeEvent()}},_updatePanelModel:function(a){var b=a.filter,c={};b&&b.length&&(c=JSON.parse(b));var d=!!c.featured;this._panelModel.getChildByRef("featured").setValue(d),this._updateTagsModel([],c.tags,this._panelModel.getChildByRef("tag")),this._panelModel.getChildByRef("type").setValue(c._type||"ALL"),this._panelModel.getChildByRef("sort").setValue(a.sort),this._panelModel.getChildByRef("limit").setValue(Number(a.limit)),this._getTags(function(a){this._updateTagsModel(a,c.tags,this._panelModel.getChildByRef("tag"))}.bind(this))},_updateTagsModel:function(a,b,c){var d=c.getValue(),e=0;b&&(e=a.indexOf(b),-1==e?(a.unshift(b),e=1):e+=1),a.unshift(this._localizer.localize("DATA_FILTER_ALL_TAGS")),d.selectedValue=e,d.items=[],a.forEach(function(a,b){d.items.push({_type:"Option",text:a,value:b})}),this._ignoreUpdate=!0,c.setValue(d),this._ignoreUpdate=!1},_getTags:function(a){var b=function(b){var c=Object.keys(b.getValue()).sort();a(c)};this._environment.getDataService().groupByAndCount("Posts","Post",{},"tags",{},b,function(){})},_sortChanged:function(a){var b=JSON.stringify(a.data.getValue().selectedValue);this._panelModel.getChildByRef("sort").setValue(b),this._updateQuery()},_typeFilterChanged:function(a){var b=a.data.getValue().selectedValue;this._panelModel.getChildByRef("type").setValue(b),this._updateQuery()},_setPartDataParam:function(a,b){void 0===b&&delete this._partData._data.appLogicParams[a],this._partData._data.appLogicParams[a]={type:"AppPartParam",value:b}},_createEmptyData:function(a){var b={_type:a},c=this._environment.getDataItemFactory().createDataItem(b);return this._environment.getTypesManager().applyDefaults(c),c}})}),define.Class("wixapps.apps.form.FormDataViewerLogic",function(a){var b=a;b.inherits("wixapps.core.logics.LogicBase"),b.binds(["onSuccess","onFailure","_showFormEntries","_onEntriesLoaded"]),b.utilize(["wixapps.core.logics.DescriptorDataEditingModel"]),b.fields({_environment:null,_logicParams:null}),b.methods({initialize:function(a){this._environment=a,this._itemsPerPage=30},run:function(a,b,c){var d=this._environment;return this._viewName=a,this._callbacks=c,this._logicParams=b,b.collectionId&&b.formId?(d.getDataService().query(b.collectionId,null,null,null,null,this.onSuccess,this.onFailure),this._showLoading(c),void 0):(this.onFailure({description:"'collectionId' and 'formId' should be defined",code:-1}),void 0)},onSuccess:function(a){var b=this._environment,c=b.getTypesManager(),d=(b.getProxyFactory(),{_type:"DataViewer",forms:[],entries:[]});this._dataViewerData=b.getDataItemFactory().createDataItem(d),this._dataViewerData.getChildByRef("forms").setValue(a),c.applyDefaults(this._dataViewerData),this._callbacks.showView(this._dataViewerData,this._viewName,this._getViewEventHandlers(),this._getViewVars());for(var e=0;e<a.length;e++)a[e].getChildValue("_iid")==this._logicParams.formId&&this._showFormEntries(a[e],0);this._hideLoading()},onFailure:function(a){this._showError(this._callbacks,a)},getDataEditingModel:function(){return new this.imports.DescriptorDataEditingModel(this._environment)},_getLastTenItems:function(a,b){var c=this.getDataEditingModel().getItemDefaultCollection(a);this.getDataEditingModel().getDataService().query(c,{_type:a},{_updatedAt:-1},0,10,b)},_getViewEventHandlers:function(){var a=this;return _.merge({},this.parent(),{"view-form-entries":function(b){a._showFormEntries(b.data)},"view-entry":function(b){a._showSingleEntry(b.data)}})},_getViewVars:function(){return{}},_showSingleEntry:function(a){var b=this._environment,c=b.getAppPart(),d=c.getPartDef(),e={itemId:{type:"AppPartCustomization",value:a.getChildValue("originalId")}};W.Commands.getCommand("WAppsEditorCommands.OpenAppDialog").execute({dialogTitle:"Entry",rawAppPartData:{type:"AppPart",appInnerID:b.getAppInstance().getIdInMetasite(),appLogicParams:e,appLogicCustomizations:[],appPartName:d.dataViewerId,viewName:c.getAppInstance().getPartDefinition(d.dataViewerId)[0]}})},_showFormEntries:function(a,b){this._selectedFormData=a,this._createEntryViewerType(),this._dataViewerData.getChildByRef("entries").setValue([]),this._updateRowView(),this._updateTableView(),this._dataViewerData.getChildByRef("entryCount").setValue("loading"),b=b||0;var c=this._environment;c.getDataService().query("Entries",{formId:a.getValue()._iid},null,this._itemsPerPage*b,this._itemsPerPage,this._onEntriesLoaded,this.onFailure)},_createEntryViewerType:function(){this._shownFields=[],this._shownFieldsTypes={};var a=this._selectedFormData.getChildValue("fields");this._genRowType={_iid:"GenRow",_type:"wix:Type",fields:[]};for(var b=0;b<a.length;b++){var c=a[b].fieldName;if(c){var d=this._getNativeType(a[b]._type);this._shownFields.push(c),this._shownFieldsTypes[c]=d,this._genRowType.fields.push({_type:"wix:Field",name:c,type:d})}}this._environment.getTypesManager().registerType(this._genRowType)},_getNativeType:function(a){switch(a){case"CheckBoxInput":return"Boolean";case"CheckBoxGroupInput":return"Array<String>";default:return"String"}},_onEntriesLoaded:function(a){for(var b=[],c=0;c<a.length;c++)b.push(this._formatEntryToViewerType(a[c]));this._dataViewerData.getChildByRef("entries").setValue(b),0===a.length?this._dataViewerData.getChildByRef("entryCount").setValue("none"):a.length>this._itemsPerPage?this._dataViewerData.getChildByRef("entryCount").setValue("multiPage"):this._dataViewerData.getChildByRef("entryCount").setValue("singlePage"),this._dataViewerData.fireChangedEvent()},_formatEntryToViewerType:function(a){for(var b={_type:"GenRow"},c=a.getChildValue("fields"),d=0;d<c.length;d++){var e=c[d].fieldName;this._shownFields.contains(e)&&(b[e]=c[d].value)}for(d=0;d<this._shownFields.length;d++){var f=this._shownFields[d];if(void 0===b[f]){var g=this._shownFieldsTypes[f],h=window[g]||String;b[f]=new h}}return console.log(b),this._environment.getDataItemFactory().createDataItem(b)},_updateTableView:function(){var a=this._environment.getViewDefRepo(),b=a.getViewDefinition("DataViewer","TableView"),c=b.getValue(),d=c.comp.items.first(function(a){return"tableHeader"==a.id}).comp;this._templateHeaderTitle||(this._templateHeaderTitle=d.items[0]);for(var e=[],f=0;f<this._shownFields.length;f++){var g=Object.clone(this._templateHeaderTitle);g.value=this._shownFields[f],e.push(g)}d.items=e,b.setValue(c)},_updateRowView:function(){var a=this._environment.getViewDefRepo(),b=a.getViewDefinition("GenRow","TableView"),c=b.getValue(),d=c.comp.items.first(function(a){return"tableRow"==a.id}).comp;this._templateRowItem||(this._templateRowItem=d.items[0]);for(var e=[],f=0;f<this._shownFields.length;f++){var g=this._shownFields[f],h=Object.clone(this._templateRowItem),i=this._shownFieldsTypes[g];h.comp=this._getComponentDefinitionByNativeType(i),h.data=g,e.push(h)}d.items=e,console.log("rows ="+e),b.setValue(c)},_getComponentDefinitionByNativeType:function(a){var b=this._environment,c=b.getProxyFactory(),d=c.getDefaultProxy(a,"view");return{name:d}},_showLoading:function(a){a.showLoadingIndicator()},_hideLoading:function(){this._callbacks.hideLoadingIndicator()},_showError:function(a,b){a.showErrorIndicator(b.code,b.description)}})}),define.Class("wixapps.apps.form.FormLogic",function(a){var b=a;b.inherits("wixapps.core.logics.CategoryLogic"),b.binds(["onSuccess","_onFormSubmit","_onCloseAfterSubmit","_updateEmailField"]),b.methods({_translateInputsToEntries:function(a){var b=this._environment,c=b.getTypesManager(),d=b.getDataItemFactory(),e=a.getValue(),f={fields:[],formId:e._iid};f._type="FormEntry";for(var g=!0,h=0;h<e.fields.length;h++){var i=e.fields[h],j="value";switch(i._type){case"SelectionInput":case"RadioGroupInput":var k=i.options.items[i.options.selectedValue];i.value=k?k.text:"not selected",j="options";break;case"CheckBoxGroupInput":i.value=[];for(var l=0;l<i.options.items.length;l++){var m=i.options.items[l],n=m.value;i.options.selectedValues.contains(n)&&i.value.push(i.options.items[n].text)}j="options";break;case"SeparatorField":case"HeadingField":continue}var o={};o._type=i._type.replace("Input","Entry"),o.fieldName=i.fieldName,o.value=i.value,f.fields.push(o);var p=d.createDataItem(o),q=this._validateField(i,o,p);g=g&&q;var r=a.getChildByRef("fields").getChildByIndex(h).getChildByRef(j);r.fireEvent(Constants.DataItemEvents.VALIDATION_PERFORMED,{valid:q,target:r,validationMessage:i.validationMessage})}var s=d.createDataItem(f);return c.applyDefaults(s),g?s:null},_validateField:function(a,b,c){var d=!0;switch(a._type){case"TextInput":case"LongTextInput":(a.required||b.value.length>0)&&(d=this._environment.getTypesManager()._validateDataItem(c.getChildByRef("value"),{validations:[{func:"minLength",params:[a.minLength.value]},{func:"maxLength",params:[a.maxLength.value]}]}));break;case"EmailInput":(a.required||b.value.length>0)&&(d=this._environment.getTypesManager()._validateDataItem(c.getChildByRef("value"),{validations:[{func:"email",params:[]}]}));break;case"CheckBoxInput":a.required&&(d=b.value);break;case"SelectionInput":a.required&&a.options.selectedValue<=0&&(d=!1);break;case"RadioGroupInput":a.required&&(d=-1!=a.options.selectedValue);break;case"CheckBoxGroupInput":a.required&&(d=a.options.selectedValues.length>0)}return d},generateDataSelectorPanel:function(a,b,c){this.generateSelectionList(a,b,c,"Choose Form:",function(b){a.addBreakLine(20);var d=a.addSubmitInputField("Submissions will be sent to the following email:","",null,null,"Set"),e=c.collectionId,f=c.itemId;this._updateEmailField(d,f,e),b.addEvent("inputChanged",function(a){f=a.value,this._updateEmailField(d,f,e)}.bind(this))}.bind(this))},_updateEmailField:function(a,b,c){this._environment.getDataService().readItem(c,b,function(b){var d=b.getChildByRef("targetEmail"),e=d.getValue()||"example@example.com";a.setValue(e),a.addEvent("inputChanged",function(a){d.setValue(a.value),this._environment.getDataService().updateItem(c,b,function(){},function(){})}.bind(this))}.bind(this),this._onFormItemReadError)},_onFormItemReadError:function(){},_getViewEventHandlers:function(){return _.merge({},this.parent(),{"submit-form":this._onFormSubmit,"close-after-submit":this._onCloseAfterSubmit})},_onCloseAfterSubmit:function(){var a=this._environment.getAppPart().getMainProxy().getViewContext(),b=a.getData(),c=b.getChildByRef("sendStatus");c.setValue("NOT_SENT")},_onFormSubmit:function(){var a=this._environment.getAppPart().getMainProxy().getViewContext(),b=a.getData(),c=this._translateInputsToEntries(b),d=b.getChildByRef("sendStatus");if(c){d.setValue("SENDING");for(var e=b.getValue().targetEmail,f="",g=b.getChildByRef("fields").getChildren(),h=0;h<g.length;h++)f+=g[h].getChildValue("fieldName")+" : "+g[h].getChildValue("value");this.sendEmail([e],"","","","the form "+b.getValue().formName+" sent you a message",f,f,"",function(){d.setValue("SENT"),this._environment.getAppPart()._data.fireDataChangeEvent()}.bind(this)),this._environment.getDataService().createItem("Entries",c,this._onEntrySaved,this._onEntrySaveError)}},_onEntrySaved:function(){},_onEntrySaveError:function(){},getDataViewerLogicParams:function(){return{formId:{type:"AppPartCustomization",value:this._environment.getAppPart().getMainProxy().getViewContext().getData().getValue()._iid}}},getDataEditingMetaInfo:function(){var a=this._environment.getAppPart().getPartDef().name,b=this._logicParams?this._environment.getDataService().deReference(this._logicParams.collectionId,this._logicParams.itemId):null;return b&&(a=a+" - "+b.getChildValue("title")),{title:a,hasDataEdit:!0,hasDataSelection:!0,dataSelectionLabel:"Customize Form",dataEditingLabel:"Edit Forms",dataViewingLabel:"View Entries"}}})}),define.Class("wixapps.apps.miniposts.SingleItemZoomLogic",function(a){var b=a;b.inherits("wixapps.core.logics.SingleItemLogic"),b.utilize(["wixapps.core.utils.SocialShareHandler"]),b.traits(["wysiwyg.viewer.components.traits.VideoUtils"]),b.binds(["_onVideoUrlReceived","_handleShareRequest"]),b.methods({initialize:function(a){this._environment=a,this._sharer=new this.imports.SocialShareHandler},_getViewEventHandlers:function(){return _.merge({},this.parent(),{sharePost:this._handleShareRequest})},_handleShareRequest:function(a){var b="",c=a.data.getChildValue("_type");switch(c){case"TextPost":this._sharer.handleShareRequest(a.params.service,window.location.href,a.data.getChildValue("title"),"");break;case"PhotoPost":b=a.data.getChildValue("photo").src,this._sharer.handleShareRequest(a.params.service,window.location.href,a.data.getChildValue("title"),"");break;case"VideoPost":var d=this._getServices()[a.data.getValue().video.videoType];this._lastEvent=a,d.getPreviewUrl(a.data.getValue().video.videoId,this._onVideoUrlReceived)}},_onVideoUrlReceived:function(a){this._sharer.handleShareRequest(this._lastEvent.params.service,window.location.href,this._lastEvent.data.getChildValue("title"),a)}})}),define.Class("wixapps.apps.playlist.CurrencyUtils",function(a){function b(a,b){return b[a].offset}function c(a,b){return b[a].symbol}var d=a;d.statics({dataToCurrency:function(a,c,d){if(-1!==String(a).indexOf("."))return a;var e=parseInt(a,10);if(isNaN(e))throw"CurrencyUtils:: Price ["+a+"] is not a number";if(!_.has(d,c))throw"CurrencyUtils:: Unknown currency ["+c+"]";var f=b(c,d),g=parseInt(f,10);if(isNaN(g))throw"CurrencyUtils:: Currency offset ["+f+"] is not a number";return(a/Math.pow(10,g)).toFixed(g)},currencyToData:function(a,c,d){var e=parseFloat(a);if(isNaN(e))throw"CurrencyUtils:: Price ["+a+"] is not a number";if(!_.has(d,c))throw"CurrencyUtils:: Unknown currency ["+c+"]";var f=b(c,d),g=parseInt(f,10);if(isNaN(g))throw"CurrencyUtils:: Currency offset ["+f+"] is not a number";return String(Math.floor(a*Math.pow(10,g)))},resolveCurrencySymbol:function(a,b){if(!_.has(b,a))throw"CurrencyUtils:: Unknown currency ["+a+"]";return c(a,b)}})}),define.Class("wixapps.apps.playlist.PlaylistLogic",function(a){function b(a){for(var b=0,c=0;c<a.songList.length;c++)b+=a.songList[c].songLength;var d=new Date(1e3*b);return d.getUTCHours()+":"+d.getUTCMinutes()+":"+d.getSeconds()}var c=a;c.inherits("wixapps.core.logics.CategoryLogic"),c.resources(["W.Config","W.Utils","W.Viewer","W.Commands"]),c.utilize(["wixapps.core.utils.SocialShareHandler","core.managers.serverfacade.RESTClient","wixapps.integration.utils.WindowOpener","wixapps.apps.playlist.CurrencyUtils"]),c.binds(["_handleSongShare","_handleAlbumShare","_setSelectedSong","_onSongEnded","_buySong","_openPurchase","_onPlayPrev","_onPlayNext","_onAppProxyReady","_onShuffleClick","_onRepeatClick","_openPaymentMethod","_becomeFan","_viewSongPage","_openPlayerAdvancedStylingPanel","_checkUserForPayPalAccount","_cancelUserPayPalAccount","_waitForPayPalWindowToClose","_createSetupPanelForNewUser","_createPanelForExistingUser","_createSetupPayPalPanel","_handleWindowPostMessage","_getPlaylistDisplayPrice","_setPlaylistDisplayPrice","_getSongDisplayPrice","_setSongDisplayPrice","_getPlaylistSelectedCurrencySymbol","_getSongSelectedCurrencySymbol","_selectAndPlaySong","_updateMediaControls","_playSongStarted","_getAllGenres","_setSongGenre"]),c.statics({fieldsByTypeMapping:{Song:{title:"songTitle",price:"songPrice",albumName:"songAlbum",artistName:"songArtist",fileId:"uri",description:"description"},Playlist:{title:"title",price:"playlistPrice",albumName:"songAlbum",artistName:"playlistArtist",fileId:"_iid",description:"playlistDescription"}},ActivityTypes:{trackPlay:"music/track-play",trackFullyPlayed:"music/track-played",trackSkip:"music/track-skip",trackLyrics:"music/track-lyrics",trackShare:"music/track-share",albumShare:"music/album-share",albumFan:"music/album-fan"},DGSBaseUrl:"http://wix-dgs-test.appspot.com",DGSPermissionsUrl:"/pp/permissions",DGSCheckoutUrl:"/paypal_page.html",PaymentSettingsTooltipId:"wixapps_playlist_payment_setup_tooltip",FinalizeURL:"/secure-files/collection"}),c.fields({_songList:null,_selectedSongIndexInList:null,_playingSongIndexInList:null,_mainProxyEnvironment:null,_shuffledPlaylist:null,_repeatToggleCounter:0,_playlistRepeatModes:["none","all"],_setupPayPalWindow:null,_currentUserId:null,_DGSFrameContainer:null,_currencyList:null}),c.methods({initialize:function(a){this.parent(a),this._environment.getDataItemFactory().getFunctionLibrary().addFunction("Logic.calcPlaylistDuration",b),this._environment.getAppPart().addEvent("proxyDisplayed",this._onAppProxyReady),this._sharer=new this.imports.SocialShareHandler,this._restClient=new this.imports.RESTClient,this._currentUserId=this.resources.W.Config.getRendererModelProperty("userId");var c=this._environment.getAppInstance(),d=c.getDescriptorValue(["externalResources"]),e=_.find(d,function(a){return"currencies"===a.name});this._currencyList=e&&e.value||{};var f=_.find(d,{name:"genres"});this._genres=f&&f.value||[],this.resources.W.Commands.registerCommandAndListener("WEditorCommands.NoRedirectFirstSave",this,this._createSetupPayPalPanel),this._registerForWindowPostMessages(),this._DGSFrameContainer=this._createDGSFrameContainer(),this._localizer=a.getAppInstance().getLocalizer()},_loc:function(a,b){return this._localizer.localize(a,b)},_createTooltipData:function(a){var b=a.dataMap.TOOLTIPS.get("toolTips");b[this.PaymentSettingsTooltipId]={isMoreLess:!1,isDontShowAgain:!1,content:"<p>"+this._loc("PAYMENT_SETTINGS_TOOL_TIP")+"</p>",isPublished:!0,help:{isMoreHelp:!1,text:null,url:""}}},_registerComputedFieldsControllers:function(){this._environment.getDataItemFactory().registerComputedFieldController("playlistDisplayPrice","Playlist",this._getPlaylistDisplayPrice,this._setPlaylistDisplayPrice),this._environment.getDataItemFactory().registerComputedFieldController("songDisplayPrice","Song",this._getSongDisplayPrice,this._setSongDisplayPrice),this._environment.getDataItemFactory().registerComputedFieldController("playlistSelectedCurrencySymbol","Playlist",this._getPlaylistSelectedCurrencySymbol,null),this._environment.getDataItemFactory().registerComputedFieldController("selectedCurrencySymbol","Song",this._getSongSelectedCurrencySymbol,null),this._environment.getDataItemFactory().registerComputedFieldController("allGenres","Song",this._getAllGenres,this._setSongGenre)},_getAllGenres:function(a){var b=_.map(this._genres,function(a){return{text:this._loc(a),value:a,enable:!0,description:""}}.bind(this));return{items:b,selectedValue:a.getChildValue("genre")}},_setSongGenre:function(a,b,c){var d=c.getValue(0);d.genre=a.selectedValue,b(d)},_getPlaylistSelectedCurrencySymbol:function(a){var b=a.getValue(0);return this.imports.CurrencyUtils.resolveCurrencySymbol(b.playlistSelectedCurrency,this._currencyList)},_getSongSelectedCurrencySymbol:function(a){var b=a.getValue(0);return this.imports.CurrencyUtils.resolveCurrencySymbol(b.selectedCurrency,this._currencyList)},_getPlaylistDisplayPrice:function(a){var b=a.getValue(0);return this.imports.CurrencyUtils.dataToCurrency(b.playlistPrice,b.playlistSelectedCurrency,this._currencyList)},_setPlaylistDisplayPrice:function(a,b,c){var d=c.getValue(0);d.playlistPrice=this.imports.CurrencyUtils.currencyToData(a,d.playlistSelectedCurrency,this._currencyList),b(d)},_getSongDisplayPrice:function(a){var b=a.getValue(0);return this.imports.CurrencyUtils.dataToCurrency(b.songPrice,b.selectedCurrency,this._currencyList)},_setSongDisplayPrice:function(a,b,c){var d=c.getValue(0);d.songPrice=this.imports.CurrencyUtils.currencyToData(a,d.selectedCurrency,this._currencyList),b(d)},_createDGSFrameContainer:function(){var a=new Element("div");return a.inject(document.body),a},_registerForWindowPostMessages:function(){window.addEventListener?window.addEventListener("message",this._handleWindowPostMessage,!1):window.attachEvent&&window.attachEvent("onmessage",this._handleWindowPostMessage)},_handleWindowPostMessage:function(a){a&&a.origin===this.DGSBaseUrl&&this._DGSFrameContainer.empty()},_openDGSCheckoutFrame:function(a){var b=this;this._DGSFrameContainer.empty();var c=new Element("iframe",{src:this._getCheckoutUrl(a),id:"invisible-frame",style:"position:fixed; top:0px; bottom:0px; left:0px; right:0px; width:100%; height:100%;"}),d=new Element("div",{id:"close-invisible-frame",style:"position:fixed; top:20px; left:20px; font-size:24px; font-weight:bold; cursor:pointer;",html:"X",events:{click:function(){b._DGSFrameContainer.empty()}}});this._DGSFrameContainer.adopt(c,d)},_onAppProxyReady:function(a){this._mainProxyEnvironment=a.getViewContext().getEnvironment(),this._selectedSongIndexInList=this._mainProxyEnvironment.getVar("selectedSongIndexInList"),this._playingSongIndexInList=this._mainProxyEnvironment.getVar("playingSongIndexInList"),this._musicPlayerComp=this._findMusicPlayerComponent(),this._musicPlayerComp.on("playAudio",this,this._updateMediaControls),this._musicPlayerComp.on("stopAudio",this,this._updateMediaControls),this._musicPlayerComp.on("pauseAudio",this,this._updateMediaControls),this._shufflePlaylist(),this._updateMediaControls()},queryAllPlaylists:function(a,b){this._environment.getDataService().query("Playlists",{},null,0,-1,!1,a,b)},generateSelectionList:function(a,b,c,d,e){this.newPlaylistCreated&&(c.dontShowCreateNew=!0),this.parent(a,b,c,d,e)},generateSettingsPanel:function(a){var b=this;this._createTooltipData(a.resources.W.Data),a.addButtonField("",this._loc("CHANGE_PLAYER_STYLE"),null,null,"wysiwyg.editor.skins.buttons.ButtonBaseWithArrowSkin").runWhenReady(function(a){a.addEvent(Constants.CoreEvents.CLICK,b._openPlayerAdvancedStylingPanel)}),a.addBreakLine(10,"1px solid grey"),a.addBreakLine(10),a.addLabel(this._loc("PAYMENT_SETTINGS"),{"font-weight":"bold"},null,null,null,null,this.PaymentSettingsTooltipId),a.addLabel(this._loc("PAY_PAL_SETUP_DESCRIPTION")),a.addBreakLine(10),this.resources.W.Config.siteNeverSavedBefore()?a.addButtonField("",this._loc("PAY_PAL_SETUP"),null,null,null,null,null,"wysiwyg.editor.skins.buttons.ButtonBaseWithArrowSkin","WAppsEditorCommands.OpenWixAppsSiteMustBeSavedDialog"):a.addInputGroupField(function(){b._setupPayPalPanel=this,b._createSetupPayPalPanel()},"skinless")},_createSetupPayPalPanel:function(){var a=this;this._setupPayPalPanel.getIsDisposed()||(a._setupPayPalPanel.disposeFields(),a._setupPayPalPanel.addLabel(this._loc("PENDING_PAY_PAL")),this._checkUserForPayPalAccount().done(a._createPanelForExistingUser,a._createSetupPanelForNewUser))},_getPayPalRequestPermissionsUrl:function(){return this.DGSBaseUrl+this.DGSPermissionsUrl+"?mode=request&wixuserId="+this._currentUserId},_createSetupPanelForNewUser:function(){var a=this;
this._setupPayPalPanel.getIsDisposed()||(this._setupPayPalPanel.disposeFields(),this._setupPayPalPanel.addButtonField("",this._loc("PAY_PAL_SETUP")).runWhenReady(function(b){b.addEvent("click",function(){var b={width:960,height:610,menubar:!1,toolbar:!1,location:!1,status:!1,resizable:!1,scrollbars:!1};a._setupPayPalWindow=a.imports.WindowOpener.open(a._getPayPalRequestPermissionsUrl(),"SetupPayPayAccount",b),a._waitForPayPalWindowToClose(a._createSetupPayPalPanel)})}))},_createPanelForExistingUser:function(a){var b=this;this._setupPayPalPanel.getIsDisposed()||(this._setupPayPalPanel.disposeFields(),a&&a.ack&&"Success"===a.ack?(this._setupPayPalPanel.addLabel("Connected account: <span style='color:green;'>"+a.account+"</span>"),this._setupPayPalPanel.addButtonField("","Disconnect",null,null,"linkRight").runWhenReady(function(a){a.addEvent("click",function(){b._cancelUserPayPalAccount().done(b._createSetupPayPalPanel,b._createSetupPayPalPanel)})})):b._createSetupPanelForNewUser())},_waitForPayPalWindowToClose:function(a){if(this._setupPayPalWindow.closed)return a(),this._setupPayPalWindow=null,void 0;var b=this;window.setTimeout(function(){b._waitForPayPalWindowToClose.call(b,a)},100)},_createPayPalPermissionRequestPromise:function(a){var b=Q.defer(),c={mode:a,wixuserId:this._currentUserId,accept:"jsonp"},d=this.resources.W.Utils.AppsUtils.getTimeBasedUniqueId("jsonp_permissions"),e=function(a){b.resolve(a)},f=function(){b.reject()},g=this.DGSBaseUrl+this.DGSPermissionsUrl;return this.resources.W.Utils.AppsUtils.jsonp(g,c,d,e,f),b.promise},_cancelUserPayPalAccount:function(){return this._createPayPalPermissionRequestPromise("cancel")},_checkUserForPayPalAccount:function(){return this._createPayPalPermissionRequestPromise("check")},_openPlayerAdvancedStylingPanel:function(){W.Commands.executeCommand("WAppsEditorCommands.CustomizeComponent",{appPart:this._environment.getAppPart(),selection:this._musicPlayerComp.$view})},_getCheckoutUrl:function(a){var b=this._environment.getAppPart(),c=b.getLogicParams(),d=this._environment.getDataService(),e=d.getTransport(),f=this.resources.W.Utils.AppsUtils.urlBuilder(this.DGSBaseUrl).combinePath(this.DGSCheckoutUrl).addParam("storeId",e.getStoreId()).addParam("collectionId",c.collectionId).addParam("itemId",c.itemId).addParam("subitemId",a.getChildValue("itemId")).addParam("metasiteId",this.resources.W.Config.getMetaSiteId());return f.toString()},_buySong:function(a){this.resources.W.Config.env.$isPublicViewerFrame&&this._openDGSCheckoutFrame(a.data)},onBeforeDataEdit:function(a,b){this.queryAllPlaylists(function(a){this.playlistsAtEditStart=a,b()}.bind(this))},onAfterDataEdit:function(a,b){if("SAVE"==a||"SAVE_NO_CHANGE"==a){var c=b.selectedTreeItem.item,d=this._environment.getAppPart().getDataItem(),e=this._environment.getAppPart().getLogicParams();c.getChildValue("_iid")!=e.itemId&&(d.getData().appLogicParams.itemId={value:c.getChildValue("_iid")},d.getData().appLogicParams.collectionId={value:"Playlists"},d.fireDataChangeEvent()),"SAVE"==a&&(this._checkIfToFinalizeCurrentAlbum(c),this._finalizeOtherAlbumsIfNeeded(c))}delete this.playlistsAtEditStart},_getSongList:function(a){return _.map(a.getValue().songList,"uri")},_isPlaylistRequiresFinalization:function(a){var b=_.find(this.playlistsAtEditStart,function(b){return b.getChildValue("_iid")==a.getChildValue("_iid")}),c=!b||_.difference(this._getSongList(a),this._getSongList(b));return a.getChildValue("playlistIsFinalized")===!0&&c},_checkIfToFinalizeCurrentAlbum:function(a){a.getChildValue("playlistIsFinalized")?this._isPlaylistRequiresFinalization(a)&&this._finalizeAlbum(a):W.Commands.executeCommand("WAppsEditorCommands.OpenPromptDialog",this.promptOnSave(a))},promptOnSave:function(a){return{title:"Ready to Create Your Download",content:"It takes about 5 mn...",buttons:[{label:"PLAYLIST_CREATE_DOWNLOAD",color:void 0,align:"right"},{label:"PLAYLIST_NOT_NOW",color:"grayed",align:"left"}],callback:function(b){this._savePromptCB(b,a)}.bind(this)}},_savePromptCB:function(a,b){"PLAYLIST_CREATE_DOWNLOAD"===a.result&&this._finalizeAlbum(b)},_finalizeAlbum:function(a,b){var c=_.map(b.getChildValue("songList"),function(a){return{file_url:a.uri,title:a.songTitle}}),d={collection_id:this._environment.getAppPart().getLogicParams().collectionId,media_type:"secure_music_collection",cover_file_url:b.getChildValue("playlistCover").src,artist_name:b.getChildValue("playlistArtist"),collection_items:c};this._restClient.post(""+this.FinalizeURL,d,function(){})},onAfterItemEditing:function(a){if("Song"===a.editedItem.getTypeName()&&"delete"!==a.action){var b=a.originalItem.getValue();b.itemId&&"duplicate"!==a.action||(b.itemId=this.resources.W.Utils.AppsUtils.getTimeBasedUniqueId(),a.originalItem.setValue(b))}},_finalizeOtherAlbumsIfNeeded:function(a){this.queryAllPlaylists(function(b){_.forEach(b,function(b){b.getChildValue("_iid")!=a.getChildValue("_iid")&&this._isPlaylistRequiresFinalization(b)&&this._finalizeAlbum(b)},this)}.bind(this))},_openPaymentMethod:function(){alert("kololo")},_findMusicPlayerComponent:function(){var a=this._environment.getAppPart().getViewNode().getElements("[comp*='SingleAudioPlayer']");if(a.length)return a[0].$logic;throw"PlaylistLogic must contain a [SingleAudioPlayer] component in its view."},_onBeforeItemRendered:function(a,b){var c=a.getValue();c.songList[0].playlistId=c._iid,b.selectedSong=c.songList[0],b.playingSong=c.songList[0],b.selectedSongIndexInList=0,b.playingSongIndexInList=0,b.shuffleMode=c.playlistShuffleMode,b.repeatMode=c.playlistRepeatMode,this._repeatToggleCounter=this._playlistRepeatModes.indexOf(c.playlistRepeatMode),this._songList=a.getChildByRef("songList"),a.setValue(c)},_updateMediaControls:function(){var a=this._playingSongIndexInList.getValue();if(this._musicPlayerComp){var b=this._mainProxyEnvironment.getVar("repeatMode");0===a&&"all"!=b?this._musicPlayerComp._skinParts.prevBtn.setAttribute("disabled","disabled"):this._musicPlayerComp._skinParts.prevBtn.removeAttribute("disabled"),a==this._songList.getChildrenCount()-1&&"all"!=b?this._musicPlayerComp._skinParts.nextBtn.setAttribute("disabled","disabled"):this._musicPlayerComp._skinParts.nextBtn.removeAttribute("disabled");var c=this._mainProxyEnvironment.getVar("isPlaying");c.setValue("playing"===this._musicPlayerComp.getState("playerState"))}},_getInfoForSongOrPlaylist:function(a){var b=a.getValue(),c={type:b._type};if("Song"==c.type){var d;for(d=0;d<this._songList.getChildrenCount();d++)if(this._songList.getChildValue(d)._iid==b._iid){c.songIndex=d;break}}return _.forOwn(this.fieldsByTypeMapping[b._type],function(a,d){c[d]=b[a]}),c},_signSong:function(a,b){var c,d=this.resources.W.Utils.getGUID(),e=this._getInfoForSongOrPlaylist(a);c="Song"==e.type?"{_iid}_"+e.songIndex+"^{songList["+e.songIndex+"].songPrice}^{playlistSelectedCurrency}^"+d+"^{_date}":"{_iid}^{playlistPrice}^{playlistSelectedCurrency}^"+d+"^{_date}";var f=new Date,g=f.getTime()+60*f.getTimezoneOffset();b(a,{signature:c,timestamp:g,transactionId:d})},_openPurchase:function(a,b){var c=this;this._createIFrame("600px","400px",function(d){d.setStyles({position:"relative",width:"520px",height:"580px",margin:"0 auto",display:"block"});var e=c._getInfoForSongOrPlaylist(a),f={fingerprint:b.signature,metasiteId:W.Config.getMetaSiteId(),appDefinitionId:c._environment.getAppInstance()._appDefinitionId,instanceId:c._environment.getDataService().getTransport()._storeId,transactionTotal:e.price,transactionReferenceId:b.transactionId,transactionTimestamp:b.timestamp,transactionCurrency:a.getParent().getParent().getValue().playlistSelectedCurrency,albumName:e.albumName||"",artistName:e.artistName,itemTitle_1:e.title,itemSku_1:a.getValue()._iid,itemPrice_1:e.price,itemQuantity_1:1,itemFileId_1:a.getValue().uri||a.getValue()._iid,itemDescription_1:e.description},g="http://safer-checkout.krembo.wixpress.com/media/checkout",h=new Element("div"),i=[];i.push('<form id="openPurchaseForm" action="'+g+'" method="post" enctype="application/x-www-form-urlencoded" target="openPurchaseIFrame">'),_.forOwn(f,function(a,b){i.push('<input type="hidden" name="'+b+'" value="'+a+'"></input>')}),i.push("</form>"),h.innerHTML=i.join(""),document.body.appendChild(h),document.getElementById("openPurchaseForm").submit(),document.body.removeChild(h)})},_getViewEventHandlers:function(){return _.merge({},this.parent(),{songSelected:this._setSelectedSong,songArtSelected:this.setSelectedSongByArt,songEnded:this._onSongEnded,playNext:this._onPlayNext,playPrev:this._onPlayPrev,buySong:this._buySong,toggleShuffle:this._onShuffleClick,toggleRepeat:this._onRepeatClick,becomeFan:this._becomeFan,shareSong:this._handleSongShare,shareAlbum:this._handleAlbumShare,viewSongPage:this._viewSongPage,openMediaPanel:this._openMediaPanel,selectAndPlaySong:this._selectAndPlaySong,startedPlay:this._playSongStarted})},_setSelectedSong:function(a){var b=_.findIndex(a.data._parent.getChildren(),a.data);this._changeSelectedSong(b,!1,a)},_selectAndPlaySong:function(a){this._togglePlayAfterSongChanged=!0;var b="playing"==this._musicPlayerComp.getState("playerState");this._togglePlayNewState=!b,this._setPlayingSong(a)},_setPlayingSong:function(a){var b=_.findIndex(a.data._parent.getChildren(),a.data);this._changePlayingSong(b,!0,a),this._togglePlayAfterSongChanged&&(this._togglePlayAfterSongChanged=!1,this._togglePlayNewState?this._musicPlayerComp._playAudio():this._musicPlayerComp._pauseAudio())},_changePlayingSong:function(a,b,c){b=void 0===b?!0:b,this._changeSelectedSong(a,b,c),this._playingSongIndexInList.setValue(a);var d=this._songList.getChildByIndex(a),e=d.getValue();this._mainProxyEnvironment.setVar("playingSong",e)},_changeSelectedSong:function(a,b,c){var d=this._songList.getChildByIndex(a),e=d.getValue();e.playlistId=this._songList.getParent().getChildValue("_iid"),this._mainProxyEnvironment.setVar("selectedSong",e),this._selectedSongIndexInList.setValue(a),"playing"==this._musicPlayerComp.getState("playerState")&&this._reportActivity(this.ActivityTypes.trackPlay,c)},_playSongStarted:function(){this._updateMediaControls()},_onShuffleClick:function(){this._shufflePlaylist();var a=this._mainProxyEnvironment.getVar("shuffleMode").getValue();this._mainProxyEnvironment.setVar("shuffleMode",!a)},_onRepeatClick:function(){this._repeatToggleCounter=(this._repeatToggleCounter+1)%this._playlistRepeatModes.length,this._mainProxyEnvironment.setVar("repeatMode",this._playlistRepeatModes[this._repeatToggleCounter])},_shufflePlaylist:function(){this._shuffledPlaylist=_.shuffle(_.range(this._songList.getChildrenCount()));var a=this._playingSongIndexInList.getValue(),b=this._shuffledPlaylist.indexOf(a);this._shuffledPlaylist.splice(b,1),this._shuffledPlaylist.unshift(a)},setSelectedSongByArt:function(a){a.data.getParent().getValue()},_getNextLogicalSongIndex:function(){var a=this._playingSongIndexInList.getValue();if(this._mainProxyEnvironment.getVar("shuffleMode").getValue()){var b=(this._shuffledPlaylist.indexOf(a)+1)%this._shuffledPlaylist.length;return this._shuffledPlaylist[b]}return a+1},_getPreviousLogicalSongIndex:function(){var a=this._playingSongIndexInList.getValue(),b=this._songList.getChildrenCount();if(this._mainProxyEnvironment.getVar("shuffleMode").getValue()){var c=this._shuffledPlaylist.indexOf(a);return c=(c-1+this._shuffledPlaylist.length)%this._shuffledPlaylist.length,this._shuffledPlaylist[c]}return a-=1,a=(a%b+b)%b},_onSongEnded:function(a){var b=!0,c=this._playingSongIndexInList.getValue(),d=this._mainProxyEnvironment.getVar("repeatMode").getValue();"one"==d?this._changeSelectedSong(c,!1):this._onPlayNext(a,b)},_onPlayPrev:function(){var a=this._getPreviousLogicalSongIndex(),b=this._mainProxyEnvironment.getVar("repeatMode").getValue(),c=0===a;if("all"==b){var d=this._songList.getChildrenCount();this._changePlayingSong((a+d)%d)}else c||this._changePlayingSong(a)},_onPlayNext:function(a,b){var c=this._getNextLogicalSongIndex(),d=this._mainProxyEnvironment.getVar("repeatMode").getValue();"all"==d?this._changePlayingSong(c%this._songList.getChildrenCount()):c<this._songList.getChildrenCount()&&this._changePlayingSong(c),b=b||!1,b?this._reportActivity(this.ActivityTypes.trackFullyPlayed,a):this._reportActivity(this.ActivityTypes.trackSkip,a)},_createIFrame:function(a,b,c){var d=document.getElementById("openPurchaseIFrame");d&&d.parentNode.removeChild(d);var e=new window.IFrame({name:"openPurchaseIFrame",id:"openPurchaseIFrame"});e.width=a,e.height=b,navigator.userAgent.match(/(iPod|iPhone|iPad)/)&&this._view.setStyles({overflow:"scroll","-webkit-overflow-scrolling":"touch"}),this.resources.W.Viewer.getCurrentPageNode().grab(e),this.resources.W.Utils.prepareIFrameForWrite(e,function(d,e){e.write('<html><body style="margin:0px;"></body></html>'),d.setStyles({height:b,width:a}),c(d,e)})},_openMediaPanel:function(){var a={galleryConfigID:"audio",i18nPrefix:"secure_music",selectionType:"single",mediaType:"secure_music"};W.Commands.executeCommand("WEditorCommands.OpenMediaFrame",a)},_handleSongShare:function(a){var b=a.context.getData(),c=b.getValue(),d=c.songImage.src;if(d){var e=d.match(/^(http:\/\/)?(images\/.*)/);e&&(d=this.resources.W.Utils.AppsUtils.combinePath(this._appBasePath,e[2]))}var f=this,g="f647244b-ab29-4ef4-82d7-614ab11e647b";this._environment.getAppInstance().getPageLinkResolverPromise(g).then(function(e){var h=f._environment.getAppPart(),i=h.getLogicParams&&h.getLogicParams()||{};e.resolveLinkUrl(g,b,i,null,function(b){f._reportActivity(f.ActivityTypes.trackShare,a),f._sharer.handleShareRequest(a.params.service,window.location+"#!"+b,c.songTitle,d)})}).done()},_handleAlbumShare:function(a){var b=a.context.getData(),c=b.getValue(),d="http://static.wixstatic.com/media/"+c.playlistCover.src;this._reportActivity(this.ActivityTypes.albumShare,a),this._sharer.handleShareRequest(a.params.service,window.location.href,c.title,d)},_becomeFan:function(a){this._reportActivity(this.ActivityTypes.albumFan,a)},_viewSongPage:function(a){this._reportActivity(this.ActivityTypes.trackLyrics,a)},_reportActivity:function(a,b){var c;switch(a){case this.ActivityTypes.trackPlay:case this.ActivityTypes.trackFullyPlayed:case this.ActivityTypes.trackSkip:case this.ActivityTypes.trackLyrics:c=this._generateSongSchema(b);break;case this.ActivityTypes.trackShare:c=this._generateSongSchema(b,!0);break;case this.ActivityTypes.albumShare:c=this._generateAlbumSchema(b,!0);break;case this.ActivityTypes.albumFan:c=this._generateAlbumSchema(b)}W.Commands.executeCommand("WViewerCommands.Activity.Report",{name:"Playlist",fields:c,type:a})},_generateSongSchema:function(a,b){b=b||!1;var c={track:{name:a.data.getValue().songTitle,id:a.data.getValue()._iid},album:{name:this._songList._parent.getValue()._iid,id:this._songList._parent.getValue().title}};if(b&&(c.sharedTo=this._sharer.getSocialActivityValue(a.params.service),!c.sharedTo))throw"Sharing album failed due to invalid service request";return c},_generateAlbumSchema:function(a,b){b=b||!1;var c={album:{name:a.data.getValue().title,id:"TBD"}};if(b&&(c.sharedTo=this._sharer.getSocialActivityValue(a.params.service),!c.sharedTo))throw"Sharing album failed due to invalid service request";return c},dispose:function(){this._environment.getAppPart().removeEvent("proxyDisplayed",this._onAppProxyReady),window.removeEventListener?window.removeEventListener("message",this._handleWindowPostMessage,!1):window.detachEvent&&window.detachEvent("onmessage",this._handleWindowPostMessage),this.parent()}})}),define.Class("wixapps.apps.playlist.PlaylistPageLinkResolver",function(a){var b=a;b.inherits("wixapps.core.logics.page.PageLinkResolverBase"),b.resources(["W.Utils","W.Viewer"]),b.methods({resolveLinkUrl:function(a,b,c,d,e){var f=this.resources.W.Utils.hash.getHashPartsString,g=this.resources.W.Viewer.getPageDataPromise(function(b){return b.get("appPageId")===a});g.then(function(a){var c=a.get("id"),d=b.getChildValue("songTitle"),g=b.getChildValue("playlistId")||b.getParent().getParent().getChildValue("_iid")||"",h=b.getChildValue("uri");h=h.split("."),e(f(c,d,g+"/"+h[0]))})}})}),define.Class("wixapps.apps.playlist.PlaylistPageLogic",function(a){var b=a;b.inherits("wixapps.core.logics.page.PageLogicBase"),b.fields({_environment:null}),b.resources(["W.Utils","W.Viewer"]),b.methods({initialize:function(a){this._environment=a},_getCollectionId:function(){return"Playlists"},fetchSampleDataItem:function(a,b){this._environment.getDataService().query(this._getCollectionId(),null,null,0,1,!1,function(b){a(b[0].getChildByRef("songList").getChildByIndex(0))},b)},fetchDataItem:function(a,b,c){var d=this._environment.getDataService(),e=this._getCollectionId(),f=a.albumId,g=a.uri,h=function(a){a||c({code:-10003,description:"cannot find album matching "+f});var d=a.getChildByRef("songList");d||c({code:-10003,description:"album matching "+f+" does not contain a song list"});for(var e=g+".mp3",h=null,i=d.getChildrenCount(),j=0;i>j;j++){var k=d.getChildByIndex(j);if(k.getChildValue("uri")===e){h=k;break}}h?b(h):c({code:-10003,description:"cannot find uri matching "+g+" in album id "+f})}.bind(this),i=function(a){c(a)}.bind(this);if(!f||!g)return c({code:-1,description:"Album id or song uri are not defined"}),void 0;var j=d.readItemFromCache(e,f);j?h(j):this._environment.getDataService().readItem(e,f,h,i)},paramsFromUri:function(a){var b=a.split("/"),c={};return c.albumId=b[0],c.uri=b[1],c}})}),define.skin("wixapps.apps.playlist.editor.DataEditorDialogSkin",function(a){var b=a;b.inherits("mobile.core.skins.BaseSkin"),b.compParts({listView:{skin:"wixapps.integration.skins.editor.VerticalListEditorSkin"}}),b.skinParams([{id:"rd",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"3px"},{id:"rdBig",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"6px"},{id:"rdBigger",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"9px"},{id:"shd",type:Constants.SkinParamTypes.BOX_SHADOW,defaultValue:"1px 1px 5px 1px rgba(0, 0, 0, 0.6);"},{id:"noShd",type:Constants.SkinParamTypes.BOX_SHADOW,defaultValue:"0 0 0 0 rgba(0, 0, 0, 0);"},{id:"videoThumbBg",type:Constants.SkinParamTypes.BG_COLOR,mutators:["alpha",40],defaultValue:"#000",noshow:!0},{id:"videoThumbColor",type:Constants.SkinParamTypes.COLOR_ALPHA,mutators:["alpha",70],defaultValue:"#FFFFFF",noshow:!0},{id:"videoThumbCorners",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"7px",noshow:!0},{id:"tdr",type:Constants.SkinParamTypes.URL,defaultTheme:"BASE_THEME_DIRECTORY"}]),b.html('<section skinPart="listContainer"></section><section skinPart="editViewContainer"><div skinPart="listView"></div><header class="clearfix"><div skinPart="headerView"></div><button skinPart="addToParentBTN"><p>New Track</p></button><ul skinPart="childTypesContainer"></ul></header><p skinPart="noResultsMessage"></p></section><br style="clear:both;" />'),b.css(["{ border-bottom:solid 1px #d8d8d8; position:absolute; left:0; right:0; top:36px; bottom:47px; color:#4d4d4d; }"," button { width:100%; margin: auto 0px; height:32px; padding:0;outline:none; cursor:pointer; [rd] background-image: -moz-linear-gradient( 90deg, rgb(236,236,236) 37%, rgb(255,255,255) 56%); background-image: -webkit-linear-gradient( 90deg, rgb(236,236,236) 37%, rgb(255,255,255) 56%); background-image: -ms-linear-gradient( 90deg, rgb(236,236,236) 37%, rgb(255,255,255) 56%);}"," button:hover { border-color:#19a3fe; background-position:center; -moz-box-shadow: 0 1px 0 0 #ccc;-webkit-box-shadow: 0 1px 0 0 #ccc;box-shadow: 0 1px 0 0 #ccc}",' button p { padding:0 12px 0 35px; font-size:14px; line-height:30px; color:#19a3fe; border:1px solid rgb( 191, 191, 191 ); [rd] font-family:"HelveticaNeue-Roman", "Helvetica Neue Roman", "Helvetica Neue", Helvetica, Arial,"Sans-Serif";font-size:14px; background: transparent url([tdr]wix_apps/Plus.png) center no-repeat; background-position-x: 16px; }'," .singleLine { white-space:nowrap; display:block; overflow:hidden; text-overflow:ellipsis;  word-wrap:normal; }",' .videoIndicator > div:before {content:""; position:absolute; top:50%; left:50%; margin-top:-15px; margin-left:-20px; width:40px; height:30px;[videoThumbBg][videoThumbCorners]  }',' .videoIndicator > div:after {content:""; position:absolute; top:50%; left:50%; width:0; height:0; margin-top:-10px; margin-left:-9px; border:10px solid transparent; border-left:18px solid [videoThumbColor] }'," ul.toplist { overflow-y:auto; overflow-x:hidden; height:100%}","%listContainer% { width:230px; position:absolute; left:0; top:0; bottom:0; margin-top:-2px; overflow-y:auto; overflow-x:hidden; }",' h4.listTitle { font-family:"HelveticaNeue-Medium", "Helvetica Neue Medium", "Helvetica Neue", Helvetica, Arial,"Sans-Serif";font-size:17px;color:#373737; font-weight:bold; line-height:40px; color:#000000; margin:0; padding:0 0 0 12px; border-top:solid 1px #d8d8d8; border-bottom:solid 1px #d8d8d8; }',"%listContainer% li > p { line-height:16px; padding:5px 0 5px 20px; border-left:solid 10px #ffffff; cursor:pointer; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }","%listContainer% ul { margin-top:8px; }",' ul.toplist > li p { font-family:"HelveticaNeue-Roman", "Helvetica Neue Roman", "Helvetica Neue", Helvetica, Arial,"Sans-Serif";font-size:14px;color:#373737}'," ul.list { margin-top:0; }"," ul.list > li p { padding-left:40px; font-weight:normal; background: transparent url([tdr]wix_apps/menus_app_sprite.png) -130px 8px no-repeat; cursor:pointer; }","%listContainer% button.newItemButton { margin:12px 0 30px 15px; border:none; width:87% }"," ul.toplist li .selectedDataSection { border-left-color:#86cefe; background-color:#11a0ff; color:#ffffff; }"," ul.list li .selectedDataSection { border-left-color:#86cefe; background-color:#11a0ff; color:#ffffff; background-position:-130px -72px; }"," p.selectedDataSection + ul.list li p { background-position:-130px -32px; }"," %listContainer% li > p:hover { border-left-color:#86cefe; background-color:#11a0ff; color:#ffffff; }"," ul.list li > p:hover { border-left-color:#86cefe; background-color:#11a0ff; color:#ffffff; background-position:-130px -72px; }",' ul.toplist > li p:hover { font-family:"HelveticaNeue-Roman", "Helvetica Neue Roman", "Helvetica Neue", Helvetica, Arial,"Sans-Serif";font-size:14px;color:#ffffff}'," p.selectedDataSection + ul.list li p:hover { background-position:-130px -72px; }","%.listSection% { background-position:-130px -32px; font-weight:normal; }","%editViewContainer% { height:100%; margin:0 0 0 230px; position:relative; }",'%editViewContainer%:after { content:""; position:absolute; left:0; top:0; bottom:0; width:10px; background: transparent url([tdr]wix_apps/menus_app_sprite.png) left top no-repeat; }',"%editViewContainer% header { height:69px; position:absolute; top:0; left:0; right:0; border :solid 1px #dbdbdb; }","%headerView% { position:absolute; bottom:0; left:0; right:0; background-color:#f1f1f1 }","%headerView% .queryTitle { font-size:18px; font-weight:bold; color:#333; padding-left:25px; line-height:50px }","%editViewContainer% %addToParentBTN% { position:absolute; top:18px; right:10px; width:125px; border:none }","[state~=singleChildType] %addToParentBTN% p { padding:0 0 0 28px; }","[state~=multipleChildTypes] %addToParentBTN% { width:108px; }","[state~=multipleChildTypes] %addToParentBTN% p { padding:0 16px 0 0; }",'[state~=multipleChildTypes] %addToParentBTN% p:before { content:""; position:absolute; right:1px; top:0; width:30px; height:28px; }','[state~=multipleChildTypes] %addToParentBTN% p:after { content:""; position:absolute; right:0; top:0; width:30px; height:28px; background: transparent url([tdr]wix_apps/add_new.png) no-repeat;}',"[state~=childrenNotAllowed] %addToParentBTN% { display:none }","%childTypesContainer% { position:absolute; top:45px; right:40px; padding:3px; background:#fff; [rdBigger] [shd] }","%childTypesContainer%:hover { border-color:#11a0ff; }","%childTypesContainer% li { min-width:150px; [rdBig] color:#3b3738; cursor:pointer; padding:2px 25px 4px 6px; }","%childTypesContainer% li:hover {  color:#fff; padding:2px 6px 4px 25px; border-color:#ccf; [noShd]background:#11a0ff url([tdr]wix_apps/edit.png) no-repeat; }","%editViewContainer% %listView% { position:absolute; top:71px; bottom:0; left:0; right:0; overflow-y:auto; overflow-x:hidden; margin-right:15px;border-right:1px solid #d8d8d8 }","[state~=queryView] %editViewContainer% %listView%{ top:51px; }","[state~=queryView] %editViewContainer% header { height:50px; }","[state~=queryView] %addToParentBTN% { top:10px; }",'[state~=emptyList] %noResultsMessage% {  font-size:24px; text-align:center; position:relative; top:180px; padding:0 180px; font-family:"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial,"Sans-Serif"; color:#373737; }',"%noRealNeed% {float:right;width:300px;}"])}),define.skin("wixapps.apps.playlist.editor.DataEditorItemSkin",function(a){var b=a;b.inherits("mobile.core.skins.BaseSkin"),b.compParts({inlineContent:{type:"htmlElement"}}),b.skinParams([{id:"rd",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"5px"},{id:"pos",type:Constants.SkinParamTypes.OTHER,defaultValue:"position:absolute; top:0; bottom:0; left:0; right:0;"},{id:"dragColor",type:Constants.SkinParamTypes.COLOR_ALPHA,defaultValue:"0,0,3,.5"},{id:"videoThumbBg",type:Constants.SkinParamTypes.BG_COLOR,mutators:["alpha",40],defaultValue:"#000",noshow:!0},{id:"videoThumbColor",type:Constants.SkinParamTypes.COLOR_ALPHA,mutators:["alpha",70],defaultValue:"#FFFFFF",noshow:!0},{id:"videoThumbCorners",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"7px",noshow:!0},{id:"tdr",type:Constants.SkinParamTypes.URL,defaultTheme:"BASE_THEME_DIRECTORY"}]),b.html('<div skinPart="inlineContent" class="toplevel"><div class="wrapper"><p class="itemToolTip">Drag to reorder, click to edit content</p></div></div>'),b.css(["{cursor:pointer; position:relative; }","%.toplevel% { width:100%;}","%.toplevel% > div { width:100%;}","%inlineContent% span {color:#999;}","%.wrapper% {[pos] background:[dragColor]; display:none;}","%.itemToolTip% { position:absolute; top:50%; left:42px; padding:0 30px 0 40px; font-size:12px; letter-spacing:1px; height:20px; line-height:20px; margin-top:-10px; color:#ddf; background:[dragColor]; [rd]}","%inlineContent% .headingGrey18 span { font-size:18px; font-weight:bold; color:#333; }","%inlineContent% .headingGrey18norm span { font-size:18px; font-weight:normal; color:#333; }","%inlineContent% .headingGrey16 span { font-size:16px; font-weight:normal; color:#333; }","%inlineContent% .textItalic14 span{ font-size:13px; font-style:italic; color:#808080; }","%inlineContent% .textGrey14 span{ font-size:14px; color:#808080; }","%inlineContent% .textItalic16 span{ font-size:16px; font-style:italic; color:#808080; }","%inlineContent% .headingGrey18 > * { font-size:18px; font-weight:bold; color:#333; }","%inlineContent% .headingGrey18norm > * { font-size:18px; font-weight:normal; color:#333; }","%inlineContent% .headingGrey16 > * { font-size:16px; font-weight:normal; color:#333; }","%inlineContent% .textItalic14 > * { font-size:13px; font-style:italic; color:#808080; }","%inlineContent% .textGrey14 > * { font-size:14px; color:#808080; }","%inlineContent% .textItalic16 > * { font-size:16px; font-style:italic; color:#808080; }","%inlineContent% span.typeName { color:#808080; }"," .singleLine { white-space:nowrap; display:block; overflow:hidden; text-overflow:ellipsis; word-wrap:normal; }"," .singleLine * {display:inline}",' .videoIndicator > div:before {content:""; position:absolute; top:50%; left:50%; margin-top:-15px; margin-left:-20px; width:40px; height:30px;[videoThumbBg][videoThumbCorners]  }',' .videoIndicator > div:after {content:""; position:absolute; top:50%; left:50%; width:0; height:0; margin-top:-10px; margin-left:-9px; border:10px solid transparent; border-left:18px solid [videoThumbColor] }',"[state=header] {background: rgb(253, 253, 253); padding:7px 12px 7px 20px; }","[state=header] %inlineContent% span {color:#333;}","[state=header] %inlineContent% > * {color:#333;}","[state=header] %inlineContent% span.typeName { color:#808080; }","[state=header]:hover { background:#e8f8fe }","[state=draggable] {padding:6px 0 6px 42px; border-bottom:solid 1px #dbdbdb; border-top:solid 1px #f4f5f5;}",'[state=draggable] %inlineContent%:before { content:""; position:absolute; left:15px; top:50%; margin-top:-14px; width:13px; height:28px; background:transparent url([tdr]wix_apps/menus_app_sprite.png) -147px -374px no-repeat; }',"[state=draggable]:hover {background-color:#e8f8fe;}",'[state=draggable]:hover %inlineContent%:after { content:""; position:absolute; right:10px; top:50%; margin-top:-15px; width:31px; height:30px; background:transparent url([tdr]wix_apps/edit.png) no-repeat; }',"[state=normal] {padding:6px 0 6px 42px; border-bottom:solid 1px #dbdbdb; border-top:solid 1px #f4f5f5;}","[state=normal]:hover {background-color:#e8f8fe;}",'[state=normal]:hover %inlineContent%:after { content:""; position:absolute; right:10px; top:50%; margin-top:-15px; width:31px; height:30px; background:transparent url([tdr]wix_apps/edit.png)no-repeat; }',"[state=dragged] { position:absolute; cursor:move; padding:6px 32px 6px 40px; outline:solid 2px #59a9fd; width:90%; margin:0 2px;background-color:#e8f8fe; opacity:0.8;}",'[state=dragged] %inlineContent%:before { content:""; position:absolute; left:13px; top:50%; margin-top:-14px; width:13px; height:28px; background:transparent url([tdr]wix_apps/edit.png) -147px -374px no-repeat; }'])}),define.skin("wixapps.apps.playlist.editor.DataItemEditorDialogSkin",function(a){var b=a;b.inherits("mobile.core.skins.BaseSkin"),b.compParts({addToBtn:{skin:"wysiwyg.editor.skins.buttons.ButtonBaseSkin"}}),b.skinParams([{id:"pos",type:Constants.SkinParamTypes.OTHER,defaultValue:"position:absolute; top:0; bottom:0; left:0; right:0;"},{id:"rd",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"3px"},{id:"shd",type:Constants.SkinParamTypes.BOX_SHADOW,defaultValue:"1px 1px 5px 1px rgba(0, 0, 0, 0.1);"},{id:"videoThumbBg",type:Constants.SkinParamTypes.BG_COLOR,mutators:["alpha",40],defaultValue:"#000",noshow:!0},{id:"videoThumbColor",type:Constants.SkinParamTypes.COLOR_ALPHA,mutators:["alpha",70],defaultValue:"#FFFFFF",noshow:!0},{id:"videoThumbCorners",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"7px",noshow:!0},{id:"tdr",type:Constants.SkinParamTypes.URL,defaultTheme:"BASE_THEME_DIRECTORY"}]),b.html('<div skinPart="editViewContainer"></div><section class="locationsMenu"><h5>Appears in:</h5><ul skinPart="editRefContainer"></ul><button skinPart="addToBtn"></button><div skinPart="locationDivContainer"><div skinPart="addToHeader"><button skinPart="cancelAddTo"></button></div><div skinPart="addToLocationDiv"></div></div></section>'),b.css(["{background:#ddf0fe; [rd]; margin-top:10px; }"," .singleLine { white-space:nowrap; display:block; overflow:hidden; text-overflow:ellipsis; word-wrap:normal; }",' .videoIndicator > div:before {content:""; position:absolute; top:50%; left:50%; margin-top:-15px; margin-left:-20px; width:40px; height:30px;[videoThumbBg][videoThumbCorners]  }',' .videoIndicator > div:after {content:""; position:absolute; top:50%; left:50%; width:0; height:0; margin-top:-10px; margin-left:-9px; border:10px solid transparent; border-left:18px solid [videoThumbColor] }',"%editViewContainer% {padding-right:12px; margin-right:360px;}","%.locationsMenu% {position:absolute; top:65px; bottom:70px; right:28px; width:340px; border-left:solid 1px #e3e3e3; padding-left:18px;}","%.locationsMenu% h5 {font-weight:normal; font-size:14px; color:#7f7f7f; margin:0 0 6px 6px;}","%editRefContainer% {list-style:none}","%.locationsMenu% .itemParent { height:34px; background:#0071bd; margin-bottom:3px; position:relative; [rd] overflow:hidden; white-space:nowrap; text-overflow:ellipsis;}","%.locationsMenu% .itemParent p {line-height:34px; color:#fff; font-weight:bold;  position:absolute; left:12px; right:30px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;}","%.locationsMenu% .parentDelete {width:22px; height:22px; margin:6px 6px 0 0; background:#0071bd url([tdr]wix_apps/menus_app_sprite.png) -142px -575px no-repeat; float:right; [rd]}","%.locationsMenu% .parentDelete:hover {background:#e3e3e3 url([tdr]wix_apps/menus_app_sprite.png) -142px -625px no-repeat; cursor:pointer;}","%locationDivContainer% {position: absolute; z-index: 9999 !important; width:100%; background:#fff; border: solid 1px #e3e3e3; color:#4b4b4b; [shd]}","%locationDivContainer% li > p { line-height:26px; padding:0 20px 0 40px; cursor:pointer; font-weight:bold;overflow:hidden; white-space:nowrap; text-overflow:ellipsis;}","%addToLocationDiv% > ul {padding:7px 0;}","%locationDivContainer% ul li ul li p {padding-left:52px; font-weight:normal;}","%locationDivContainer% li > p:hover {background:#a9e0ff;}","%locationDivContainer% li > p.currentParent {background:transparent url([tdr]wix_apps/menus_app_sprite.png) -125px -675px no-repeat; cursor:default; color:#bbb;}","%locationDivContainer% li li > .currentParent {background:transparent url([tdr]wix_apps/menus_app_sprite.png) -112px -675px no-repeat; cursor:default; color:#bbb;}","%locationDivContainer% li > p.nonPossibleParent {background:transparent; cursor:default; color:#bbb;}","%addToBtn% {width:50%;}",'%editRefContainer%:after {content: ""; position:absolute; top:0; bottom:0; left:0; border-left:solid 1px #fff;}',"%addToHeader% {line-height:34px; background:transparent url([tdr]wix_apps/menus_app_sprite.png) center -1886px repeat-x; color:#4d4d4d; font-weight:bold; padding:0 0 0 12px; outline:solid 1px #c4c4c4;}","%cancelAddTo% {width:22px; height:22px; margin:6px 6px 0 0; background:transparent url([tdr]wix_apps/menus_app_sprite.png) -142px -625px no-repeat; float:right; border:none; [rd]}","[state=parentNonEditable] %.locationsMenu% {display:none;}","[state=parentNonEditable] %editViewContainer% {padding-right:0; margin-right:0;}","[state=parentNonEditable] :not(.textAreaOverrideHeight) > textarea {height:250px;}","%editViewContainer% .labelStyle span {display:block; color:#818181; font-size:14px; padding:2px 0 4px 5px; font-weight:normal;}","%editViewContainer% .labelStyle p {display:block; color:#818181; font-size:14px; padding:2px 0 4px 5px; font-weight:normal;}","%noRealNeed% {float:right;width:300px;}"])
}),define.Class("wixapps.apps.pricelists.PriceListLogic",function(a){var b=a;b.inherits("wixapps.core.logics.SingleItemLogic"),b.methods({generateDataSelectorPanel:function(a,b,c){this._panel=a,this._partData=b,this._environment.getDataService().query("PriceLists",null,{title:1},null,null,!1,function(b){var d;if(0===b.length)a.addTitle("No price lists found"),d="Create a new price list";else{a.addLabel("Pick which price list or price list section you'd like to appear and click OK.");var e=this._createCategoryTreeData(b),f=a.addComboBoxField("",e);if(f.addEvent("inputChanged",function(a){this._changeSelectedCategory(a.value)}.bind(this)),c.collectionId&&c.itemId){for(var g=c.collectionId+"/"+c.itemId,h=-1,i=0;i<e.length;i++)if(e[i].value==g){h=i;break}-1!=h?f.setValue(g):e.length>0&&this._changeSelectedCategory(e[0].value)}d="No thanks, I'd like to create a new price list"}var j=a.addButtonField(null,d,null,null,"withArrow");j.addEvent(Constants.CoreEvents.CLICK,function(){this._createNewListAndSelect()}.bind(this))}.bind(this))},_createNewListAndSelect:function(){var a=this._panel.injects();if(a.Config.siteNeverSavedBefore())a.EditorDialogs.openWixAppsSiteMustBeSaved();else{var b=this.getDataEditingModel().getItemTemplate("PriceList",!0);b.getChildByRef("title").setValue("New Price List"),this._environment.getDataService().createItem("PriceLists",b,function(b){this._changeSelectedCategory("PriceLists/"+b.getChildValue("_iid")),this._panel._dialogWindow.closeDialog(),a.Commands.executeCommand("WAppsEditorCommands.OpenEditDataDialog",{selectedComp:this._environment.getAppPart()})}.bind(this),function(b){a.EditorDialogs.openErrorDialog("Error creating new price list","Please try again in a few minutes",b.code+"\n"+b.description,null)}.bind(this))}},_changeSelectedCategory:function(a){var b=this._partData.get("appLogicParams"),c=a.split("/")[0],d=a.split("/")[1];b.itemId={type:"AppPartParam",value:d},b.collectionId={type:"AppPartParam",value:c},this._partData.fireDataChangeEvent()},_createCategoryTreeData:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].getValue();b.push({value:"PriceLists/"+d._iid,label:d.title});for(var e=a[c].getChildByRef("items").getChildren(),f=0;f<e.length;f++){var g=e[f];"Section"==g.getTypeName()&&b.push({value:"Sections/"+g.getChildValue("_iid"),label:" - "+g.getValue().title})}}return b},getSelectedIId:function(a,b){return b.itemId},getDataEditingMetaInfo:function(){var a=(this._environment.getAppInstance(),this._environment.getAppPart().getPartDef().name),b=this._logicParams?this._environment.getDataService().deReference(this._logicParams.collectionId,this._logicParams.itemId):null;return b&&(a=a+" - "+b.getChildValue("title")),{title:a,hasDataEdit:!0,hasDataSelection:!0,dataSelectionLabel:"Choose Price List",dataEditingLabel:"Edit Price List"}}})}),window.modifier={id:"e4c4a4fb-673d-493a-9ef1-6ccfa3823ad7",packageName:"accommodation",name:"Accommodation",parts:[{id:"1660c5f3-3383-4e6c-a873-5d6bbd918224",name:"Accommodation",description:"Make awesome price list for your accommodation",widgetIcon:"images/menu-icon.png",pictures:[],defaultWidth:400,defaultHeight:100,logic:{display:{type:"wixapps.apps.pricelists.PriceListLogic",options:{collectionId:"PriceLists",itemId:"SamplePriceList1"}},seo:{type:"SingleItem",options:{collectionId:"PriceLists",itemId:"SamplePriceList1"}}},views:["Center","Left","Inline","LeftImage","LeftThumb","Gallery"]}]},window.modifier={id:"e4c4a4fb-673d-565a-9ef1-6ccfa3823ad7",packageName:"classes",name:"Classes"},window.modifier={id:"e4c4a4fb-673d-493a-9ef1-6ccfa3823ad7",packageName:"clothes",name:"Clothes"},window.modifier={id:"e4c4a4fb-673d-493a-9ef1-6ccfa3823ad7",packageName:"grocery",name:"Grocery"},window.modifier={id:"e4c4a4fb-673d-493a-9ef1-6ccfa3823ad7",packageName:"salon",name:"Salon"},define.Class("wixapps.apps.rssfeed.GoogleFeed",function(a){var b=a;b.resources(["scriptLoader"]),b.binds(["_feedsLoaded"]),b.methods({initialize:function(a){this._readyCallback=a;var b={id:"googleJsApi",url:"https://www.google.com/jsapi",usePlugin:"external"};this.resources.scriptLoader.loadResource(b,this)},onLoad:function(){window.google.load("feeds","1",{callback:this._feedsLoaded})},onFailed:function(){},_feedsLoaded:function(){this._readyCallback&&this._readyCallback()}})}),define.Class("wixapps.apps.rssfeed.RssLogic",function(a){var b=a;b.inherits("wixapps.core.logics.CategoryLogic"),b.binds(["feedsApiLoaded","_createView","_markRichContentElements"]),b.utilize(["wixapps.apps.rssfeed.GoogleFeed"]),b.fields({_googleApiLoaded:!1}),b.methods({initialize:function(a){this._environment=a,this._localizer=this._environment.getAppInstance().getLocalizer(),this._feeds=new this.imports.GoogleFeed(this.feedsApiLoaded),this._errorMessage=null},generateDataSelectorPanel:function(a){var b=a.addInputField(this._localizer.localize("DATA_SELECTION_PANEL_FEED_URL_INPUT_LABEL")+":","http://feeds.feedburner.com/TheOfficialWixBlog");null===this._logicParams.feedUrl||void 0===this._logicParams.feedUrl?b.setValue("http://feeds.feedburner.com/TheOfficialWixBlog"):b.setValue(this._logicParams.feedUrl),b.addEvent(Constants.CoreEvents.KEY_UP,function(){null!==this._errorMessage&&this._clearErrorMessage()}.bind(this));var c=this;a._dialogWindow.setCloseCallBack(function(d){return"OK"===d.result?(c._logicParams.feedUrl=b.getValue(),c._setCurrentFeedUrl(c._logicParams.feedUrl),c._getFeedEntries(function(b){null===b?c._showErrorNotification(a,c._localizer.localize("DATA_SELECTION_PANEL_UPDATE_ERROR_LABEL")):(c._createView(b),a._dialogWindow.closeDialog())}),!1):void 0})},run:function(a,b,c){this._viewName=a,this._callBacks=c,this._logicParams=b,this._getFeedEntries(this._createView)},feedsApiLoaded:function(){this._googleApiLoaded=!0,this._getFeedEntries(this._createView)},_getAppPartData:function(){return this._environment.getAppPart()&&this._environment.getAppPart().getDataItem()},_setCurrentFeedUrl:function(a){var b=this._getAppPartData();if(b){var c=b.get("appLogicParams"),d={};d=Object.merge(d,b._data),c.feedUrl={type:"AppPartParam",value:a},c.feedCollection={type:"AppPartParam",value:JSON.stringify([])};var e={};e=Object.merge(e,b._data),b.fireDataChangeEvent(void 0,e,d)}},_createView:function(a){if(null!==a){var b=this._environment,c=b.getTypesManager();c.applyDefaults(a),this._callBacks.showView(a,this._viewName)}},_markRichContentElements:function(a){var b=[];if(b.push(a.getElementsByTagName("Img")),b.push(a.getElementsByTagName("iframe")),b.push(a.getElementsByTagName("object")),b.push(a.getElementsByTagName("embed")),b.push(a.getElementsByTagName("table")),b)for(var c=0;c<b.length;c++){var d=b[c];if(d)for(var e=0;e<d.length;e++)d[e].setAttribute("richContent","true"),d[e].style.maxWidth="100%"}},_getFeedEntries:function(a){if(this._googleApiLoaded){var b=this._logicParams.feedUrl,c=new window.google.feeds.Feed(b);c.setNumEntries(25);var d=this;return c.load(function(c){if(c.error)a(null);else{for(var e={_type:"Feed",title:c.feed.title,description:c.feed.description,feedItems:[]},f=0;f<c.feed.entries.length;f++){var g=c.feed.entries[f],h=new Element("div");h.innerHTML=g.content,d._markRichContentElements(h);var i={_type:"FeedItem",title:g.title,link:{_type:"wix:LinkBase"},content:h.innerHTML,contentAsText:h.get("text"),contentSnippet:g.contentSnippet,publishDate:g.publishedDate,imagesList:[],hasImages:!1,feedUniqueId:b+"|"+g.link};if(g.link){var j=g.link.split("://");j.length&&(i.link={_type:"wix:ExternalLink",address:1===j.length?j[0]:j[1],target:"_blank",protocol:1===j.length?"http":j[0],linkId:""})}var k=h.getElements("img");if(void 0!==k&&null!==k)for(var l=0;l<k.length;l++){var m=k[l];i.imagesList.push({_type:"wix:Image",src:m.src,width:m.getWidth(),height:m.getHeight()}),i.hasImages=!0}e.feedItems.push(i)}var n=d._environment,o=n.getAppInstance().getItemCache(),p=o.get(b);p?p.setValue(e):p=o.put(b,e),a(p)}})}},_clearErrorMessage:function(){this._errorMessage.dispose(),this._errorMessage=null},_showErrorNotification:function(a){null!==this._errorMessage&&this._clearErrorMessage(),this._errorMessage=a.addLabel(this._localizer.localize("DATA_SELECTION_PANEL_UPDATE_ERROR_LABEL"),{color:"red"})},getLastTenItemsZoomParams:function(a,b,c,d){this._getLastTenItems(a,function(a){if(null!==a){d="title",c="feedUniqueId";var e=a.getChildValue("feedItems");if(e){0===e.length&&b({list:[],selectedIndex:0});var f=(e[0][c],e.map(function(a){return{id:a[c],title:a[d]}})),g=0;b({list:f,selectedIndex:g})}}})},_getLastTenItems:function(a,b){var c=this._environment.getItemCache(),d=c.get(this._logicParams.feedUrl);return d?(b(d),void 0):(this._getFeedEntries(function(a){null!==a&&b(a)}),void 0)},getDataEditingMetaInfo:function(){var a=this._environment.getAppInstance(),b=a.getDescriptorValue(["dataEditing","dataSelectionLabel"])||"Choose Category",c=(a.getDescriptorValue(["dataEditing","dataEditingLabel"])||"Edit Data",this._environment.getAppPart().getPartDef().name),d=this._logicParams?this._environment.getDataService().deReference(this._logicParams.collectionId,this._logicParams.itemId):null;return d&&(c=c+" - "+d.getChildValue("title"),c.length>35&&(c=c.substr(0,35)+"...")),{title:c,zoomOpenerLabel:this._localizer.localize("ZOOM_OPENER_BUTTON_LABEL"),hasDataEdit:!1,hasDataSelection:!0,dataSelectionLabel:b}}})}),define.Class("wixapps.apps.rssfeed.RssZoomLogic",function(a){var b=a;b.fields({_environment:null}),b.methods({initialize:function(a){this._environment=a},run:function(a,b,c){this._viewName=a,this._callBacks=c,this._logicParams=b;{var d=this._environment.getTypesManager(),e=this._environment.getDataItemFactory(),f=this._environment.getProxyFactory();f.createView(e.createDataItem({}),"Loading")}c.showLoadingIndicator();var g=this._logicParams.itemId.split("|")[0],h=this._logicParams.itemId.split("|")[1];this._getFeedItem(g,h,function(a){d.applyDefaults(a),c.hideLoadingIndicator(),c.showView(a,this._viewName)}.bind(this))},_getFeedItem:function(a,b,c){var d=this._environment.getAppInstance().getItemCache(),e=d.get(a);if(e){var f=e.getValue(),g=f.feedItems.map(function(a){return a.link.address==b.split("://")[1]}).indexOf(!0);if(g>-1){var h=e.getChildByRef("feedItems").getChildByIndex(g);return c(h),void 0}}c(this._environment.getDataItemFactory().createDataItem({_type:"FeedItem",title:"Need to implement this"}))},_getLastTenItems:function(a,b){var c=["one","two","three"];b(c)}})}),define.Class("wixapps.apps.simplephotos.SimplePhotosLogic",function(a){var b=a;b.inherits("wixapps.core.logics.LogicBase"),b.binds(["onSuccess","onFailure"]),b.fields({_environment:null,_logicParams:null}),b.methods({initialize:function(a){this._environment=a},run:function(a,b,c){this._environment;this._viewName=a,this._callBacks=c,this._logicParams=b;var d=b.tagId,e=b.tagName,f=this._getParamsFromURL();if(f.tagId&&(d=f.tagId[0],e=f.tagName[0],this._logicParams.tagId=d,this._logicParams.tagName=e),!d||!e)return this.onFailure({description:"'tagId' and 'tagName' should be defined",code:-1}),void 0;var g=(this.injects().Config,this.injects().Config.getMediaStaticUrl());g=g.replace("/media/","/tags/"),g=g.replace("static.","media."),g="http://media.wix.com/tags/";var h=g+d+".json";this._sendJsonCORSWide(h,null,"get",this.onSuccess)},onSuccess:function(a,b){for(var c=this._environment,d=c.getDataItemFactory(),e=c.getTypesManager(),f=(c.getProxyFactory(),{_type:"Category",title:this._logicParams.tagName,images:[]}),g=0;g<b.mediaItems.length;g++){var h={_type:"Image",title:b.mediaItems[g].originalFileName,image:{_type:"wix:Image",src:b.mediaItems[g].fileName,width:b.mediaItems[g].width,height:b.mediaItems[g].height}};f.images.push(h)}var i=d.createDataItem(f);e.applyDefaults(i),this._callBacks.showView(i,this._viewName)},onFailure:function(a){this._showError(this._callBacks,a)},getDataEditingModel:function(){return new this.imports.DescriptorDataEditingModel(this._environment)},getDataEditingMetaInfo:function(){return{title:"Simple Photos",hasDataSelection:!0,dataSelectionLabel:"Choose tag",dataEditingLabel:"",hasDataEdit:!1}},generateDataSelectorPanel:function(a,b){var c=this._createCategoryListData(["gaga","baga"]),d=a.addComboBoxField("",c);d.addEvent("inputChanged",function(a){this._changeSelectedCategory(b,a.value)}.bind(this))},_changeSelectedCategory:function(){},_createCategoryListData:function(a){for(var b,c="zagzga",d=[],e=0;e<a.length;e++)b=a[e],d.push({value:c+"/"+b,label:b});return d},_getLastTenItems:function(a,b){var c=this.getDataEditingModel().getItemDefaultCollection(a);this.getDataEditingModel().getDataService().query(c,{_type:a},{_updatedAt:-1},0,10,!1,b)},_showLoading:function(a){a.showLoadingIndicator()},_showError:function(a,b){a.showErrorIndicator(b.code,b.description)}})});