define.activity.definitionModifier=function(a,b,c){define.Class(a,c),resource.getResources(["W.Commands","W.TPA"],function(c){Array.each(b,function(b){c.W.Commands.executeCommand("WViewerCommands.Activity.Register",{name:b,className:a})})})},define.Class("tpa.viewer.classes.Activity",function(a){a.resources(["W.Utils","W.Config"]),a.utilize(["core.managers.serverfacade.RESTClient"]),a.binds(["_activityIdHandler","_hsHandler","_svSessionHandler","_metasiteIdHandler","_activityTypeHandler","_activityInfoHandler","_contactUpdateHandler","_activityDetailsHandler"]),a.statics({API_HUB_PATH:"/_api/app-integration-bus-web/v1/activities"}),a.methods({initialize:function(a,b,c){this._fields=a,this._callbacks=b||{},this._type=c||"",this._paramsHandlers={},this._requestParamsHandlers={};var d=this.imports.RESTClient;this._restClient=new d,this.setRequestParamHandler("activity-id",this._activityIdHandler),this.setRequestParamHandler("metasite-id",this._metasiteIdHandler),this.setRequestParamHandler("hs",this._hsHandler),this.setRequestParamHandler("svSession",this._svSessionHandler),this.setRequestParamHandler("version",this._versionHandler),this.setParamHandler("createdAt",this._dateTimeHandler),this.setParamHandler("activityType",this._activityTypeHandler),this.setParamHandler("activityLocationUrl",this._activityLocationUrlHandler),this.setParamHandler("activityDetails",this._activityDetailsHandler),this.setParamHandler("activityInfo",this._activityInfoHandler),this.setParamHandler("contactUpdate",this._contactUpdateHandler)},report:function(){var a={payload:{},params:{}},b=this;Object.keys(this._paramsHandlers).forEach(function(c){a.payload[c]=b._paramsHandlers[c]()}),Object.keys(this._requestParamsHandlers).forEach(function(c){a.params[c]=b._requestParamsHandlers[c]()}),this._send(a)},_send:function(a){var b=this._getQuery(a.params),c="http://wix.com";try{c="http://"+window.publicModel.externalBaseUrl.split("/")[2]}catch(d){}c+=this.API_HUB_PATH,this._restClient.responseCallback=function(a,b){"success"===a?this._callbacks.onSuccess&&this._callbacks.onSuccess(b):this._callbacks.onError&&this._callbacks.onError(b)}.bind(this),this._restClient.post(c+b,a.payload,{})},_getQuery:function(a){var b=[];return Object.keys(a).forEach(function(c){b.push(c+"="+a[c])}),"?"+b.join("&")},setParamHandler:function(a,b){a&&b&&(this._paramsHandlers[a]=b)},setRequestParamHandler:function(a,b){a&&b&&(this._requestParamsHandlers[a]=b)},_metasiteIdHandler:function(){return this.resources.W.Config.getMetaSiteId()},_hsHandler:function(){return this.resources.W.Config.getHS()},_svSessionHandler:function(){var a=this.resources.W.Config.getSvSession();return"NO_SV"===a&&(a=this._getSvFromCookie()),a},_dateTimeHandler:function(){return(new Date).toISOString()},_activityTypeHandler:function(){return"activityType"},_activityInfoHandler:function(){return"activityInfo"},_contactUpdateHandler:function(){return{}},_activityIdHandler:function(){return this.resources.W.Utils.getGUID()},_createdAtHandler:function(){return(new Date).toISOString()},_activityLocationUrlHandler:function(){return location.href},_activityDetailsHandler:function(){return{additionalInfoUrl:null,summary:""}},_versionHandler:function(){return"1.0.0"}})}),define.Class("tpa.viewer.classes.ClientSpecMapLoader",function(a){var b=a;b.resources(["scriptLoader"]),b.binds(["_handleTimeout","_handleAjaxSuccess","_handleAjaxError"]),b.statics({DEFAULT_TIMEOUT:1e3,DEFAULT_MAX_AJAX_RETRIES:1}),b.methods({initialize:function(a,b,c){c=c||{},this._timeout=_.isNumber(c.timeout)?c.timeout:this.DEFAULT_TIMEOUT,this._maxAjaxRetries=_.isNumber(c.maxAjaxRetries)?c.maxAjaxRetries:this.DEFAULT_MAX_AJAX_RETRIES,this._baseUrl=c.baseUrl||window.publicModel.externalBaseUrl,this._scriptLoader=c.scriptLoader||this.resources.scriptLoader,this._successCallback=_.once(a),this._errorCallback=_.once(b),this._currentAjaxAttemptNumber=null,this._url=this._getDynamicModelApiUrl()},_getTimeForPerformance:function(){return window.performance&&"function"==typeof window.performance.now?Math.floor(window.performance.now()):new Date},_handleTimeout:function(){this._errorCallback(new Error("Timed out"))},_handleAjaxSuccess:function(a,b){clearTimeout(this._timeoutId),this._successCallback(b)},_handleAjaxError:function(a,b){this._currentAjaxAttemptNumber<=this._maxAjaxRetries?(this._currentAjaxAttemptNumber++,this._performAjaxCall()):(clearTimeout(this._timeoutId),this._errorCallback(b))},_extractHeaders:function(a){var b={};try{b.seen=a.getResponseHeader("X-Seen-By"),b.server=a.getResponseHeader("Server")}catch(c){}return b},loadClientSpecMap:function(){this._startTime=this._getTimeForPerformance(),this._timeoutId=setTimeout(this._handleTimeout,this._timeout),this._currentAjaxAttemptNumber=1,this._performAjaxCall()},_performAjaxCall:function(){this._scriptLoader.getUrl(this._url,this._handleAjaxSuccess,this._handleAjaxError,"json")},_getDynamicModelApiUrl:function(){var a=this._baseUrl;return"/"!==a.charAt(a.length-1)&&(a+="/"),a+="_api/dynamicmodel"}})}),define.activity("tpa.viewer.classes.CotactFormActivity",["ContactForm"],function(a){a.inherits("tpa.viewer.classes.Activity"),a.methods({initialize:function(a,b){this.parent(a,b),this.setRequestParamHandler("component-name",this._componentNameHandler)},_activityTypeHandler:function(){return"contact/contact-form"},_componentNameHandler:function(){return"ContactForm"},_activityInfoHandler:function(){var a={fields:[]},b=this;return Object.keys(this._fields).forEach(function(c){a.fields.push({name:c,value:b._fields[c]})}),a},_contactUpdateHandler:function(){var a={name:{first:"",last:""},emails:[{tag:"main",email:""}]};this._fields.name||(this._fields.name="");var b=this._fields.name.split(" ");return a.name.first=b[0],a.name.last=b[1],a.emails[0].email=this._fields.email,a},_activityDetailsHandler:function(){var a="No message was received";return(this._fields.subject||this._fields.message)&&(a="<strong>"+this._fields.subject+"</strong>"||"",a+=a&&this._fields.message?"<br>":"",a+=this._fields.message||""),{additionalInfoUrl:null,summary:a}}})}),define.Class("tpa.viewer.classes.PixelTracker",function(a){var b=a;b.utilize(["tpa.common.managers.UrlBuilderBase"]),b.methods({initialize:function(a,b){b=b||{},this._chunkSize=b.chunkSize||1,this._chunkInterval=b.chunkInterval||100,this._uniqueCounter=0,this._urlBuilders=this._getUrlBuilders(a),this._saveRequests=window.location.search.test(/[&?]savePixelRequests(=(true)?)?(&|$)/i)},_getCacheKillerString:function(){return(+new Date).toString(36)+(this._uniqueCounter++).toString(36)},_throttledForEach:function(a,b,c,d){!function e(){a.splice(0,c).forEach(b),a.length&&setTimeout(e,d)}()},_sendRequest:function(a){this._saveRequests&&(window._pixelRequests=window._pixelRequests||[],window._pixelRequests.push(a)),new Image(0,0).src=a},_getCurrentPage:function(){return window.location.href},_getUrls:function(){return _.invoke(this._urlBuilders,"build")},_sendPixelTrackerRequests:function(){var a=this._getUrls();this._throttledForEach(a,this._sendRequest.bind(this),this._chunkSize,this._chunkInterval)},_getUrlBuilders:function(a){return _(a).filter("pixelUrl").filter("installedAtDashboard").map(function(a){return(new this.imports.UrlBuilderBase).setBaseUrl(a.pixelUrl).setParam("instance",a.instance).setParam("page",this._getCurrentPage).setParam("ck",this._getCacheKillerString)},this).value()}})}),define.activity("tpa.viewer.classes.PlaylistActivity",["Playlist"],function(a){a.inherits("tpa.viewer.classes.Activity"),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this._name="musicPlayer",this.setRequestParamHandler("component-name",this._componentNameHandler)},_activityTypeHandler:function(){return this._type},_sourceIdHandler:function(){return this._name},_componentNameHandler:function(){return this._name},_activityInfoHandler:function(){var a=this._fields;return a}})}),define.activity("tpa.viewer.classes.SubscribeFormActivity",["SubscribeForm"],function(a){a.inherits("tpa.viewer.classes.Activity"),a.methods({initialize:function(a,b){this.parent(a,b),this.setRequestParamHandler("component-name",this._componentNameHandler)},_activityTypeHandler:function(){return"contact/contact-form"},_sourceIdHandler:function(){return"SubscribeForm"},_componentNameHandler:function(){return"subscribeForm"},_activityInfoHandler:function(){var a={fields:[]},b=this;return Object.keys(this._fields).forEach(function(c){a.fields.push({name:c,value:b._fields[c]})}),a},_contactUpdateHandler:function(){return{name:{first:this._fields.first||"",last:this._fields.last||""},emails:[{tag:"main",email:this._fields.email||""}],phones:this._fields.phone?[{tag:"main",phone:this._fields.phone||""}]:[],emailSubscriptionPolicy:"RECURRING"}}})}),define.activity("tpa.viewer.classes.TPAActivity",["TPA"],function(a){a.inherits("tpa.viewer.classes.Activity"),a.binds(["_instanceHandler","_applicationIdHandler"]),a.methods({initialize:function(a,b){this.parent(a,b),this.setRequestParamHandler("instance",this._instanceHandler),this.setRequestParamHandler("application-id",this._applicationIdHandler)},_activityTypeHandler:function(){return this._fields.type},_sourceIdHandler:function(){return this._fields.appDefinitionId},_activityInfoHandler:function(){return this._fields.info},_contactUpdateHandler:function(){return this._fields.contactUpdate},_additionalInfoUrlHandler:function(){return this._fields.url||null},_instanceHandler:function(){return this._fields.instance},_applicationIdHandler:function(){return this._fields.appDefinitionId}})}),define.Class("tpa.viewer.classes.TPAWorker",function(a){a.statics({WIDTH:1,HEIGHT:1,TOP:0,LEFT:0}),a.resources(["W.Viewer","W.TPA","W.Config"]),a.traits(["tpa.viewer.traits.TPAHandlersViewerCommons","tpa.common.traits.TPAHandlersCommons"]),a.utilize(["tpa.common.managers.UrlBuilder"]),a.methods({initialize:function(a){return this._data=a,this._viewMode="site",this._compId=_.uniqueId("worker_"),this._appDefinitionId=a.appDefinitionId,this._createIframe()},_createIframe:function(){var a=this._buildIframeUrl();return this._iframe=document.createElement("iframe"),this._iframe.setStyles({width:this.WIDTH,height:this.HEIGHT,top:this.TOP,left:this.LEFT,display:"none"}),this._iframe.setAttribute("src",a),this._iframe},_getBaseUrl:function(){return this._data.appWorkerUrl},_buildIframeUrl:function(){return new this.imports.UrlBuilder(this._getBaseUrl(),this).addCacheKiller().addCompId().addDeviceType().addInstance().addLocale().addViewMode().addEndpointType("worker").build()},getIFrame:function(){return this._iframe},attachTo:function(a){a&&a.appendChild(this._iframe)},getAppData:function(){return this._data},getComponentId:function(){return this._compId},getAppDefinitionId:function(){return this._appDefinitionId},isAppOnPage:function(){return!0},isUnderMobileView:function(){var a=this.resources.W.Config.env,b=a.isViewingSecondaryDevice();return b},addDisposeHandler:function(){},isPubSubMsg:function(a){return _.has(a,"msgData")?0===a.msgData.eventKey.indexOf(this.TPA_PUB_SUB_PREFIX):void 0},handleAppIsAlive:function(){this.setAppIsAlive()},setAppIsAlive:function(){this._appIsAlive=!0},getViewer:function(){return this.resources.W.Viewer}})}),define.component("tpa.viewer.components.Accordion",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{allInputsHidden:!0}},indexName:"Accordion",isTpa:!1}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this.styleProps={textColor:"color1",descriptionColor:"color2",textBackgroundColor:"color3",borderColor:"color4"}}})}),define.component("tpa.viewer.components.Collage",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.traits(["tpa.viewer.traits.TPAFullWidthComponent"]),a.propertiesSchemaType("CollageProperties"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"Collage",isTpa:!1,delayedChangeProps:{numCols:600,margin:600}}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this.styleProps={textColor:"color1",descriptionColor:"color2",backgroundMouseoverColor:"color3"}},_onIframeLoad:function(){var a=this.getComponentProperties();a.get("fitToScreenWidth")?this.initFullWidthContainer():this.destroyFullWidthContainer(),this.parent()},_onDataChange:function(a,b){"fitToScreenWidth"===b&&(a.get("fitToScreenWidth")?this.initFullWidthContainer():this.destroyFullWidthContainer()),this.parent(a,b)},_onBeforePostMessage:function(a){a.props.maxImageSize>a.props.numOfCells&&(a.props.maxImageSize=a.props.numOfCells),a.props.minImageSize>a.props.maxImageSize?a.props.minImageSize=a.props.maxImageSize:a.props.maxImageSize<a.props.minImageSize&&(a.props.maxImageSize=a.props.minImageSize),this.parent(a)}})}),define.component("tpa.viewer.components.Freestyle",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.propertiesSchemaType("FreestyleProperties"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"Freestyle",isTpa:!1,delayedChangeProps:{numCols:600,margin:600}}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this.styleProps={borderColor:"color1"}}})}),define.component("tpa.viewer.components.Honeycomb",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.propertiesSchemaType("HoneycombProperties"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"Honeycomb",isTpa:!1,delayedChangeProps:{numCols:600,margin:600}}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this.styleProps={textColor:"color1",descriptionColor:"color2",textBackgroundColor:"color3",backgroundMouseoverColor:"color4",holesColor:"color5"}}})}),define.component("tpa.viewer.components.Impress",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}]},indexName:"Impress",isTpa:!1}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this.styleProps={bcgColor1:"color1",bcgColor2:"color2",bcgColor3:"color3",bcgColor4:"color4",bcgColor5:"color5",textColor:"color6",descriptionColor:"color7",textBackgroundColor:"color8"}}})}),define.component("tpa.viewer.components.Masonry",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.propertiesSchemaType("MasonryProperties"),a.resources(["W.Experiments"]),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"Masonry",isTpa:!1,delayedChangeProps:{numCols:600,margin:600}}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this.styleProps={textColor:"color1",descriptionColor:"color2",textBackgroundColor:"color3",backgroundMouseoverColor:"color4",textButtonColor:"color5"}},_onAllSkinPartsReady:function(){this.handlePhase1Style(),this.parent()},handlePhase1Style:function(){var a=this._style.getProperty("version");"1"===a&&(this._style.changePropertySource("version","2","value"),this._style.changePropertySource("color1","#000000","value"),this._style.changePropertySource("color2","#000000","value"),this._style.changePropertySource("color3","#ffffff","value"),this._style.changePropertySource("color4","#000000","value"),this._style.setPropertyExtraParamValue("color4","alpha",.4,!0))}})}),define.component("tpa.viewer.components.StripShowcase",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.traits(["tpa.viewer.traits.TPAFullWidthComponent"]),a.propertiesSchemaType("StripShowcaseProperties"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"StripShowcase",isTpa:!1}),a.methods({initialize:function(a,b,c){this.initFullWidthContainer(),this.parent(a,b,c)},isHorizResizable:function(){return!1}})}),define.component("tpa.viewer.components.StripSlideshow",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.propertiesSchemaType("StripSlideshowProperties"),a.traits(["tpa.viewer.traits.TPAFullWidthComponent"]),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"StripSlideshow",isTpa:!1}),a.methods({initialize:function(a,b,c){this.initFullWidthContainer(),this.parent(a,b,c),this.styleProps={titleColor:"color1",descriptionColor:"color2",backgroundColor:"color3"}}})}),define.component("tpa.viewer.components.TPA3DCarousel",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.propertiesSchemaType("SlideShowGalleryProperties"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"TPA3DGallery"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"Carousel",isTpa:!1}),a.methods({})}),define.component("tpa.viewer.components.TPA3DGallery",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.propertiesSchemaType("SlideShowGalleryProperties"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"TPA3DGallery"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"Slicebox",isTpa:!1}),a.methods({})}),define.component("tpa.viewer.components.TPAComponent",function(a){var b=a;b.inherits("tpa.viewer.components.TPAViewerBase"),b.resources(["W.Events"]),b.binds(["_postMessageToIframe"]),b.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1}},isTpa:!1,externalHtmlPath:"TPAComponent.html",delayedChangeProps:{},DEFAULT_THROTTLE_TIME:150}),b.methods({initialize:function(a,b,c){c=c||{},this.parent(a,b,c)},_hasExtensions:function(){return!1},_onDataChange:function(a,b){if(this._skinParts){if(void 0!==this._propertiesSchemaName&&a._dataType===this._propertiesSchemaName)return this._sendPropertiesChangeMessage(a,b);this._postMessageToIframeThrottled(this.delayedChangeProps[b])}},_postMessageToIframeThrottled:function(a){var b=this;clearTimeout(this._postMessageTimeout),this._postMessageTimeout=setTimeout(function(){b._postMessageToIframe()},a||this.DEFAULT_THROTTLE_TIME)},_postMessageToIframe:function(){var a=this;this._getMessageData(function(b){a._onBeforePostMessage(b),a.handleAddEventListener(a._Events.APP_MESSAGE,b)})},_sendPropertiesChangeMessage:function(){this._postMessageToIframeThrottled()},_onIframeLoad:function(){this.parent(),this._setIframeWidth(),this._postMessageToIframe()},_onResize:function(){this._setIframeWidth(),this.parent()},_setIframeWidth:function(){!this.isFullWidthContainer&&this._skinParts.iframe&&this._skinParts.iframe.setStyles({width:this.getWidth()})},handleAppStateChanged:function(a){var b="string"==typeof a?a:a.state;try{b=JSON.parse(b)}catch(c){b={}}b.cmd&&this[b.cmd+"Command"]&&this[b.cmd+"Command"].apply(this,b.args)},_onBeforePostMessage:function(){},_getMessageData:function(){},getFriendlyName:null})}),define.component("tpa.viewer.components.TPAFixedWidget",function(a){var b=a;b.inherits("tpa.viewer.components.TPAWidget"),b.resources(["W.Utils"]),b.statics({DEFAULT_COORDINATES:{top:"auto",left:"auto",bottom:"auto",right:"auto"}}),b.methods({initialize:function(a,b,c){this.parent(a,b,c),this._$top="auto",this._$left="auto",this._$bottom="auto",this._$right="auto",this._position="fixed"},initComponentLayout:function(){this._view.setStyle("visibility","visible"),this.removeEvent(Constants.ComponentEvents.READY_FOR_RENDER,this.initComponentLayout);var a=["x","y","width","height"],b=0;for(b;b<a.length;b++){var c=a[b],d=this._view.get(c);if(null!=d&&""!==d){var e="set"+c.capitalize();this[e](d,!0)}}this._view.setStyle("position",this._position||"fixed"),this.saveCurrentDimensions(),this.saveCurrentCoordinates()},getLayoutMode:function(){return"FIXED"},_setCssPosition:function(a,b){var c="auto"==a||!a&&isNaN(a),d=["top","left","bottom","right"],e="number"==typeof a?"px":"";if(!d.contains(b))return void W.Utils.debugTrace("fixedPositionComponent","_setCssPostion",b+" passed as "+a);if(!c&&a&&a.split&&(e=a.split(parseInt(a,10)).join(""),"%"!==e&&(e="px")),a=c?"auto":parseInt(a,10),this._view.getStyle(b)!=a){if(!c&&isNaN(a))return void W.Utils.debugTrace("fixedPositionComponent","set"+b,"NaN passed as value");this["_$"+b]=a+e,this._view.setStyle(b,a+e),"left"==b&&(this._$x=c||"%"==e?this._view.getPosition().x:a),"top"==b&&(this._$y=c||"%"==e?this._view.getPosition().y:a),this.onMovement()}},setX:function(a){this.setLeft(a),this.setRight("auto")},setY:function(a){this.setTop(a),this.setBottom("auto")},getRight:function(){return this._$right},setRight:function(a){this._setCssPosition(a,"right")},getBottom:function(){return this._$bottom},setBottom:function(a){this._setCssPosition(a,"bottom")},getLeft:function(){return this._$left},setLeft:function(a){if(this._setCssPosition(a,"left"),"50%"===a){var b=this.getWidth()/2;this._view.setStyle("margin-left",-b)}},setTop:function(a){if(this._setCssPosition(a,"top"),"50%"===a){var b=this.getHeight()/2;this._view.setStyle("margin-top",-b)}},getTop:function(){return this._$top},setWidth:function(a,b,c){var d,e,f=a;this._isPercent(a)&&(d=parseFloat(a)/100,e=window.getSize().x,f=Math.round(e*d)),this.parent(f,b,c)},setHeight:function(a,b,c){var d,e,f=a;this._isPercent(a)&&(d=parseFloat(a)/100,e=window.getSize().y,f=Math.round(e*d)),this.parent(f,b,c)},setPosition:function(a,b,c,d){this.setTop(a),this.setLeft(b),this.setBottom(c),this.setRight(d)},setCoordinates:function(a){return a=Object.merge(this.DEFAULT_COORDINATES,a||{}),this._changeSize({width:a.x,height:a.y},!0),this.setPosition(a.top,a.left,a.bottom,a.right),a},_onAutoSized:function(){this.fireEvent("autoSizeChange")},_isPercent:function(a){return"string"==typeof a&&"%"==a.split(parseFloat(a)).join("")},isFixedPositioned:function(){return!0},shouldBeFixedPosition:function(){return!0},_isLeftPositioned:function(){return"auto"!==this.getLeft()},_isHorizCentred:function(){return"50%"===this.getLeft()},_isVertCentred:function(){return"50%"===this.getTop()},_isRightPositioned:function(){return"auto"!==this.getRight()},_isTopPositioned:function(){return"auto"!==this.getTop()},_isSideCentered:function(){return this._isVertCentred()&&(this._isLeftPositioned()||this._isRightPositioned())},_isBottomPositioned:function(){return"auto"!==this.getBottom()}})}),define.component("tpa.viewer.components.TPAGallery",function(a){a.inherits("tpa.viewer.components.TPAComponent"),a.resources(["W.Data","W.Commands","W.Viewer","W.TPA","W.Theme","W.Config"]),a.utilize(["tpa.viewer.managers.ViewerUrlBuilder","wysiwyg.common.utils.LinkRenderer"]),a.dataTypes(["ImageList"]),a.binds(["_imageItemChange","_onThemeChange"]),a.propertiesSchemaType("SlideShowGalleryProperties"),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"TPA3DCarousel"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}]},indexName:"Gallery",styleProps:{}}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this.isTpa=!1,this.resources.W.Commands.registerCommandListenerByName("WViewerCommands.MediaZoom.Close",this,this._onMediaZoomClosed),this._uniqueGalleryId=_.uniqueId(),this.registerComponent(),(this.resources.W.Config.isCapturing()||this.resources.W.Config.isLoadedFromStatic())&&this._addPreconditionForDomCaptureReady("jsonDataIsSet"),this._linkRenderer=new this.imports.LinkRenderer},_handleProperties:function(){{var a=this.getComponentProperty("galleryImageOnClickAction");this.getComponentProperty("expandEnabled")}"unset"===a&&this.setComponentProperty("galleryImageOnClickAction","disabled",!0)},_onAllSkinPartsReady:function(){this._handleProperties(),this._registerToThemeChanged(),this.parent()},_onBeforePostMessage:function(){var a=this._getAllImagesDataItems();a.forEach(function(a){a.removeEvent(Constants.DataEvents.DATA_CHANGED,this._imageItemChange),a.addEvent(Constants.DataEvents.DATA_CHANGED,this._imageItemChange)},this)},_imageItemChange:function(){this._postMessageToIframeThrottled(3e3)},_getAllImagesDataItems:function(){var a=this.getDataItem().getData();return a.items.map(function(a){return this.resources.W.Data.getDataByQuery(a)},this)},_onMediaZoomClosed:function(){this.handleAddEventListener(this._Events.APP_MESSAGE,{cmd:"zoomClosed"})},_getBaseUrl:function(){return this._joinUrlPathParts(this._getBaseUrlPath(),this._getIndexName())},_getIndexName:function(){var a=this._hasDebugGalleryUrlParam?".debug":"";return this.indexName+"/"+this.indexName+a+".html"},_joinUrlPathParts:function(){return _.toArray(arguments).map(function(a){return a.replace(/[/]+$/,"").replace(/^[/]+/,"")}).join("/")},_getBaseUrlPath:function(){return this._devGalleryUrlParam||this.resources.topology.tpa+"/external/"},_buildUrl:function(){return new this.imports.ViewerUrlBuilder(this._getBaseUrl(),this).addArbitraryQueryParams(this._queryParams).addCompId().addDeviceType().addLocale().addViewMode().build()},_capitaliseFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},_getStyleProps:function(){var a=this._style.getProperties(),b={};for(var c in this.styleProps)if(b[c]=a[this.styleProps[c]],"color"==this._style.getPropertyType(this.styleProps[c])){var d="alpha"+this._capitaliseFirstLetter(c);b[d]=this._style.getPropertyExtraParamValue(this.styleProps[c],"alpha")}return b},_getMessageData:function(a){for(var b=this.getDataItem()._data,c=this.getComponentProperties(),d=this._getStyleProps(),e={items:[],props:_.clone(c.getData())},f=0;f<b.items.length;f++)e.items[f]=Object.clone(this.resources.W.Data.getDataByQuery(b.items[f])._data);this._fixLinksData(e.items),this.isUnderMobileView()&&e.props.textMode&&this.mobileTextMode&&(e.props.textMode=this.mobileTextMode),_.merge(e.props,d);var g=this.transformDataBeforeSend(e);this._prepareGalleryForHtmlCapture(g),a(g)},_prepareGalleryForHtmlCapture:function(a){(this.resources.W.Config.isCapturing()||this.resources.W.Config.isLoadedFromStatic())&&(this._jsonData=a,this._setPrecoditionForDomCaptureReady("jsonDataIsSet"))},getTPAData:function(){return this._jsonData},isDomDisplayReadyOnReady:function(){return!1},_zoom:function(a){a=a||0;var b=this.getDataItem();this.injects().Commands.executeCommand("WViewerCommands.OpenZoom",{itemsList:b,currentIndex:a,getDisplayerDivFunction:this.resources.W.Viewer.getDefaultGetZoomDisplayerFunction("Image"),getHashPartsFunction:this.resources.W.Viewer.getDefaultGetHashPartsFunction("Image")})},zoomCommand:function(a){this._zoom(a)},navigateToAnchorCommand:function(a,b){var c=this._linkRenderer._getViewerManager(),d=(this._linkRenderer._getSiteUrl(),this._linkRenderer._getViewerManager().getCurrentPageId());a&&("#"===a[0]&&(a=a.substr(1)),sessionStorage.setItem("anchorDataId",b),a===d||"SITE_STRUCTURE"===a?this.resources.W.Commands.executeCommand("WViewerCommands.SamePageScrollAnchor",{}):c.goToPage(a))},dispose:function(){var a=this._getAllImagesDataItems();a.forEach(function(a){a.removeEvent(Constants.DataEvents.DATA_CHANGED,this._imageItemChange)},this),this.resources.W.Theme.removeEvent(Constants.DataEvents.DATA_CHANGED,this._onThemeChange),this.resources.W.Commands.unregisterListener(this),this.parent()},_rgbToHex:function(a,b,c){a=parseInt(a,10),b=parseInt(b,10),c=parseInt(c,10);for(var d=((1<<24)+(a<<16)+(b<<8)+c).toString(16).slice(1),e=d.toString();e.length<6;)e="0"+e;return"#"+e},transformColorsBeforeSend:function(a,b){for(var c=0;c<b.length;++c){var d=a.props[b[c]],e=d;if(0===d.indexOf("color_")){var f=this.resources.W.Theme.getProperty(d);e=this._rgbToHex(f._r,f._g,f._b)}a.props[b[c]]=e}return a},_onThemeChange:function(){var a=this;clearTimeout(this.themeTimeoutTicket),this.themeTimeoutTicket=setTimeout(function(){a._postMessageToIframe()},100)},_registerToThemeChanged:function(){Object.keys(this.styleProps).length>0&&this._style.addEvent(Constants.StyleEvents.PROPERTY_CHANGED,this._onThemeChange)},transformDataBeforeSend:function(a){return this.transformColorsBeforeSend(a,Object.keys(this.styleProps))},getApplicationId:_.memoize(function(){return"_TPAGallery."+this.$className.split(".").pop()+"."+this._uniqueGalleryId}),_shouldDisplayPreloader:function(){return!1},_shouldDisplayUnresponsiveMessage:function(){return!1},_getAppNameForError:function(){return this.$className},_fixLinksData:function(a){_.forEach(a,function(a){var b;return a.link?(b=this.resources.W.Data.getDataByQuery(a.link),void(b&&b.getData&&this._saveLinkDataOnDataItem(b,a))):void this._removeLinkFromDataItem(a)},this)},_saveLinkDataOnDataItem:function(a,b){var c={href:"",text:"",target:"",icon:"",linkType:""};switch(a.getType()){case"ExternalLink":c.linkType="WEBSITE",c.href=this._linkRenderer.renderExternalLink(a),c.target=a.get("target");break;case"EmailLink":c.linkType="EMAIL",c.href=this._linkRenderer.renderEmailLink(a),c.target="_blank";break;case"PageLink":c.linkType="PAGE",c.href=this._linkRenderer.renderPageLink(a,!0),c.target="_self";break;case"DocumentLink":c.linkType="DOCUMENT",c.href=this._linkRenderer.renderDocumentLink(a),c.target="_blank";break;case"AnchorLink":c.linkType="ANCHOR",c.href=this._linkRenderer.renderAnchorLink(a,!0),c.target="_self";break;case"LoginToWixLink":}_.extend(b,c)},_removeLinkFromDataItem:function(a){var b=["href","text","target","icon","linkType"];for(var c in a)if(_.indexOf(b,c)>0)try{delete a[c]}catch(d){a[c]=""}}}),a.statics({_hasDebugGalleryUrlParam:/[?&]debugGallery(?:[=&]|$)/i.test(window.location.search),_devGalleryUrlParam:function(){var a=window.location.search.match(/[?&]devGallery=([^&]+)/i);
return a&&decodeURIComponent(a[1])}()})}),define.component("tpa.viewer.components.TPAGluedWidget",function(a){var b=a;b.resources(["W.Config"]),b.inherits("tpa.viewer.components.TPAFixedWidget"),b.statics({DEF_PLACEMENT:"BOTTOM_RIGHT",DEF_WIDTH:200,DEF_HEIGHT:200,TOP_STICKY_AREA:120,SIDE_STICKY_AREA:300,CENTER_MARGIN_VALUE:0}),b.propertiesSchemaType("TPAGluedProperties"),b.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1,disableMoveForward:!0,disableMoveBackward:!0},custom:[{label:"APPS_SETTINGS_APPS",command:"WEditorCommands.OpenTPASettingsDialog"}],dblClick:{label:"APPS_SETTINGS_APPS",command:"WEditorCommands.OpenTPASettingsDialog"}}}),b.methods({initialize:function(a,b,c){this.parent(a,b,c),this._resizableSides=[];var d=this;resource.getResourceValue("W.Viewer",function(a){a.isSiteReady()?d._makeRoomForAd():a.addEvent("SiteReady",function(){d._makeRoomForAd()})}),this.resources.W.Commands.registerCommandListenerByName("WPreviewCommands.WEditModeChanged",this,this._onEditorModeChanged)},render:function(){this.setCoordinates(this._coordinates),this.parent()},initComponentLayout:function(){this.parent(),this._view.addClass("Z-FIXED-COMPS"),this.resources.W.Config.env.$isPublicViewerFrame&&this._addTransitionClass()},_addTransitionClass:function(){this._view.addClass("TransitionSize"),this._skinParts.iframe.addClass("TransitionSize")},_removeTransitionClass:function(){this._view.removeClass("TransitionSize"),this._skinParts.iframe.removeClass("TransitionSize")},setCoordinates:function(a){this.parent(this._coordinates||a),this._setMarginOffset()},setPlacment:function(a,b,c){var d=this.getComponentProperties(),e=a||this._placement||this.DEF_PLACEMENT;this._placement!==e?(this._placement=a||this._placement||this.DEF_PLACEMENT,this._horizontalMargin=this.CENTER_MARGIN_VALUE,this._verticalMargin=this.CENTER_MARGIN_VALUE):(this._horizontalMargin=+c||0,this._verticalMargin=+b||0),d.set("placement",this._placement),d.set("horizontalMargin",this._horizontalMargin),d.set("verticalMargin",this._verticalMargin),this._coordinates=this._getGluedWidgetCoordinates(),this.setCoordinates(this._coordinates)},_setMarginOffset:function(a){var b=a?a.width:this.getWidth(),c=a?a.height:this.getHeight();this._isHorizCentred()?this._handleHorizontalCentredPlacement(b):this._isVertCentred()?this._handleVerticalCenteredPlacement(c):this._view.setStyle("margin","0px")},_pxToPrecentWidth:function(a){return a/window.getSize().x*100},_pxToPrecentHeight:function(a){return a/window.getSize().y*100},_setTopBottomMargin:function(a,b,c){var d=this._view.style;d.top=a,d.bottom=b,d.margin=c},_setLeftRightMargin:function(a,b,c){var d=this._view.style;d.left=a,d.right=b,d.margin=c},_verticalRelativePlacement:function(a,b){var c=a/2,d=this._pxToPrecentHeight(b-2*this.TOP_STICKY_AREA)/2,e=0-c-this._verticalMargin*c,f=d*this._verticalMargin+50+"%";this._setTopBottomMargin(f,"auto",e+"px 0 0 0")},_bottomStickyVerticalPlacement:function(){var a=this._verticalMargin-1,b=(1-a)*this.TOP_STICKY_AREA;this._setTopBottomMargin("auto",b+"px","0")},_topStickyVerticalPlacement:function(){var a=-1*this._verticalMargin-1,b=(1-a)*this.TOP_STICKY_AREA;this._setTopBottomMargin(b+"px","auto","0")},_horizontalRelativePlacement:function(a,b){var c=a/2,d=this._pxToPrecentWidth(b-2*this.SIDE_STICKY_AREA)/2,e=0-c-this._horizontalMargin*c,f=d*this._horizontalMargin+50+"%";this._setLeftRightMargin(f,"auto","0 0 0 "+e+"px")},_rightStickyHorizontalPlacement:function(){var a=this._horizontalMargin-1,b=(1-a)*this.SIDE_STICKY_AREA;this._setLeftRightMargin("auto",b+"px","0")},_leftStickyHorizontalPlacement:function(){var a=-1*this._horizontalMargin-1,b=(1-a)*this.SIDE_STICKY_AREA;this._setLeftRightMargin(b+"px","auto","0")},_handleVerticalCenteredPlacement:function(a){var b=window.getSize().y;return this._verticalMargin>=-1&&this._verticalMargin<=1?this._verticalRelativePlacement(a,b):this._verticalMargin>1&&this._verticalMargin<=2?this._bottomStickyVerticalPlacement():this._verticalMargin<-1&&this._verticalMargin>=-2?this._topStickyVerticalPlacement():void 0},_handleHorizontalCentredPlacement:function(a){var b=window.getSize().x;return this._horizontalMargin>=-1&&this._horizontalMargin<=1?this._horizontalRelativePlacement(a,b):this._horizontalMargin>1&&this._horizontalMargin<=2?this._rightStickyHorizontalPlacement():this._horizontalMargin<-1&&this._horizontalMargin>=-2?this._leftStickyHorizontalPlacement():void 0},getFullPlacementData:function(){return{placement:this._placement,verticalMargin:this._verticalMargin,horizontalMargin:this._horizontalMargin}},handleResizeWindow:function(a){var b={width:a.msgData.width,height:a.msgData.height};this._changeSize(b,!0),this._setMarginOffset(b),this._setTransitionEndCallback(a.callback,400)},_setTransitionEndCallback:function(a,b){setTimeout(function(){try{a()}catch(b){}},b)},onDataInitialized:function(a){this.parent(a);var b=this.getComponentProperties(),c=this._appData.widgets[this.getWidgetId()];this._placement=this.DEF_PLACEMENT;try{this._placement=b.get("placement")||c.gluedOptions.placement||this.DEF_PLACEMENT}catch(d){this._placement=this.DEF_PLACEMENT}this._setInitPlacementData(b,c),this._coordinates=this._getGluedWidgetCoordinates()},_setInitPlacementData:function(a,b){var c=a.get("horizontalMargin"),d=a.get("verticalMargin");""===c?(a.set("horizontalMargin",b.gluedOptions.horizontalMargin),this._horizontalMargin=b.gluedOptions.horizontalMargin):this._horizontalMargin=+c,""===d?(a.set("verticalMargin",b.gluedOptions.verticalMargin),this._verticalMargin=b.gluedOptions.verticalMargin):this._verticalMargin=+d},_getGluedWidgetCoordinates:function(){var a,b,c=this.getWidgetId(),d=this._appData.widgets[c];"site"===viewMode?(a=this._view.getAttribute("width")||this.DEF_WIDTH,b=this._view.getAttribute("height")||this.DEF_HEIGHT):(a=d.defaultWidth||this.DEF_WIDTH,b=d.defaultHeight||this.DEF_HEIGHT);var e="auto",f="auto",g="auto",h="auto";switch(this._placement){case"TOP_LEFT":f=0,e=0;break;case"TOP_RIGHT":h=0,e=0;break;case"BOTTOM_RIGHT":h=0,g=0;break;case"BOTTOM_LEFT":f=0,g=0;break;case"TOP_CENTER":e=0,f="50%";break;case"CENTER_RIGHT":e="50%",h=0;break;case"BOTTOM_CENTER":g=0,f="50%";break;case"CENTER_LEFT":f=0,e="50%";break;default:e=0,f="50%"}return{x:a,y:b,top:e,left:f,bottom:g,right:h}},_siteHasAds:function(){var a=this.resources.W.Config.getPremiumFeatures();return a&&_.contains(a,"AdsFree")},_needToMakeRoomForAd:function(){var a="none";if(!this._siteHasAds()){var b=+this._view.style.right.replace("px",""),c=+this._view.style.top.replace("px",""),d=+this._view.style.bottom.replace("px",""),e=this._placement&&this._placement.indexOf("TOP")>-1,f=this._placement&&this._placement.indexOf("BOTTOM")>-1,g="CENTER_RIGHT"===this._placement,h=g||"CENTER_LEFT"===this._placement;e&&135>b||g&&25>c?a="top":(f||h&&46>d)&&(a="footer")}return a},_makeRoomForAd:function(){var a=this._needToMakeRoomForAd();"none"!==a&&setTimeout(function(){var b=document.getElementById("wixFooter"),c=b&&b.$logic?b.$logic.getAdHeight():{footer:46,top:26};"top"===a?this.setY(c.top):this._setCssPosition(c.footer,"bottom")}.bind(this),10)},_resetAdRePosition:function(){var a=this._needToMakeRoomForAd();"none"!==a&&("top"===a?this.setY(0):this._setCssPosition(0,"bottom"))},_onEditorModeChanged:function(a){"PREVIEW"===a?this._makeRoomForAd():this._resetAdRePosition(),"PREVIEW"===a?this._addTransitionClass():this._removeTransitionClass()},canMoveBack:function(){return!1},canMoveForward:function(){return!1},isMultiSelectable:function(){return!1},canMoveToOtherScope:function(){return!0},isDraggable:function(){return!1},isDuplicatable:function(){return!1},getShowOnAllPagesChangeability:function(){return!1},getX:function(){var a=0;return this._isLeftPositioned()?this._isHorizCentred()&&(a=this._view.getPosition().x):this._isRightPositioned()&&(a=this._view.getPosition().x),a},getY:function(){var a=0;return this._isTopPositioned()?this._isVertCentred()&&(a=this._view.getPosition().y):this._isBottomPositioned()&&(a=this._view.getPosition().y),a},getSelectableX:function(){return this.getX()},getSelectableY:function(){return this.getY()},_getPageMargin:function(){var a=this.resources.W.Viewer.getSiteNode(),b=a.getSize();return(window.innerWidth-b.x)/2},_getPageSize:function(){var a=this.resources.W.Viewer.getSiteNode();return a.getSize()},isHorizontallyMovable:function(){return!1},isVerticallyMovable:function(){return!1}})}),define.component("tpa.viewer.components.TPAModal",function(a){a.binds(["dispose"]),a.inherits("tpa.viewer.components.TPAWidget"),a.utilize(["tpa.viewer.managers.ViewerUrlBuilder"]),a.resources(["W.Viewer","W.Commands","W.TPA"]),a.statics({DEFAULT_URL:"http://sslstatic.wix.com/services/js-sdk/1.19.0/html/modal.html"}),a.skinParts({blockingLayer:{type:"htmlElement"},dialog:{type:"htmlElement"},xButton:{type:"htmlElement"}}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),c=c||{},this._rawUrl=c.url||this.DEFAULT_URL,this._width=c.width,this._height=c.height,this._origCompId=c.origCompId,this.isVolatile=!0,this._onClose=c.onClose,this.resources.W.Commands.registerCommandListenerByName("WPreviewCommands.WEditModeChanged",this,this.dispose)},getAcceptableDataTypes:function(){return["TPAWidget","TPA"]},_onAllSkinPartsReady:function(){this._skinParts.xButton.addEvent("click",this.dispose),this._skinParts.blockingLayer.addEvent("click",this.dispose)},_enableSiteScroll:function(){b.enableScroll(),this._scrollDisabled=!1,document.body.removeClass("wixappsFullScreenMode"),this._lastScrollY&&window.scrollTo(window.scrollX,this._lastScrollY)},_disableSiteScroll:function(){this._scrollDisabled||(document.body.addClass("wixappsFullScreenMode"),this._lastScrollY=window.scrollY,b.disableScroll(),this._scrollDisabled=!0)},render:function(){this.isUnderMobileView()?this._disableSiteScroll():this._width>0&&this._height>0&&(this._setWidth(this._width),this._setHeight(this._height)),this.parent()},_setWidth:function(a){var b=this._skinParts.dialog,c=document.getWidth();if(a>c)b.setStyle("width",c),b.setStyle("left",100);else{var d=a/2;b.setStyle("margin-left",-d),b.setStyle("width",a)}},_setHeight:function(a){var b=this._skinParts.dialog,c=document.getHeight();if(a>c)b.setStyle("height",c),b.setStyle("top",100);else{var d=a/2;b.setStyle("margin-top",-d),b.setStyle("height",a)}},_buildUrl:function(){return new this.imports.ViewerUrlBuilder(this._getBaseUrl(),this).addCacheKiller().addCompId().addDeviceType().addInstance().addLocale().addViewMode().addArbitraryQueryParams({origCompId:this._origCompId}).build()},_getBaseUrl:function(){return this._rawUrl},dispose:function(){this.resources.W.Commands.unregisterListener(this),this.callCloseCallback(),this._enableSiteScroll(),this.parent()},callCloseCallback:function(a){this._onClose&&this._onClose(a),this._onClose=null},handleCloseWindow:function(a){this.callCloseCallback(a.msgData),this.dispose()},setHeight:function(a,b,c){if(c!==!1&&(c=!0),a=parseInt(a,10),isNaN(a))return void W.Utils.debugTrace("WbaseComp","setHeight","NaN passed as value");a=this._limitHeight(a);var d=this._skinParts.dialog;(this._$height!=a||b)&&(this._$height=a,d.setStyle("height",this._$height+"px"),this.flushPhysicalHeightCache(),c&&this._onResize())},handleResizeWindow:function(a){this.isUnderMobileView()||(this._width=a.msgData.width||this.getWidth(),this._height=a.msgData.height||this.getHeight(),this.render())},getOrigComponent:function(){return this.resources.W.TPA.getCompById(this._origCompId)}});var b=function(){function a(a){a=a||window.event,a.preventDefault&&a.preventDefault(),a.returnValue=!1}function b(){window.addEventListener&&window.addEventListener("DOMMouseScroll",a,!1),d=document.onmousewheel||null,e=window.onmousewheel||null,window.onmousewheel=document.onmousewheel=a}function c(){window.removeEventListener&&window.removeEventListener("DOMMouseScroll",a,!1),window.onmousewheel=e,document.onmousewheel=d}var d=null,e=null;return{disableScroll:b,enableScroll:c}}()}),define.component("tpa.viewer.components.TPAPlaceholder",function(a){var b=a;b.inherits("wysiwyg.viewer.components.WPhotoOBC"),b.skinParts({img:{type:"core.components.image.ImageNew",dataRefField:"*"}}),b.fields({propertiesSchemaName:"WPhotoProperties",EDITOR_META_DATA:{general:{title:"App Placeholder",settings:!0,design:!1,animation:!1},custom:[{label:"SIDE_BTN_MARKET",command:"WEditorCommands.Market",commandParameterDataRef:"SELF"}],dblClick:{command:"WEditorCommands.Market",commandParameterDataRef:"SELF"}}})}),define.component("tpa.viewer.components.TPAPopup",function(a){a.inherits("tpa.viewer.components.TPAFixedWidget"),a.resources(["W.Commands","W.TPA"]),a.utilize(["tpa.viewer.managers.ViewerUrlBuilder"]),a.binds(["_onResize","dispose"]),a.statics({FIXED_OFFSET:2,MIN_EDGE_SIZE:50}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),c=c||{},this._rawUrl=c.url,this._popupSize=c.popupSize?c.popupSize:{x:c.width,y:c.height},this._origin=c.origin||"",this._placement=c.placement||"CENTER",this._openPosition=c.openPosition||{y:0,x:0},this._openPopupPosition=c.openPopupPosition||{y:0,x:0},this._openSize=c.openSize,this._origCompId=c.origCompId,this.isVolatile=!0,this._origPopupSize=this._popupSize,this._onClose=c.onClose,this.resources.W.Commands.registerCommandListenerByName("WPreviewCommands.WEditModeChanged",this,this.dispose),("RELATIVE"===this._origin||"ABSOLUTE"===this._origin)&&(this._position="absolute")},getAcceptableDataTypes:function(){return["TPAWidget","TPA"]},_onAllSkinPartsReady:function(){this._skinParts.x&&this._skinParts.x.addEvent("click",this.dispose)},render:function(){var a=this.calcCoordinates();("RELATIVE"===this._origin||"ABSOLUTE"===this._origin)&&this._adaptRelativePosition(a),this.setCoordinates(a),this._view.setStyle("width",a.x+"px"),this._view.setStyle("height",a.y+"px"),this.parent()},_adaptRelativePosition:function(a){if(!this._isPercent(a.left)){var b=this.resources.W.Viewer.getSiteNode(),c=b.getLeft();a.left-=c}},calcCoordinates:function(){var a={};switch(this._origin){case"RELATIVE":a=Object.merge(this._getRelativeCoords(),this._popupSize),a=this._applyRelativeOffsets(a),a=this._validateRelativeCoordinates(a);break;case"FIXED":a=this._calcCoordinatesFixedPosition();break;case"ABSOLUTE":a=Object.merge(this._getAbsoluteCoords(),this._popupSize),a=this._validateAbsoluteCoordinates(a);break;default:a=this._calcCoordinatesFixedPosition()}return a.x||(a.x=200),a.y||(a.y=200),a=this._validateMinSize(a),a=this._validateNegtaivePosition(a)},_calcCoordinatesFixedPosition:function(){var a={};return a=Object.merge(this._getFixedCoords(),this._popupSize),a=this._applyFixedOffsets(a),a=this._validateFixedCoordinates(a)},_validateMinSize:function(a){return(a.x<=this.MIN_EDGE_SIZE||a.y<=this.MIN_EDGE_SIZE)&&(a=this._fallbackToCenterMin(a)),a},_validateNegtaivePosition:function(a){return("number"==typeof a.top&&a.top<0||"number"==typeof a.left&&a.left<0||"number"==typeof a.bottom&&a.bottom<0||"number"==typeof a.right&&a.right<0)&&(a=this._fallbackToCenterMin(a)),a},_validateFixedCoordinates:function(a){var b=window.getWidth(),c=window.getHeight();return a.x>=b&&(a.y=b-2*this.FIXED_OFFSET),a.y>=c&&(a.y=c-2*this.FIXED_OFFSET),a},_validateRelativeCoordinates:function(a){return a=this._validateMaxSizeLimit(a),this._isTop()||this._isBottom()?a=this._getVerticalCroppedCoords(a):this._isCenter()&&(a=this._getHorizontalCroppedCoords(a)),this._getFixedWidthHeightCoords(a)},_validateAbsoluteCoordinates:function(a){return a=this._validateMaxSizeLimit(a),this._isTop()||this._isBottom()?a=this._getAbsoluteVerticalCroppedCoords(a):this._isCenter()&&(a=this._getAbsoluteHorizontalCroppedCoords(a)),this._getFixedWidthHeightCoords(a)},_getFixedWidthHeightCoords:function(a){for(var b in a)a[b]<0&&"x"!=b&&"y"!=b&&(("top"===b||"botom"===b)&&(a.y=a.y+a[b]),("right"===b||"left"===b)&&(a.x=a.x+a[b]),a[b]=0);return a},_fallbackToCenterMin:function(a){return a.top="50%",a.left="50%",a.x=this._origPopupSize.x,a.y=this._origPopupSize.y,this._view.setStyle("position","fixed"),this._validateMaxSizeLimit(a)},_getVerticalCroppedCoords:function(a){var b,c,d=window.getWidth(),e=window.getHeight();return this._isTop()?(b=this._openPosition.y>this._popupSize.y,b||(a.y=this._openPosition.y-2*this.FIXED_OFFSET,a.top=this.FIXED_OFFSET)):this._isBottom()&&(b=e-(this._openPosition.y+this._openSize.y)>this._popupSize.y,b||(a.y=e-(this._openPosition.y+this._openSize.y)-2*this.FIXED_OFFSET)),this._isRight()?(c=d-(this._openPosition.x+this._openSize.x)>this._popupSize.x,c||(a.x=d-(this._openPosition.x+this._openSize.x)-10)):this._isLeft()?(c=d-(this._openPosition.x-this._popupSize.x)>this._popupSize.x,c||(a.x=d-this._openPosition.x,a.left=this._openPosition.x-a.x)):this._isCenter()&&(c=d-this._openPosition.x>this._popupSize.x,c||(a.x=d-this._openPosition.x),a.left=this._openPosition.x-a.x/2+this._openSize.x/2),a},_getAbsoluteVerticalCroppedCoords:function(a){var b,c,d=window.getWidth(),e=window.getHeight(),f=this._openPosition.y+this._openPopupPosition.y,g=this._openPosition.x+this._openPopupPosition.x;return this._isTop()?(b=f>this._popupSize.y,b||(a.y=f-this.FIXED_OFFSET,a.top=this.FIXED_OFFSET)):this._isBottom()&&(b=e-f>this._popupSize.y,b||(a.y=e-f)),this._isRight()?(c=d-g>this._popupSize.x,c||(a.x=d-g)):this._isLeft()?(c=g>this._popupSize.x-this.FIXED_OFFSET,c||(a.x=g-this.FIXED_OFFSET,a.left=this.FIXED_OFFSET)):this._isCenter()&&(c=d-g>this._popupSize.x,c||(a.x=d-g,a.left=this._openPosition.x-a.x/2+this._openSize.x/2)),a},_applyRelativeOffsets:function(a){return this._isTop()&&(a.top-=this.FIXED_OFFSET),this._isBottom()&&(a.top+=this.FIXED_OFFSET),this._isLeft()&&(a.left-=this.FIXED_OFFSET),this._isRight()&&(a.left+=this.FIXED_OFFSET),a},_applyFixedOffsets:function(a){return this._isTop()&&(a.top+=this.FIXED_OFFSET),this._isBottom()&&(a.top+=this.FIXED_OFFSET),this._isLeft()&&(a.left+=this.FIXED_OFFSET),this._isRight()&&(a.left+=this.FIXED_OFFSET),a},_getHorizontalCroppedCoords:function(a){var b,c=window.getWidth();return this._isRight()?(b=c-(this._openPosition.x+this._openSize.x)>this._popupSize.x,b||(a.x=c-(this._openPosition.x+this._openSize.x)-10)):this._isLeft()&&(b=c-(this._openPosition.x-this._popupSize.x)>this._popupSize.x,b||(a.x=c-this._openPosition.x,a.left=this._openPosition.x-a.x)),a},_getAbsoluteHorizontalCroppedCoords:function(a){var b,c=window.getWidth(),d=(this._openPosition.y+this._openPopupPosition.y,this._openPosition.x+this._openPopupPosition.x);return this._isRight()?(b=c-d>this._popupSize.x,b||(a.x=c-d)):this._isLeft()&&(b=d>this._popupSize.x-this.FIXED_OFFSET,b||(a.x=d-this.FIXED_OFFSET,a.left=this.FIXED_OFFSET)),a},_validateMaxSizeLimit:function(a){var b=window.getWidth(),c=window.getHeight();return a.x=a.x<b?a.x:b,a.y=a.y<c?a.y:c,a},dispose:function(){this._onClose&&this._onClose(),this.parent()},_getFixedCoords:function(){var a={};switch(this._placement){case"TOP_LEFT":a={left:0,top:0};break;case"TOP_RIGHT":a={right:0,top:0};break;case"BOTTOM_RIGHT":a={right:0,bottom:0};break;case"BOTTOM_LEFT":a={left:0,bottom:0};break;case"TOP_CENTER":a={top:0,left:"50%"};break;case"CENTER_RIGHT":a={top:"50%",right:0};break;case"BOTTOM_CENTER":a={bottom:0,left:"50%"};break;case"CENTER_LEFT":a={left:0,top:"50%"};break;default:a={top:"50%",left:"50%"}}return a},_getRelativeCoords:function(){var a={},b=this._openPosition,c=this._openSize,d=this._popupSize,e=b.x,f=b.y,g=c.x,h=c.y,i=d.x,j=d.y;switch(this._placement){case"TOP_LEFT":a={top:f-j,left:e-i};break;case"TOP_RIGHT":a={top:f-j,left:e+g};break;case"BOTTOM_RIGHT":a={top:f+h,left:e+g};break;case"BOTTOM_LEFT":a={top:f+h,left:e-i};break;case"TOP_CENTER":a={top:f-j,left:this._getRelativeCenterLeft(e,g,i)};break;case"CENTER_RIGHT":a={top:this._getRelativeCenterTop(f,h,j),left:e+g};break;case"BOTTOM_CENTER":a={top:f+h,left:this._getRelativeCenterLeft(e,g,i)};break;case"CENTER_LEFT":a={top:this._getRelativeCenterTop(f,h,j),left:e-i};break;default:a={top:this._getRelativeCenterTop(f,h,j),left:this._getRelativeCenterLeft(e,g,i)}}return a},_getAbsoluteCoords:function(){var a={},b=this._openSize,c=this._popupSize,d=this._openPosition.x+this._openPopupPosition.x,e=this._openPosition.y+this._openPopupPosition.y,f=(b.x,b.y,c.x),g=c.y;switch(this._placement){case"TOP_LEFT":a={top:e-g,left:d-f};break;case"TOP_RIGHT":a={top:e-g,left:d};break;case"BOTTOM_RIGHT":a={top:e,left:d};break;case"BOTTOM_LEFT":a={top:e,left:d-f};break;case"TOP_CENTER":a={top:e-g,left:this._getAbsoluteCenterLeft(d,f)};break;case"CENTER_RIGHT":a={top:this._getAbsoluteCenterTop(e,g),left:d};break;case"BOTTOM_CENTER":a={top:e,left:this._getAbsoluteCenterLeft(d,f)};break;case"CENTER_LEFT":a={top:this._getAbsoluteCenterTop(e,g),left:d-f};break;default:a={top:this._getAbsoluteCenterTop(e,g),left:this._getAbsoluteCenterLeft(d,f)}}return a},_getRelativeCenterTop:function(a,b,c){return a+b/2-c/2},_getRelativeCenterLeft:function(a,b,c){return a+b/2-c/2},_getAbsoluteCenterTop:function(a,b){return a-b/2},_getAbsoluteCenterLeft:function(a,b){return a-b/2},_buildUrl:function(){return new this.imports.ViewerUrlBuilder(this._getBaseUrl(),this).addCacheKiller().addCompId().addDeviceType().addInstance().addLocale().addViewMode().addWidth().addArbitraryQueryParams({origCompId:this._origCompId}).build()},_getBaseUrl:function(){return this._rawUrl},_onResize:function(){this.parent()},handleCloseWindow:function(a){this._onClose&&this._onClose(a.msgData),this.dispose()},_isTop:function(){return this._placement.indexOf("TOP")>=0},_isBottom:function(){return this._placement.indexOf("BOTTOM")>=0},_isLeft:function(){return this._placement.indexOf("LEFT")>=0},_isRight:function(){return this._placement.indexOf("RIGHT")>=0},_isCenter:function(){return this._placement.indexOf("CENTER")>=0},getOrigComponent:function(){return this.resources.W.TPA.getCompById(this._origCompId)}})}),define.component("tpa.viewer.components.TPASection",function(a){var b=a;b.inherits("tpa.viewer.components.TPAViewerBase"),b.utilize(["tpa.viewer.managers.ViewerUrlBuilder","tpa.common.services.TPASectionService"]),b.dataTypes(["TPA","TPAWidget"]),b.resources(["W.Experiments"]),b.methods({isPage:!0,initialize:function(a,b,c){this.parent(a,b,c),this._nodeReady=!1,this._deleteable=!1},render:function(){this._inMobileCompMode()?(this._overlayWithUnavailableInMobile(),this.removeEventListeners(),this._deleteable=!1):this.parent(),setTimeout(function(){this.isAppOnPage(W.Viewer.getCurrentPageId())&&this.onPageVisibilityChange(!0)}.bind(this),0)},getWidgetId:function(){return this._data.get("widgetId")},_inMobileCompMode:function(){if(!this.isUnderMobileView())return!1;var a=this._appData;return!(a.sectionMobileUrl&&(this.isInDevMode()||a.sectionMobilePublished))},isVisible:function(){return this._nodeReady},onPageVisibilityChange:function(a){a===!0&&this._nodeReady===!1&&(this._nodeReady=!0,this._renderIframe())},onDataInitialized:function(a){this.parent(a);var b=a.sectionRefreshOnWidthChange;b||this.removeEvent("resizeEnd",this._onResizeEnd)},_buildUrl:function(){return this._initialized?new this.imports.ViewerUrlBuilder(this._getBaseUrl(),this).addArbitraryQueryParams(this._queryParams).addCacheKiller().addCompId().addDeviceType().addInstance().addLocale().addSectionUrlAndTarget().addStateToPath().addViewMode().addWidth().build():""},_getSectionUrl:function(a){var b=this.isUnderMobileView(),c=this.isInDevMode(),d=new this.imports.TPASectionService(a,this.getDataItem().getSchemaType(),b,c),e=this.getWidgetId();return d.getSectionUrl(e)},_getBaseUrl:function(){var a=this._appData,b=this._getSectionUrl(a),c=a.sectionDefaultPage;return c&&("/"!==b.slice(-1)&&(b+="/"),b+=c),b},handleAppStateChanged:function(a){var b="string"==typeof a?a:a.state;this.resources.W.TPA._currentPageState=b;var c=this.resources.W.Viewer,d=this.resources.W.Utils.hash.getHashParts(),e=d.id||this.resources.W.Viewer.getHomePageId(),f=c.setUrlHashToPage?c.setUrlHashToPage.bind(c):c._hashChangeHandler._setUrlHashToPage.bind(c._hashChangeHandler);f(e,b,!0)},isDeleteable:function(){return this._deleteable},isDeleteableRecurse:function(){return this._deleteable},isDuplicatable:function(){return!1},canMoveToOtherScope:function(){return!1},isContainable:function(){return!1}})}),define.component("tpa.viewer.components.TPAViewerBase",function(a){var b=a;b.inherits("tpa.common.components.TPABase"),b.utilize(["tpa.common.services.AppExtensionsService"]),b.resources(["W.Config","W.TPA","W.Viewer","W.Commands","topology"]),b.statics({EXTENSIONS_FOOTER_HEIGHT:50}),b.traits(["tpa.viewer.traits.TPAHandlers","tpa.viewer.traits.TPAHandlersViewerCommons","tpa.common.traits.TPAHandlersCommons"]),b.binds(["_handlePageNavigationChange"]),b.methods({initialize:function(a,b,c){this.parent(a,b,c),this.isTpa=!0,this.setMinW(this.MIN_SIZE.w),this.setMinH(this.MIN_SIZE.h),this.addEvent("resizeEnd",this._onResizeEnd);var d=this.resources.W.Config.env;this._isMobileComp=d.isViewingSecondaryDevice(),this._viewingDevice=d.$viewingDevice,(this.resources.W.Config.isCapturing()||this.resources.W.Config.isLoadedFromStatic())&&(this._preconditionsForDomCaptureReady={}),this.addEvent("addedToStage",this._reportComponentAddedToStageBiEvent),this.appExtensionsService=new this.imports.AppExtensionsService},isUnderMobileView:function(){return this._isMobileComp},getViewingDevice:function(){return this._viewingDevice},isPremiumApp:function(){return!!this._appData&&!!this._appData.vendorProductId},isDemoMode:function(){return!!this._appData&&!!this._appData.demoMode},onPageVisibilityChange:function(a,b){a&&this.fireEvent(this._Events.PAGE_NAVIGATION_CHANGE,b._compId)},_addEventListeners:function(){this.resources.W.Commands.registerCommandListenerByName(this._Events.EDIT_MODE_CHANGE,this,function(){this.handleAddEventListener.apply(this,[this._Events.EDIT_MODE_CHANGE])}),this.resources.W.Viewer.addEvent(this._Events.PAGE_NAVIGATION_CHANGE,this._handlePageNavigationChange),!this.resources.W.Config.env.$isPublicViewerFrame&&this.resources.W.TPA.isParentEditor()&&window.parent.W.Commands.registerCommandListenerByName(this._Events.SITE_PUBLISHED,this,function(){this.handleAddEventListener.apply(this,[this._Events.SITE_PUBLISHED])})},_onAllSkinPartsReady:function(){this.parent(),this._addEventListeners(),this.EDITOR_META_DATA=_.clone(this.EDITOR_META_DATA),this.EDITOR_META_DATA.custom=_.clone(this.EDITOR_META_DATA.custom),this._isSafeMode()&&this.EDITOR_META_DATA.custom.push({label:"Load Iframe",command:"WEditorCommands.LoadTpaIframe",commandParameter:this._appData}),this._hasExtensions()&&this.EDITOR_META_DATA.custom.push({label:"TPA_APP_EXTENSIONS",command:"WEditorCommands.OpenTPAAppExtensionsDialog",commandParameter:{appData:this._appData,origin:"fpp"}})},componentSelected:function(){var a=_.some(this.EDITOR_META_DATA.custom,{label:"TPA_APP_EXTENSIONS"});this._hasExtensions()&&!a?this.EDITOR_META_DATA.custom.push({label:"TPA_APP_EXTENSIONS",command:"WEditorCommands.OpenTPAAppExtensionsDialog",commandParameter:{appData:this._appData,origin:"fpp"}}):!this._hasExtensions()&&a&&(this.EDITOR_META_DATA.custom=_.reject(this.EDITOR_META_DATA.custom,function(a){return"TPA_APP_EXTENSIONS"===a.label}))},removeEventListeners:function(){this.resources.W.Viewer.removeEvent(this._Events.PAGE_NAVIGATION_CHANGE,this._handlePageNavigationChange),this.resources.W.Commands.unregisterListener(this)},passAppMessage:function(a){this.handleAddEventListener(this._Events.APP_MESSAGE,a)},passWindowPlacement:function(a){this.handleAddEventListener(this._Events.WINDOW_PLACEMENT_CHANGED,a)},onThemeChange:function(a){this.handleAddEventListener(this._Events.THEME_CHANGE,a)},onStyleParamChange:function(a){this.handleAddEventListener(this._Events.STYLE_PARAMS_CHANGE,a)},isPubSubMsg:function(a){return _.has(a,"msgData")?0===a.msgData.eventKey.indexOf(this.TPA_PUB_SUB_PREFIX):void 0},setQueryParams:function(a){this._queryParams=a},refreshAppData:function(){var a=this.resources.W.Viewer.getAppDataHandler().getAppData(this._applicationId);this._appData&&this._appData.demoMode&&!a.demoMode&&this._reportComponentAddedToStageBiEvent(!0),this._appData=a},getAppDefinitionId:function(){return this._appDefinitionId||this._extractAppData(),this._appDefinitionId},_disposeEventHandlers:function(){this.resources.W.Viewer.removeEvent(this._Events.PAGE_NAVIGATION_CHANGE,this._handlePageNavigationChange),this.parent()},getPanelInfo:function(a){this.resources.W.TPA.getAppMarketData(this._appData.appDefinitionId,function(b){this._setPanelInfo(b),a(b)}.bind(this))},_setPanelInfo:function(a){a&&(this._appData.panelInfo={},this._appData.panelInfo.title=a.title,this._appData.panelInfo.price=a.price,this._appData.panelInfo.features=a.features,this._appData.panelInfo.upgradeBenefits=a.upgradeBenefits,this._appData.panelInfo.supportInfo=a.supportInfo)},isAppOnPage:function(a){var b=W.Viewer.getCompLogicById(a);return b&&!!b.getPageComponents().filter(function(a){return a._compId===this._compId},this).length},_handlePageNavigationChange:function(a){var b=W.Viewer.getCompLogicById(a),c=b.getPageComponents().map(function(a){return a._compId}).indexOf(this._compId)>-1;(this._getIsIframeShown()||c)&&this.handleAddEventListener(this._Events.PAGE_NAVIGATION_CHANGE,b)},_onDataChange:function(){this._initializeWithData()},_extractAppData:function(){if(this._applicationId=this._data.get("applicationId"),this.refreshAppData(),this._appData||this.resources.W.Config.env.$isPublicViewerFrame||!this.resources.W.TPA.isParentEditor())this._appDefinitionId=this._appData.appDefinitionId;else if(this._appDefinitionId=this._data.get("appDefinitionId"),this._appDefinitionId){var a=window.parent.W.AppStoreManager;if(a){var b=this.isWidget?a.TPA_WIDGET:a.TPA_SECTION,c=this._data.get("widgetId");a.provisionApp(b,this._appDefinitionId,c,function(){this.forceRender()}.bind(this))}}},_initializeWithData:function(){this._initialized||(this._extractAppData(),this.resources.W.Config.env.$isPublicViewerFrame&&LOG.reportEvent(wixEvents.APPS_FLOW_APP_LOADED_ON_VIEWER,{g1:this._appDefinitionId+" "+window.location.href,i1:this._applicationId}),this.registerComponent(),this._initialized=!0,this.onDataInitialized(this._appData))},getPageId:function(){return this._view&&this._view.$pageId},_onResize:function(){this.isRendered()&&this._initialized&&(this.parent(),this._overlayMessage&&this._overlayMessage.fireEvent("resize")),this._setIframeToViewSize()},_onResizeEnd:function(){this._appIsAlive&&this._skinParts&&this._renderIfReady(),this._setIframeToViewSize(),this._wCheckForSizeChangeAndFireAutoSized(3)},findParentPage:function(){function a(b){if(!b)return null;var c=b.getAttribute&&b.getAttribute("comp");if("mobile.core.components.Page"===c||"core.components.Page"===c)return b;var d=b.parentNode;return a(d)}var b=a(this._view);return b&&b.$logic},dispose:function(){this.isUnderMobileView()||this.handleAddEventListener.apply(this,[this._Events.COMPONENT_DELETED]),window.parent.W.Commands.unregisterListener(this),this.parent()},_renderIframe:function(){return this._isSafeMode()?void this._overlayWithSafeMode():(this.parent(),void this._fixIEInputFields())},_addPreconditionForDomCaptureReady:function(a){this._preconditionsForDomCaptureReady[a]=!1},_setPrecoditionForDomCaptureReady:function(a){this._preconditionsForDomCaptureReady[a]=!0,_.all(_.values(this._preconditionsForDomCaptureReady))&&this._view.fireEvent(Constants.ComponentEvents.DOM_DISPLAY_READY)},_fixIEInputFields:function(){if(window.Browser&&window.Browser.ie&&this.resources.W.Config.env.$isEditorViewerFrame)try{var a=document.createElement("input");a.setStyle("width",0),a.setStyle("height",0),document.body.insertBefore(a,document.body.firstChild),a.focus(),document.body.removeChild(a)}catch(b){}},_reportComponentAddedToStageBiEvent:function(a){if(this.isTpa){var b=this.getComponentId(),c=this.getAppDefinitionId(),d=this.getPageId(),e={g1:c,c1:d,c2:b};a&&(e.i2="template-app"),window.LOG.reportEvent(window.wixEvents.APPS_FLOW_APP_ADDED_TO_STAGE,e)}},_hasExtensions:function(){return this.appExtensionsService.hasExtensions(this._appData)
},_getSettingsHeight:function(a){var b=this._getWidgetExtensionByWidgetId(a);return b&&b.settings&&b.settings.height||this._appData.settingsHeight},_getWidgetExtensionByWidgetId:function(a){return this._appData.widgets?this._appData.widgets[a]:null},getMultiplePackages:function(a){this.resources.W.TPA.getAppMarketData(this.getAppDefinitionId(),function(b){a(this.hasMultiplePackages(b))}.bind(this))},hasMultiplePackages:function(a){var b=a&&a.packages&&a.packages[0];return b&&a.packages[0].yearly&&a.packages[0].yearly.price},getPremiumYearlyPrice:function(a){var b=a&&a.packages&&a.packages[0];return b&&a.packages[0].yearly&&a.packages[0].yearly.price},getApplicationId:function(){return this._applicationId}})}),define.component("tpa.viewer.components.TPAWidget",function(a){var b=a;b.inherits("tpa.viewer.components.TPAViewerBase"),b.utilize(["tpa.viewer.managers.ViewerUrlBuilder"]),b.dataTypes(["TPAWidget"]),b.methods({isWidget:!0,initialize:function(a,b,c){this.parent(a,b,c),this._isSelectable=!0},getWidgetId:function(){return this._data.get("widgetId")},onDataInitialized:function(a){this.parent(a);var b=this.getWidgetId(),c=this.resources.W.Viewer.getAppDataHandler(),d=c.getWidgetProperty(this._applicationId,b,"refreshOnWidthChange");d||this.removeEvent("resizeEnd",this._onResizeEnd)},_getBaseUrl:function(){var a=this._getWidgetData();if(this.isUnderMobileView()){var b=a.mobileUrl&&(this.isInDevMode()||!!a.mobilePublished);return b?a.mobileUrl:a.widgetUrl}return a.widgetUrl},_getWidgetData:function(){var a=this.getWidgetId();return this.resources.W.Viewer.getAppDataHandler().getWidgetData(this._applicationId,a)},_buildUrl:function(){return new this.imports.ViewerUrlBuilder(this._getBaseUrl(),this).addArbitraryQueryParams(this._queryParams).addCacheKiller().addCompId().addDeviceType().addInstance().addLocale().addViewMode().addWidth().build()},handleAppStateChanged:function(){},handleClosePopup:function(){},isSelectable:function(){return this._isSelectable},isDeleteableRecurse:function(){return!0}})}),define.component("tpa.viewer.components.Thumbnails",function(a){a.inherits("tpa.viewer.components.TPAGallery"),a.propertiesSchemaType("ThumbnailsProperties"),a.resources(["W.Experiments"]),a.fields({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}},indexName:"Thumbnails",isTpa:!1}),a.methods({initialize:function(a,b,c){this.parent(a,b,c),this.styleProps={textColor:"color1",descriptionColor:"color2",textBackgroundColor:"color3"}}})}),define.experiment.component("tpa.viewer.components.Accordion.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{allInputsHidden:!0}}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.Class("tpa.viewer.classes.ClientSpecMapLoader.SpecLoaderError",function(a,b){a.binds(b.merge(["_logError"])),a.methods({_handleTimeout:b.before(function(){this._logError(window.wixErrors.TPA_LOAD_CLIENT_SPEC_MAP_TIMEOUT,"AJAX load failed with timeout")}),_handleAjaxError:b.before(function(a,b){this._logError(window.wixErrors.TPA_LOAD_CLIENT_SPEC_MAP_ERROR,"AJAX try "+this._currentAjaxAttemptNumber+" failed: "+b,this._extractHeaders(a))}),_logError:function(a,b,c){if(a&&window.LOG&&window.wixErrors){var d=this._getTimeForPerformance()-this._startTime,e=b+" "+d;c&&(e+=" seen:"+c.seen+", server:"+c.server),window.LOG.reportError(a,"tpa.viewer.classes.ClientSpecMapLoader","",e)}}})}),define.experiment.Class("tpa.viewer.classes.ClientSpecMapLoader.SpecLoaderError",function(a,b){a.methods({_handleAjaxSuccess:b.after(function(a){var b=this._getTimeForPerformance()-this._startTime,c=this._extractHeaders(a);LOG.reportEvent(window.wixEvents.CSM_LOADED_SUCCESSFULLY,{c1:b,g1:c.seen,i1:window.rendererModel&&window.rendererModel.userId,g2:c.server})})})}),define.experiment.component("tpa.viewer.components.Collage.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.Freestyle.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.Honeycomb.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.Impress.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}]}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.Masonry.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.StripShowcase.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.StripSlideshow.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.TPA3DCarousel.EditorMetaDataRelocation",function(a,b){var c=b;a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"TPA3DGallery"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:c.remove()})}),define.experiment.component("tpa.viewer.components.TPA3DGallery.EditorMetaDataRelocation",function(a,b){var c=b;a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"TPA3DGallery"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:c.remove()})}),define.experiment.component("tpa.viewer.components.TPAComponent.EditorMetaDataRelocation",function(a,b){var c=a;c.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1}}}),c.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.TPAGallery.BoxSlideShow",function(a){a.methods({canBeDraggedIntoBoxSlideShow:function(){return!1}})}),define.experiment.component("tpa.viewer.components.TPAGallery.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"TPA3DCarousel"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}]}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.TPAGluedWidget.EditorMetaDataRelocation",function(a,b){var c=a,d=b;c.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1,disableMoveForward:!0,disableMoveBackward:!0},custom:[{label:"APPS_SETTINGS_APPS",command:"WEditorCommands.OpenTPASettingsDialog"}],dblClick:{label:"APPS_SETTINGS_APPS",command:"WEditorCommands.OpenTPASettingsDialog"}}}),c.fields({EDITOR_META_DATA:d.remove()})}),define.experiment.Class("tpa.common.managers.TPAManager.EditorLoadPerPage",function(a,b){var c=a,d=b;c.methods({_onViewerReady:d.after(function(a){this.registerTPAPageConfiguration(a)})})}),define.experiment.Class("tpa.common.managers.TPAManager.TPAScript.New",function(a,b){var c=a,d=b;c.resources(d.merge(["W.Classes"])),c.fields({worksStack:[]}),c.methods({runScript:function(a,b){this.resources.W.Classes.getClass("wysiwyg.common.managers.scripting.ScriptingWorkerWrapper",function(c){var d=new c(b);this.worksStack[d.getCompId()]=d,d.run(a)}.bind(this))},handlePostMessage:function(a,b){if("string"==typeof a.data){var c="";try{c=JSON.parse(a.data)}catch(d){return}var e=c.type;c&&c.intent&&(c.intent===this.TPA_MESSAGE&&e?this._handleTPAMessage(c,e,b):c.intent===this.APP_MARKET_MESSAGE?this._handleAppMarketMessage(c):c.intent===this.TPA_MESSAGE2&&e&&this._handleTPAMessage2(c,this.getCallerContext(this)))}},getCallerContext:function(a){var b={getCaller:function(a){var b=$(a);return b&&b.getLogic()},sendToCaller:function(b,c){var d=JSON.stringify({intent:a.TPA_RESPONSE,compId:b.compId,callId:b.callId,type:b.type,res:c,status:!0});this.getIFrame().contentWindow.postMessage(d,"*")}};return b},_handleTPAMessage2:function(a,b){var c=b.getCaller(a.compId);if(c)if(Object.contains(this.MessageTypes,a.type)){var d=this._getHandlerFunctionName(a.type),e=c[d];"function"==typeof e?e.call(c,{msgData:a.data,callback:b.sendToCaller.bind(c,a)}):LOG.reportError("Handler function not found - "+a.type,"tpa.viewer.managers.TPA","handlePostMessage2")}else LOG.reportError("Unknown post message type - "+a.type,"tpa.viewer.managers.TPA","handlePostMessage")}})}),define.experiment.component("tpa.viewer.components.TPAPlaceholder.EditorMetaDataRelocation",function(a,b){var c=a,d=b;c.statics({EDITOR_META_DATA:{general:{title:"App Placeholder",settings:!0,design:!1,animation:!1},custom:[{label:"SIDE_BTN_MARKET",command:"WEditorCommands.Market",commandParameterDataRef:"SELF"}],dblClick:{command:"WEditorCommands.Market",commandParameterDataRef:"SELF"}}}),c.fields({EDITOR_META_DATA:d.remove()})}),define.experiment.component("tpa.viewer.components.TPAPlaceholder.WixStaff",function(a){a.fields({propertiesSchemaName:"WPhotoProperties",EDITOR_META_DATA:{general:{title:"App Placeholder",settings:!0,design:!1},custom:[{label:"PHOTO_REPLACE_IMAGE",command:"WEditorCommands.OpenImageDialog",commandParameter:{galleryTypeID:"photos"},commandParameterDataRef:"SELF"}],dblClick:{command:"WEditorCommands.Market",commandParameterDataRef:"SELF"}}})}),define.experiment.component("tpa.viewer.components.TPAViewerBase.EditorMetaDataRelocation",function(a){a.methods({_onAllSkinPartsReady:function(){var a=_.some(this.EDITOR_META_DATA.custom,{label:"TPA_APP_EXTENSIONS"});this.parent(),this._addEventListeners(),this.EDITOR_META_DATA=_.clone(this.EDITOR_META_DATA),this.EDITOR_META_DATA.custom=_.clone(this.EDITOR_META_DATA.custom),this._isSafeMode()&&this.EDITOR_META_DATA.custom.push({label:"Load Iframe",command:"WEditorCommands.LoadTpaIframe",commandParameter:this._appData}),this._hasExtensions()&&!a&&this.EDITOR_META_DATA.custom.push({label:"TPA_APP_EXTENSIONS",command:"WEditorCommands.OpenTPAAppExtensionsDialog",commandParameter:{appData:this._appData,origin:"fpp"}})}})}),define.experiment.component("tpa.viewer.components.Thumbnails.EditorMetaDataRelocation",function(a,b){a.statics({EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"GALLERY_ORGANIZE_PHOTOS",command:"WEditorCommands.OpenListEditDialog",commandParameter:{galleryConfigID:"photos"},commandParameterDataRef:"SELF"},{label:"CHANGE_GALLERY_TYPE",command:"WEditorCommands.OpenChangeGalleryDialog",commandParameter:{}}],mobile:{previewImageDataRefField:"*"}}}),a.fields({EDITOR_META_DATA:b.remove()})}),define.experiment.component("tpa.viewer.components.Accordion.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.Collage.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.Freestyle.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.Honeycomb.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.Impress.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.Masonry.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.StripShowcase.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.StripSlideshow.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.TPA3DCarousel.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})})}),define.experiment.component("tpa.viewer.components.TPA3DGallery.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})})}),define.experiment.component("tpa.viewer.components.TPAGallery.OrganizeImages",function(a,b){a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.experiment.component("tpa.viewer.components.Thumbnails.OrganizeImages",function(a,b){a.fields({EDITOR_META_DATA:b.merge({dblClick:{command:"WEditorCommands.OpenOrganizeImagesDialog"}})}),a.methods({initialize:b.before(function(){this.EDITOR_META_DATA.custom[0].command="WEditorCommands.OpenOrganizeImagesDialog"})})}),define.Class("tpa.viewer.managers.TPASiteManager",function(a){var b=a;b.inherits("bootstrap.managers.BaseManager"),b.binds(["_handleClientSpecMapLoadSuccess","_handleClientSpecMapLoadFailure","_handleClientSpecMapLoadCompleted"]),b.utilize(["tpa.viewer.classes.ClientSpecMapLoader","tpa.viewer.classes.PixelTracker","tpa.viewer.classes.TPAWorker"]),b.resources(["W.Viewer","W.Config","W.TPA"]),b.methods({initialize:function(){this.parent(),this._isReady=!1;var a=new this.imports.ClientSpecMapLoader(this._handleClientSpecMapLoadSuccess,this._handleClientSpecMapLoadFailure);a.loadClientSpecMap()},isReady:function(){return this._isReady},_handleClientSpecMapLoadSuccess:function(a){this.resources.W.Config.setSessionData({hs:a.hs,svSession:a.svSession}),window.rendererModel.origClientSpecMap=window.rendererModel.clientSpecMap,window.rendererModel.clientSpecMap=a.clientSpecMap,this._handleClientSpecMapLoadCompleted()},_handleClientSpecMapLoadFailure:function(){this._handleClientSpecMapLoadCompleted()},_handleClientSpecMapLoadCompleted:_.once(function(){this._isReady=!0,this._registerPixelTracker(),this._registerWorkerEvents(this.resources.W.Viewer.getAppDataHandler().getAppsData())}),_registerPixelTracker:function(){var a=this.resources.W.Viewer,b=new this.imports.PixelTracker(this.resources.W.Viewer.getAppDataHandler().getAppsData());a.addEvent("pageTransitionEnded",b._sendPixelTrackerRequests.bind(b))},_registerWorkerEvents:function(a){var b,c=this,d=this.resources.W.TPA,e=_.filter(a,function(a){return a.installedAtDashboard&&_.isString(a.appWorkerUrl)});d.workers=d.workers||{},_.forEach(e,function(a){b=new c.imports.TPAWorker(a),b.attachTo(document.body);var e=b.getComponentId();d.workers[e]=b})}})}),define.experiment.newClass("tpa.viewer.managers.TPAWorkerWrapper.TPAScript.New",function(a){var b=a;b.traits(["tpa.viewer.traits.TPAHandlers"]),b.resources(["W.TPA","topology"]),b.statics({TPA_SCRIPT_WORKER:"TPA_Script_Worker",API_URL:"http://wysiwyg.pita.wixpress.com/js-sdk/1.17.0/js/Wix.js"}),b.methods({initialize:function(a){this.forceIframe=a,this.compId=this._createCompId(),this.iframePolyfill()},getCompId:function(){return this.compId},iframePolyfill:function(){(!window.Worker||this.forceIframe)&&(window.Worker=function(a){var b=function(b,c){var d=this,e=function(){f(),h()},f=function(){window.addEventListener?window.addEventListener("message",j,!1):window.attachEvent("onmessage",j)},g=function(){window.removeEventListener?window.removeEventListener("message",j,!1):window.detachEvent("onmessage",j)},h=function(){d.iframeEl=document.createElement("iframe"),d.iframeEl.style.visibility="hidden",d.iframeEl.style.display="none",d.iframeEl.style.width="1px",d.iframeEl.style.height="1px",d.iframeEl.id=c,d.iframeEl.src=[a,"/html/external/worker-iframe.html?compId=",c].join(""),document.body.appendChild(d.iframeEl)},i=function(){d.postMessage(JSON.stringify({compId:c,blob:b}))},j=function(a){var b;try{b=JSON.parse(a.data)}catch(e){return}b.compId===c&&(b.ready?i():b.terminate?d.terminate():b.error&&d.onerror?d.onerror.call(this,b.error):d.onmessage&&d.onmessage.call(this,a))};this.postMessage=function(a){d.iframeEl.contentWindow.postMessage(a,"*")},this.terminate=function(){document.body.removeChild(d.iframeEl),g()},e()};return b}(this.resources.topology.wysiwyg))},run:function(a){var b=this._createBlob(a);this.worker=new Worker(b,this.compId),this.worker.onmessage=this._handlePostMessage.bind(this),this.worker.onerror=this._handlePostMessageError.bind(this)},terminate:function(){this.worker.terminate()},_createBlob:function(a){var b=['wix_sdk_globals ={ compId:"{compId}", workerMode:true };','importScripts("{api}");',"{script}"].join("");return a=this._isUrl(a)?['importScripts("',a,'");'].join(""):["(",a.toString(),")();"].join(""),b=b.substitute({compId:this.compId,api:this.API_URL,script:a}),window.Blob&&!this.forceIframe?window.URL.createObjectURL(new Blob([b])):b},_handlePostMessage:function(a){var b=JSON.parse(a.data);switch(b.intent){case this.resources.W.TPA.TPA_MESSAGE2:this._handleTPAScript(b);break;case this.TPA_SCRIPT_WORKER:this._handleWorkerNativeFunctions(b)}},_handlePostMessageError:function(a){alert("Error: Line "+a.lineno+" in "+a.filename+": "+a.message)},_handleTPAScript:function(a){this.resources.W.TPA._handleTPAMessage2(a,this.getCallerContext())},getCallerContext:function(){var a=this,b={getCaller:function(){return a},sendToCaller:function(b,c){a.worker.postMessage(JSON.stringify({intent:a.resources.W.TPA.TPA_RESPONSE,compId:a.compId,callId:b.callId,type:b.type,res:c,status:!0}))}};return b},_getHandlerFunctionName:function(a){return"handle"+a.capitalize()},_handleWorkerNativeFunctions:function(a){switch(a.func){case"console":console[a.method](a.message);break;case"alert":alert(a.message)}},_isUrl:function(a){var b=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;return b.test(a)},_createCompId:function(){return"TPAScript-xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}})}),define.Class("tpa.viewer.managers.ViewerUrlBuilder",function(a){var b=a;b.resources(["W.Viewer"]),b.inherits("tpa.common.managers.UrlBuilder"),b.methods({initialize:function(a,b,c){c=c||{},this.parent(a,b,c),this._wViewer=c.wViewer||this.resources.W.Viewer},_getCurrentPageId:function(){return this._wViewer.getCurrentPageId()},_getSectionUrlHashStringForPage:function(a){var b=a.getID(),c=a.getDataItem(),d=c&&c.get("pageUriSEO");return this._getSectionUrlHashStringForPageIdAndTitle(b,d)},_getSectionUrlHashStringForPageIdAndTitle:function(a,b){b=b||"title";var c=this.resources.W.Utils.hash.getHashPartsString(a,b);return c+="/"},_getSectionUrlHashString:function(a){var b=a.findParentPage&&a.findParentPage();if(b)return this._getSectionUrlHashStringForPage(b);var c=this._getCurrentPageId();return c=c||"NoPage",this._getSectionUrlHashStringForPageIdAndTitle(c)},_getSectionUrl:function(a){var b=this._getSectionUrlHashString(a),c=this._href.replace(this._fragment,"");return c+="#!"+b},addSectionUrlAndTarget:function(){switch(this._viewMode){case"site":this._urlParams["section-url"]=this._getSectionUrl(this._component),this._urlParams.target="_top";break;case"preview":case"editor":this._urlParams["section-url"]=this._baseUrl,this._urlParams.target="_self"}return this}})}),define.skin("tpa.viewer.skins.TPAMobileModalSkin",function(a){var b=a;b.inherits("mobile.core.skins.BaseSkin"),b.skinParams([{id:"bg-block",type:Constants.SkinParamTypes.BG_COLOR,mutators:["alpha",75],defaultValue:"#555555"},{id:"tdr",type:Constants.SkinParamTypes.URL,defaultTheme:"BASE_THEME_DIRECTORY"},{id:"shd",type:Constants.SkinParamTypes.BOX_SHADOW,defaultValue:"4px 4px 15px rgba(0, 0, 0, 0.4)"},{id:"rd",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"3px"}]),b.html('<div skinPart="blockingLayer"></div><div skinpart="dialog"><div skinpart="frameWrap"><iframe skinpart="iframe" src="about:blank" width="100%" height="100%" webkitAllowFullScreen="true" mozallowfullscreen="true" allowfullscreen="allowfullscreen" frameborder="0" ></iframe><div skinpart="xButton"></div></div></div>'),b.css(["{ position:fixed; width:100%; height:100%; z-index: 99999 }","%blockingLayer% { display:none; }","%dialog% { position:fixed; top: 0; left:0; width: 100%; height: 100%; margin: 0; }%","%frameWrap% { overflow:hidden; background:#fff;  width:100%; height:100%; position: relative; [shd] [rd] }","%iframe% { position:absolute; width:100%; height:100%; [rd]}","%xButton% {top: 0; right:0; background:url([tdr]x_button.png) no-repeat; background-size:cover; width: 50px; height:50px; position:fixed }"])}),define.skin("tpa.viewer.skins.TPAModalSkin",function(a){var b=a;b.inherits("mobile.core.skins.BaseSkin"),b.skinParams([{id:"bg-block",type:Constants.SkinParamTypes.BG_COLOR,mutators:["alpha",75],defaultValue:"#555555"},{id:"tdr",type:Constants.SkinParamTypes.URL,defaultTheme:"BASE_THEME_DIRECTORY"},{id:"rd",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"1px"}]),b.html('<div skinPart="blockingLayer"></div><div skinpart="dialog"><div skinpart="frameWrap"><iframe skinpart="iframe" src="about:blank" width="100%" height="100%" webkitAllowFullScreen="true" mozallowfullscreen="true" allowfullscreen="allowfullscreen" frameborder="0" ></iframe><div skinpart="errorMessage"></div><div skinpart="xButton">&#x00D7</div></div></div>'),b.css(["{ position:fixed; width:100%; height:100%; z-index:99 }","%blockingLayer% { [bg-block]; position:fixed; top:0; bottom:0; left:0; right:0; width:100%; height:100%; overflow:hidden; z-index: 999;}","%dialog% { position:fixed; top: 50%; left:50%; width: 200px; height: 200px; margin-top:-100px; margin-left:-100px; z-index: 1000}%","%frameWrap% { overflow:hidden; background:#fff;  width:100%; height:100%; position: relative; z-index: 1001; border: 1px solid #e8e2e2; }","%iframe% { position:absolute; width:100%; height:100%; [rd]}","%xButton% {position:absolute; z-index: 1002; margin-top:4px; right:9px; position: absolute; font-family: courier; font-size: 24px; font-weight: bold; cursor: pointer; color: #a1a1a1;}","%xButton%:hover {color: #373737;}"])}),define.skin("tpa.viewer.skins.TPAPlaceholderSkin",function(a){var b=a;b.inherits("mobile.core.skins.BaseSkin"),b.skinParams([{id:"contentPaddingLeft",type:Constants.SkinParamTypes.SIZE,defaultValue:"0px",noshow:!0,usedInLogic:!0},{id:"contentPaddingRight",type:Constants.SkinParamTypes.SIZE,defaultValue:"0px",noshow:!0,usedInLogic:!0},{id:"contentPaddingBottom",type:Constants.SkinParamTypes.SIZE,defaultValue:"0px",noshow:!0,usedInLogic:!0},{id:"contentPaddingTop",type:Constants.SkinParamTypes.SIZE,defaultValue:"0px",noshow:!0,usedInLogic:!0}]),b.html('<div skinPart="container"><div skinPart="img" skin="mobile.core.skins.ImageNewSkin"></div><a skinPart="link"></a></div>'),b.css(["%container% { display:block; overflow:hidden;}","%link% { display:none;}"])}),define.skin("tpa.viewer.skins.TPAPopupSkin",function(a){var b=a;b.inherits("mobile.core.skins.BaseSkin"),b.skinParams([{id:"bg-block",type:Constants.SkinParamTypes.BG_COLOR,mutators:["alpha",75],defaultValue:"#555555"},{id:"tdr",type:Constants.SkinParamTypes.URL,defaultTheme:"BASE_THEME_DIRECTORY"},{id:"shd",type:Constants.SkinParamTypes.BOX_SHADOW,defaultValue:"4px 4px 15px rgba(0, 0, 0, 0.4)"},{id:"rd",type:Constants.SkinParamTypes.BORDER_RADIUS,defaultValue:"3px"}]),b.html('<div skinpart="frameWrap"><div skinpart="x"></div><iframe skinpart="iframe" src="about:blank" width="100%" height="100%" webkitAllowFullScreen="true" mozallowfullscreen="true" allowfullscreen="allowfullscreen" frameborder="0" scrolling="no" style="z-index: 1000;"></iframe><div skinpart="errorMessage"></div></div>'),b.css(["{ background:#fff; overflow:hidden; z-index:999; [shd] [rd] }"," iframe { position: absolute}","%x% {position:absolute; z-index: 1001; top:10px; right:10px; cursor:pointer; background:transparent url([tdr]popup_close_x.png) no-repeat right top; height:24px; width:24px; }"])}),function(){var a=["%iframe% { overflow:hidden; position: absolute; width:100%; height:100%; display: block; }",'[state~="iframeNotShown"] %iframe% { display:none; }','[state~="iframeRenderedInvisible"] %iframe% { visibility: hidden; }'],b='<iframe skinpart="iframe" src="about:blank" width="100%" height="100%" webkitAllowFullScreen="true" mozallowfullscreen="true" allowfullscreen="allowfullscreen" frameborder="0" scrolling="no" allowTransparency="true" ></iframe>',c=function(c){c.inherits("mobile.core.skins.BaseSkin"),c.fields({isDynamicStyle:!0}),c.html(b),c.css(a)},d=function(c){c.inherits("mobile.core.skins.BaseSkin"),c.html(b),c.css(a),c.skinParams([{id:"color1",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_15"},{id:"color2",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_15"},{id:"color3",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_15"},{id:"color4",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_15"},{id:"color5",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_15"},{id:"version",type:Constants.SkinParamTypes.SIZE,defaultValue:"1"}])};define.skin("tpa.viewer.skins.TPASectionSkin",c),define.skin("tpa.viewer.skins.TPAWidgetSkin",c),define.skin("tpa.viewer.skins.TPA3DGallerySkin",d),define.skin("tpa.viewer.skins.TPA3DCarouselSkin",d),define.skin("tpa.viewer.skins.TPAMasonrySkin",d),define.skin("tpa.viewer.skins.TPAAccordionSkin",d),define.skin("tpa.viewer.skins.TPAFreestyleSkin",d),define.skin("tpa.viewer.skins.TPAStripSlideshowSkin",d),define.skin("tpa.viewer.skins.TPAStripShowcaseSkin",d),define.skin("tpa.viewer.skins.TPAThumbnailsSkin",d),define.skin("tpa.viewer.skins.TPACollageSkin",d),define.skin("tpa.viewer.skins.TPAHoneycombSkin",d),define.skin("tpa.viewer.skins.TPAFreestyleSkin",d),define.skin("tpa.viewer.skins.TPAEcomGallerySkin",d),define.skin("tpa.viewer.skins.TPAImpressSkin",function(c){c.inherits("mobile.core.skins.BaseSkin"),c.html(b),c.css(a),c.skinParams([{id:"color1",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_13"},{id:"color2",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_18"},{id:"color3",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_23"},{id:"color4",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_28"},{id:"color5",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_33"},{id:"color6",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_1"},{id:"color7",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_1"},{id:"color8",type:Constants.SkinParamTypes.COLOR,defaultTheme:"color_2"}])})}(),define.Class("tpa.viewer.traits.TPAFullWidthComponent",function(a){function b(){clearTimeout(this._resizeTimeoutTickt);var a=this;this._resizeTimeoutTickt=setTimeout(function(){a.getIsDisplayed()&&a._setFullWidthContainerWidth()},10)}function c(){var a={};return _.each(_.keys(d),function(b){a[b]=function(){return this.isFullWidthContainer?d[b].apply(this,arguments):this.parent.apply(this,arguments)}}),a}a.resources(["W.Viewer"]),a.binds(["_setFullWidthContainerWidth"]);var d={isContainable:function(a){return instanceOf(a,this.constructor)},setX:function(){},getX:function(){return 0},_setFullWidthContainerWidth:function(){this._view.style.overflow="visible";var a=$(document).getSize(),b=a.x,c=this._skinParts.iframe.style;
c.position="absolute";var d=this.resources.W.Viewer.getDocWidth(),e=d>b?0:Math.round((b-d)/2);this.isUnderMobileView()&&(b=this.resources.W.Viewer.getDocWidth(),e=0),c.left=0-e+"px",c.width=b+"px"},getSelectableX:function(){var a=parseInt(this._skinParts.iframe.style.left,10);return a},getSelectableWidth:function(){var a=$(document).getSize().x;return this.isUnderMobileView()&&(a=this.resources.W.Viewer.getDocWidth()),a}};a.methods(_.extend(c(),{initFullWidthContainer:function(){this.isFullWidthContainer||(this._skinParts&&this.setX(0),this.isFullWidthContainer=!0,this._resizableSides=[Constants.BaseComponent.ResizeSides.TOP,Constants.BaseComponent.ResizeSides.BOTTOM],this._moveDirections=[Constants.BaseComponent.MoveDirections.VERTICAL],this._onScreenResize=this._onScreenResize||b.bind(this),window.addEvent("resize",this._onScreenResize,!1),this._skinParts&&(this._setFullWidthContainerWidth(),this.updateEditBox()))},destroyFullWidthContainer:function(){this.isFullWidthContainer&&(this.isFullWidthContainer=!1,this._resizableSides=[Constants.BaseComponent.ResizeSides.TOP,Constants.BaseComponent.ResizeSides.BOTTOM,Constants.BaseComponent.ResizeSides.LEFT,Constants.BaseComponent.ResizeSides.RIGHT],this._moveDirections=[Constants.BaseComponent.MoveDirections.VERTICAL,Constants.BaseComponent.MoveDirections.HORIZONTAL],window.removeEvent("resize",this._onScreenResize,!1),this._skinParts&&(this._skinParts.iframe.style.left="0",this._skinParts.iframe.style.width="100%",this.render(),this.updateEditBox()))},updateEditBox:function(){try{window.parent.W.Editor.getComponentEditBox().fitToComp()}catch(a){}},render:function(){this.parent(),this.isFullWidthContainer&&this._setFullWidthContainerWidth()},dispose:function(a){this.destroyFullWidthContainer(),this.parent(a)}}))}),define.Class("tpa.viewer.traits.TPAHandlers",function(a){var b=a;b.inherits("tpa.common.traits.TPAHandlersBase"),b.utilize(["core.managers.components.ComponentBuilder","tpa.common.services.PageToWidgetService"]),b.statics({DEFAULTS:{POPUP_COORDINATES:{NORMAL:{top:"auto",left:"auto",bottom:"auto",right:"auto",width:500,height:500},MODAL:{top:"50%",left:"50%",bottom:"auto",right:"auto",width:500,height:500}}},MESSAGE_QUEUE_LIMIT:250}),b.resources(["W.Components","W.Data","W.Config","W.Commands","topology"]),b.binds(["handleSiteInfo"]),b.methods({initialize:function(){this._datam=this.resources.W.Data},handleHeightChanged:function(a){var b="number"==typeof a?a:a.msgData.height;this.handleChangeAppSize({height:b})},handleChangeAppSize:function(a){this.resources.W.Config.env.isInInteractiveViewer()&&(a.width=null,a.w=null,a.x=null),this._changeSize(a)},handleAppSettingsClose:function(a){this.handleCloseWindow(a)},_initStylesHandling:function(a){this.updateAfterStyleChange=this.updateAfterStyleChange.bind(this),this.resources.W.Theme.addEvent("propertyChange",this.updateAfterStyleChange),this.resources.W.Commands.registerCommandAndListener("W.CssCommands.CharacterSetChange",this,this.updateAfterStyleChange),this.addDisposeHandler(function(){this.resources.W.Commands.unregisterListener(this.updateAfterStyleChange),this.resources.W.Theme.removeEvent("propertyChange",this.updateAfterStyleChange)}.bind(this)),a(this._getDataToPassIntoApp())},handleGetStyleParams:function(a){a.callback(this.getStylesForSDK())},handleOpenPopup:function(a){var b,c,d,e,f,g=this.resources.W.Viewer.getSiteNode(),h="BARE"===a.msgData.theme;c="tpa.viewer.components.TPAPopup",d=h?"tpa.viewer.skins.TPAWidgetSkin":"tpa.viewer.skins.TPAPopupSkin",f=this._transformToWidgetDataItem(this._data),e=this._getPopupArgs(a.msgData||a,a.callback),b=this.resources.W.Components.createComponent(c,d,f,e,null,null),b.insertInto(g)},handleOpenModal:function(a){var b=this.resources.W.Viewer.getSiteNode();this._clearModals(b);var c,d,e,f,g=a.msgData||a,h=this.resources.W.Config.env.isViewingSecondaryDevice();c="tpa.viewer.components.TPAModal",d=h?"tpa.viewer.skins.TPAMobileModalSkin":"tpa.viewer.skins.TPAModalSkin",e={url:g.url,width:g.width,height:g.height,onClose:a.callback,origCompId:this.getComponentId()},f=this._transformToWidgetDataItem(this._data);var i=new Element("div"),j=new this.imports.ComponentBuilder(i);j.withType(c).withSkin(d).withArgs(e).withData(f).withIdPrefix(this.resources.W.Viewer.getCurrentPrefix()).onCreated(function(a){a._view.insertInto(b)}).create()},_transformToWidgetDataItem:function(a){function b(b){d[b]=a.get(b)}var c="TPAWidget";if(a.getType()===c)return a;var d={type:c},e=this.resources.W.Data.getDataTypeSchema(c),f=_(e).keys().without("extends");return f.forEach(b),this.resources.W.Data.createDataItem(d)},handleNavigateToPage:function(a){a.msgData.pageId&&!this.resources.W.Config.env.$isEditorFrame&&this.resources.W.Viewer.goToPage(a.msgData.pageId)},handleSmRequestLogin:function(a){var b=this.injects().SiteMembers;b.isServiceProvisioned()&&(b.isApiReady()?this.injects().Commands.executeCommand("WViewerCommands.SiteMembers.Open",{form:"login",authCallback:a.callback,initiator:this.getAppDefinitionId()||"TPA"}):this.callLater(this.handleSmRequestLogin,a))},handleScrollBy:function(a){window.scrollBy(a.msgData.x,a.msgData.y)},handleScrollTo:function(a){window.scrollTo(a.msgData.x,a.msgData.y)},handlePostActivity:function(a){var b=a.msgData,c=this.getAppData().instance,d=function(b){a.callback({status:!0,response:b})},e=function(b){var c={status:b.status,statusText:b.statusText,responseText:b.responseText};a.callback({status:!1,response:c})};W.Commands.executeCommand("WViewerCommands.Activity.Report",{name:"TPA",fields:{type:b.activity.type||"TPA",appDefinitionId:this.getAppDefinitionId()||"TPA",info:b.activity.info||{},details:b.activity.details||{},instance:c},callbacks:{onSuccess:d,onError:e}})},handleGetCurrentPageId:function(a){a.callback(this.getPageId())},handleGetUserSession:function(a){a.callback(this.resources.W.Config.getSvSession())},handleBoundingRectAndOffsets:function(a){var b={rect:this._view.getBoundingClientRect(),offsets:this._view.getOffsets()};a.callback(b)},handleNavigateToSectionPage:function(a){var b=new this.imports.PageToWidgetService(this._datam),c=b.mapPageToWidgets(),d=this.getAppData(this.getAppDefinitionId()),e=d.applicationId;if(_.isEmpty(c)||_.isUndefined(c[e]))a.callback({error:{message:'Page with app "'+d.appDefinitionName+'" was not found.'}});else{var f,g,h=a.msgData,i=c[e];if(_.isObject(a.msgData)&&(h=a.msgData.state,g=a.msgData.sectionIdentifier&&a.msgData.sectionIdentifier.sectionId),_.isUndefined(g))f=i[0].pageId,this.resources.W.Viewer.goToPage(f,h);else{var j=_.find(i,function(a){return a.tpaPageId===g});_.isUndefined(j)?a.callback({error:{message:'App page with sectionId "'+g+'" was not found.'}}):this.resources.W.Viewer.goToPage(j.pageId,h)}}},_clearModals:function(a){var b=a.getChildren("[comp=tpa.viewer.components.TPAModal]");b.dispose()},_getPopupArgs:function(a,b){var c=a&&a.position&&a.position.origin||"FIXED";return c=this.isPage&&"RELATIVE"===c?"FIXED":c,{dataItem:this._data,url:a.url,origCompId:this.getComponentId(),origin:c,placement:a.position.placement,openPosition:this._view.getPosition(),openSize:this._view.getSize(),popupSize:{x:a.width||200,y:a.height||200},openPopupPosition:{x:a.position.x||0,y:a.position.y||0},onClose:b}}})}),define.Class("tpa.viewer.traits.TPAHandlersViewerCommons",function(a){var b=a;b.resources(["W.Config","W.Data"]),b.fields({_renderTriggers:[Constants.DisplayEvents.DISPLAY_CHANGED],MIN_SIZE:{w:10,h:10},EDITOR_META_DATA:{general:{settings:!0,design:!1,animation:!1},custom:[{label:"APPS_SETTINGS_APPS",command:"WEditorCommands.OpenTPASettingsDialog"}],dblClick:{label:"APPS_SETTINGS_APPS",command:"WEditorCommands.OpenTPASettingsDialog"},mobile:{hidePanel:!0}},TPA_PUB_SUB_PREFIX:"TPA_PUB_SUB_",_LOCAL_EVENTS:{SCROLL:"SCROLL",PAGE_NAVIGATION:"PAGE_NAVIGATION",PAGE_NAVIGATION_IN:"PAGE_NAVIGATION_IN",PAGE_NAVIGATION_OUT:"PAGE_NAVIGATION_OUT",STATE_CHANGED:"STATE_CHANGED"},_Events:{EDIT_MODE_CHANGE:"WPreviewCommands.WEditModeChanged",PAGE_NAVIGATION_CHANGE:"pageTransitionEnded",SITE_PUBLISHED:"WEditorCommands.Publish",COMPONENT_DELETED:"COMPONENT_DELETED",APP_MESSAGE:"SETTINGS_UPDATED",WINDOW_PLACEMENT_CHANGED:"WINDOW_PLACEMENT_CHANGED",THEME_CHANGE:"THEME_CHANGE",STYLE_PARAMS_CHANGE:"STYLE_PARAMS_CHANGE"}}),b.methods({handleGetSitePages:function(a){var b=this.resources.W.Data,c=b.getDataByQuery("#MAIN_MENU"),d=c.getItems()||[],e=this._getSitePages(b,d);a.callback(e)},handleAddEventListener:function(a,b){var c,d={intent:"addEventListener",eventType:"",params:{}};switch(a){case"WPreviewCommands.WEditModeChanged":c="EDIT_MODE_CHANGE",d.params={editMode:this._getCurrentEditMode()};break;case"pageTransitionEnded":c="PAGE_NAVIGATION_CHANGE",d.params=this._getPageParameters(b);break;case"WEditorCommands.Publish":c="SITE_PUBLISHED";break;case this._Events.COMPONENT_DELETED:c=a;break;case this._Events.THEME_CHANGE:case this._Events.STYLE_PARAMS_CHANGE:case this._Events.APP_MESSAGE:case this._Events.WINDOW_PLACEMENT_CHANGED:default:d.params=b,c=a}d.eventType=c,this.sendPostMessage(d)},handleRemoveEventListener:function(a){var b=this._LOCAL_EVENTS[a.msgData.eventKey];this.$appliedEvents[b]&&this.$appliedEvents[b].dispose()},handlePublish:function(a){var b=this.getAppDefinitionId(),c=a.msgData;c.appDefinitionId=c.appDefinitionId||b,c.origin=c.origin||this.getComponentId();var d=c.eventKey;c.isPersistent&&this._pushMessageToPubSubQueue(b,c,d),W.TPA.fireEvent(d,c)},handleSmCurrentMember:function(a){var b=this.injects().SiteMembers;b.getMemberDetails(function(b){a.callback(b)},function(){a.callback(null)})},_handlePubSubSubscribe:function(a){var b=this.TPA_PUB_SUB_PREFIX,c=function(a){return{data:a.eventData,name:a.eventKey.replace(b,""),origin:a.origin}};if(this.createBoundHandler({eventKey:a.msgData.eventKey},function(a){a.appDefinitionId===this.getAppDefinitionId()&&this.handleAddEventListener(a.eventKey,c(a))}),a.msgData.receivePastEvents){var d=W.TPA.PubSubPublishers[this.getAppDefinitionId()],e=d&&d[a.msgData.eventKey];e&&a.callback({drain:!0,data:e.map(c)})}},handleRegisterEventListener:function(a){this.isPubSubMsg(a)&&this._handlePubSubSubscribe(a);var b=this._LOCAL_EVENTS[a.msgData.eventKey];if(b===this._LOCAL_EVENTS.SCROLL&&this.createBoundHandler({eventKey:b,fireIfAppIsOnCurrentPage:!0},function(){var a=_.extend({scrollTop:document.body.scrollTop,scrollLeft:document.body.scrollLeft,documentHeight:document.body.getHeight(),documentWidth:document.body.getWidth()},this.getViewNode().getOffsets(),this.getViewNode().getBoundingClientRect());this.handleAddEventListener(b,a)}),b===this._LOCAL_EVENTS.PAGE_NAVIGATION||b===this._LOCAL_EVENTS.PAGE_NAVIGATION_IN||b===this._LOCAL_EVENTS.PAGE_NAVIGATION_OUT){var c=this._LOCAL_EVENTS.PAGE_NAVIGATION;this.createBoundHandler({eventKey:c,subEventKey:b},function(a){var c=_.extend({isAppOnPage:this.isAppOnPage(a.toPage),wasAppOnPage:this.isAppOnPage(a.fromPage)},a),d=b===this._LOCAL_EVENTS.PAGE_NAVIGATION_IN&&c.isAppOnPage||b===this._LOCAL_EVENTS.PAGE_NAVIGATION_OUT&&c.wasAppOnPage||b===this._LOCAL_EVENTS.PAGE_NAVIGATION;d&&this.handleAddEventListener(b,c)})}b===this._LOCAL_EVENTS.STATE_CHANGED&&this.createBoundHandler({eventKey:b},function(a){this.handleAddEventListener(b,a)})},createBoundHandler:function(a,b,c){var d=this,e=a.eventKey,f=a.subEventKey||e;if(d.$appliedEvents=d.$appliedEvents||{},d.$appliedEvents[f])return d.$appliedEvents[f];var g=c||this.resources.W.TPA,h=function(){if(!a.fireIfAppIsOnCurrentPage||d.isAppOnPage(d.resources.W.Viewer.getCurrentPageId())){var c=d.isUnderMobileView()===d.resources.W.Config.env.isViewingSecondaryDevice();return c?b.apply(d,arguments):void 0}},i=function(){delete d.$appliedEvents[f],g.removeEvent(e,h)};return d.$appliedEvents[f]={dispose:i,handler:h},g.addEvent(e,h),this.addDisposeHandler(i),d.$appliedEvents[f]},sendPostMessage:function(a){var b=this.getIFrame();b=b||this._skinParts.iframe;var c="";try{c=JSON.stringify(a)}catch(d){return}b.contentWindow.postMessage(c,"*")},_getCurrentEditMode:function(){return this.resources.W.Config.env.isEditorInPreviewMode()?"preview":"editor"},_getPageParameters:function(a){var b={pageName:a._data._data.title,pageId:a._compId,pageUrl:""},c=this._getSiteBaseUrl();return b.pageUrl=""!==c?c+"#!"+b.pageName+"/"+b.pageId:"",b},_pushMessageToPubSubQueue:function(a,b,c){var d=W.TPA.PubSubPublishers,e=d[a]=d[a]||{},f=e[c]=e[c]||[];f.push(b),f.length>this.MESSAGE_QUEUE_LIMIT&&f.shift()}})});